# 镇妖动态功能说明

## 功能概述

镇妖界面显示全服动态和个人动态，记录玩家的占领和挑战行为，包括：
- 玩家占领某层聚魂阵
- 玩家挑战某层聚魂阵（成功/失败）

## 动态类型

### 1. 占领动态
当玩家占领一个无人占领的层时，生成占领动态。

**文本格式**：
```
【玩家昵称】成功占领第X层聚魂阵
```

**示例**：
- 【张三】成功占领第31层聚魂阵
- 【李四】成功占领第45层聚魂阵

### 2. 挑战成功动态
当玩家挑战已被占领的层并获胜时，生成挑战成功动态。

**文本格式**：
```
【挑战者】挑战【防守者】占领的第X层聚魂阵，挑战成功！
```

**示例**：
- 【李四】挑战【张三】占领的第31层聚魂阵，挑战成功！
- 【王五】挑战【赵六】占领的第50层聚魂阵，挑战成功！

### 3. 挑战失败动态
当玩家挑战已被占领的层但失败时，生成挑战失败动态。

**文本格式**：
```
【挑战者】挑战【防守者】占领的第X层聚魂阵，挑战失败
```

**示例**：
- 【赵六】挑战【孙七】占领的第40层聚魂阵，挑战失败
- 【周八】挑战【吴九】占领的第60层聚魂阵，挑战失败

## 实现逻辑

### 后端实现

#### 1. 占领动态记录
在 `occupy_floor()` 方法中，占领成功后记录动态：

```python
# 记录占领动态（作为特殊的战斗记录）
self.battle_repo.save_battle(
    floor=floor,
    attacker_id=user_id,
    attacker_name=player.nickname,
    defender_id=0,  # 占领无防守方
    defender_name="",
    is_success=True,
    remaining_seconds=0,
    battle_data={"type": "occupy", "message": "直接占领"}
)
```

#### 2. 挑战动态记录
在 `challenge_floor()` 方法中，挑战后自动记录动态（已存在）：

```python
battle_id = self.battle_repo.save_battle(
    floor=floor,
    attacker_id=user_id,
    attacker_name=attacker.nickname,
    defender_id=floor_info.occupant_id,
    defender_name=floor_info.occupant_name,
    is_success=battle_result["is_victory"],
    remaining_seconds=remaining_seconds,
    battle_data=battle_result,
)
```

#### 3. 动态文本格式化
在 `_format_dynamic_text()` 方法中，根据动态类型生成文本：

```python
def _format_dynamic_text(self, log: ZhenyaoBattleLog) -> str:
    """格式化动态文本"""
    # 判断是占领还是挑战
    is_occupy = log.defender_id == 0 or not log.defender_name
    
    if is_occupy:
        # 直接占领（无人占领的层）
        return f"【{log.attacker_name}】成功占领第{log.floor}层聚魂阵"
    else:
        # 挑战已占领的层
        if log.is_success:
            return f"【{log.attacker_name}】挑战【{log.defender_name}】占领的第{log.floor}层聚魂阵，挑战成功！"
        else:
            return f"【{log.attacker_name}】挑战【{log.defender_name}】占领的第{log.floor}层聚魂阵，挑战失败"
```

### 前端实现

#### 动态显示
前端使用后端返回的 `text` 字段直接显示：

```vue
<template v-if="dynamics.length > 0">
  <div v-for="d in dynamics" :key="d.id" class="section dynamic-item">
    <span class="gray small">{{ d.time }}</span>
    <span :class="d.success ? 'green' : ''">
      {{ d.text }}
    </span>
    <a class="link" @click="viewBattle(d)">查看</a>
  </div>
</template>
```

## 数据结构

### 动态数据返回格式
```json
{
  "ok": true,
  "dynamics": [
    {
      "id": 123,
      "time": "2026年01月20日 15:30",
      "remaining": "剩余25分30秒时",
      "attacker": "张三",
      "attacker_id": 1001,
      "defender": "",
      "defender_id": 0,
      "floor": 31,
      "success": true,
      "text": "【张三】成功占领第31层聚魂阵"
    },
    {
      "id": 124,
      "time": "2026年01月20日 15:35",
      "remaining": "剩余20分15秒时",
      "attacker": "李四",
      "attacker_id": 1002,
      "defender": "张三",
      "defender_id": 1001,
      "floor": 31,
      "success": true,
      "text": "【李四】挑战【张三】占领的第31层聚魂阵，挑战成功！"
    }
  ]
}
```

## 动态查询

### 全服动态
- **接口**: `GET /api/zhenyao/dynamics?type=all`
- **说明**: 返回最近的全服镇妖动态
- **数量**: 默认20条

### 个人动态
- **接口**: `GET /api/zhenyao/dynamics?type=personal`
- **说明**: 返回当前玩家的镇妖动态
- **数量**: 默认20条

## 使用场景

### 场景1：玩家占领空层
1. 玩家选择一个无人占领的层
2. 点击"占领"按钮
3. 占领成功
4. 系统记录占领动态
5. 动态列表显示：【玩家】成功占领第X层聚魂阵

### 场景2：玩家挑战成功
1. 玩家选择一个已被占领的层
2. 点击"挑战"按钮
3. 进行战斗，挑战者获胜
4. 系统记录挑战成功动态
5. 动态列表显示：【挑战者】挑战【防守者】占领的第X层聚魂阵，挑战成功！

### 场景3：玩家挑战失败
1. 玩家选择一个已被占领的层
2. 点击"挑战"按钮
3. 进行战斗，挑战者失败
4. 系统记录挑战失败动态
5. 动态列表显示：【挑战者】挑战【防守者】占领的第X层聚魂阵，挑战失败

## 前端显示效果

### 全服动态
```
【全服动态.个人动态】

2026年01月20日 15:30 【张三】成功占领第31层聚魂阵 查看
2026年01月20日 15:35 【李四】挑战【张三】占领的第31层聚魂阵，挑战成功！ 查看
2026年01月20日 15:40 【王五】挑战【李四】占领的第31层聚魂阵，挑战失败 查看
```

### 个人动态
```
【全服动态.个人动态】

2026年01月20日 15:30 【张三】成功占领第31层聚魂阵 查看
2026年01月20日 15:35 【张三】挑战【李四】占领的第35层聚魂阵，挑战成功！ 查看
```

## 测试验证

### 测试脚本
```bash
python test_zhenyao_dynamics.py
```

### 测试内容
1. 获取全服动态
   - 验证动态列表返回
   - 检查动态文本格式

2. 获取个人动态
   - 验证个人动态筛选
   - 检查动态内容

3. 动态文本格式测试
   - 占领动态格式
   - 挑战成功动态格式
   - 挑战失败动态格式

4. 占领并检查动态（可选）
   - 实际占领一层
   - 验证动态是否生成
   - 检查动态文本正确性

## 注意事项

1. **占领动态的特殊性**
   - defender_id = 0 表示占领（无防守方）
   - defender_name 为空字符串
   - is_success = True（占领总是成功）

2. **动态时间显示**
   - 格式：YYYY年MM月DD日 HH:MM
   - 按时间倒序排列（最新的在前）

3. **动态数量限制**
   - 默认返回20条
   - 可通过 limit 参数调整

4. **查看战报**
   - 点击"查看"可以查看详细战报
   - 占领动态的战报较简单（无战斗过程）
   - 挑战动态的战报包含完整战斗过程

5. **动态刷新**
   - 占领/挑战后自动刷新动态
   - 可手动刷新查看最新动态

## 相关文件

### 后端
- `application/services/zhenyao_service.py` - 镇妖服务（主要修改）
  - `occupy_floor()` - 添加占领动态记录
  - `_format_dynamic_text()` - 优化动态文本格式化

### 前端
- `interfaces/client/src/features/tower/ZhenYaoPage.vue` - 镇妖页面
  - 动态显示部分使用后端返回的 text 字段

### 测试
- `test_zhenyao_dynamics.py` - 动态功能测试脚本

### 数据库
- `zhenyao_battle_log` 表 - 存储镇妖战斗/占领记录
  - 占领记录：defender_id = 0
  - 挑战记录：defender_id > 0

## 总结

镇妖动态功能已完整实现：
1. ✓ 占领动态记录和显示
2. ✓ 挑战成功动态显示
3. ✓ 挑战失败动态显示
4. ✓ 全服动态和个人动态筛选
5. ✓ 动态文本格式优化
6. ✓ 前端使用后端返回的文本
7. ✓ 测试脚本验证功能

玩家可以在镇妖界面查看全服和个人的镇妖动态，了解谁占领了哪一层、谁挑战了哪一层以及挑战结果。
