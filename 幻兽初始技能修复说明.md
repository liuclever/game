# 幻兽初始技能修复说明

## 问题描述

神·罗刹等幻兽从召唤球中打开后没有初始技能，重生多次后仍然没有技能。

## 问题原因

幻兽模板配置文件 `configs/beast_templates.json` 中：
- 只配置了 `all_skill_names`（技能名称列表）
- 缺少 `all_skill_ids`（技能ID列表）

而幻兽初始化代码 `domain/services/beast_factory.py` 中的 `_choose_initial_skill_ids()` 函数从 `all_skill_ids` 中随机选择初始技能。如果 `all_skill_ids` 为空列表，则无法选择任何技能。

## 初始技能机制

根据 `domain/services/beast_factory.py` 中的实现：

```python
def _choose_initial_skill_ids(all_skill_ids: List[int]) -> List[int]:
    """
    规则：
    - 假设 all_skill_ids 有 N 个技能；
    - 初始化时可能的情况共有 N+1 种：
      0 个技能、1 个技能、...、N 个技能；
    - 本函数先在 [0, N] 中随机选择一个技能数量 k，
      然后从 all_skill_ids 中随机选出 k 个不重复的技能ID。
    """
    n = len(all_skill_ids)
    if n == 0:
        return []

    # 在 [0, n] 之间随机选择本次拥有的技能数量
    k = random.randint(0, n)
    if k == 0:
        return []

    # 从技能池中随机选择 k 个技能ID（不重复）
    return random.sample(all_skill_ids, k)
```

**初始技能数量**：
- 从幻兽图鉴的技能池中随机选择 **0 到 N 个**技能
- 每个数量的概率相同（均匀分布）
- 例如：神·罗刹有4个技能，则可能获得0、1、2、3或4个初始技能，每种概率为20%

## 受影响的幻兽

共 **62 个幻兽**受影响（除了小黑鼠和小黑鼠2号外的所有幻兽）：

### 神兽（7个）
- 神·罗刹 (ID: 58) - 4个技能
- 神·不死鸟 (ID: 59) - 4个技能
- 神·白虎 (ID: 60) - 4个技能
- 神·绝影 (ID: 61) - 4个技能
- 神·朱雀 (ID: 62) - 4个技能
- 神·玄武 (ID: 63) - 4个技能
- 神·青龙 (ID: 64) - 4个技能

### 普通幻兽（55个）
- 大黄蜂、獠牙猪、毒毛虫、追风狼等所有普通幻兽

## 修复方案

### 1. 自动修复脚本

运行 `fix_beast_skill_ids.py` 脚本：

```bash
python fix_beast_skill_ids.py
```

脚本功能：
- 读取 `configs/skills.json` 中的技能名称到ID的映射
- 遍历所有幻兽模板
- 根据 `all_skill_names` 自动生成对应的 `all_skill_ids`
- 备份原文件
- 保存修复后的配置

### 2. 修复结果

```
修复完成！
  ✓ 修复: 62 个
  - 跳过: 2 个（小黑鼠和小黑鼠2号已有配置）
```

### 3. 验证修复

运行 `check_beast_initial_skills.py` 脚本验证：

```bash
python check_beast_initial_skills.py
```

验证结果：
```
✓ 同时有 all_skill_ids 和 all_skill_names: 64 个
⚠ 只有 all_skill_names，缺少 all_skill_ids: 0 个
```

## 修复示例

### 神·罗刹修复前后对比

**修复前**：
```json
{
  "id": 58,
  "name": "神·罗刹",
  "all_skill_names": ["高级闪避", "高级虚弱", "高级撕咬", "高级幸运"]
  // 缺少 all_skill_ids
}
```

**修复后**：
```json
{
  "id": 58,
  "name": "神·罗刹",
  "all_skill_ids": [2001, 1007, 1009, 3008],
  "all_skill_names": ["高级闪避", "高级虚弱", "高级撕咬", "高级幸运"]
}
```

### 技能ID映射

| 技能名称 | 技能ID |
|---------|--------|
| 高级闪避 | 2001 |
| 高级虚弱 | 1007 |
| 高级撕咬 | 1009 |
| 高级幸运 | 3008 |

## 测试验证

### 测试步骤

1. 打开神·罗刹召唤球获得幻兽
2. 查看幻兽的初始技能
3. 重复多次，观察初始技能的随机性

### 预期结果

- 每次打开召唤球，幻兽的初始技能数量随机（0-4个）
- 初始技能从图鉴技能池中随机选择
- 不同次数获得的技能可能不同

### 概率分布

对于神·罗刹（4个技能）：
- 0个技能：20%
- 1个技能：20%
- 2个技能：20%
- 3个技能：20%
- 4个技能：20%

## 相关文件

### 配置文件
- `configs/beast_templates.json` - 幻兽模板配置
- `configs/skills.json` - 技能配置

### 代码文件
- `domain/services/beast_factory.py` - 幻兽初始化逻辑
- `infrastructure/config/beast_template_repo_from_config.py` - 模板加载逻辑

### 工具脚本
- `check_beast_initial_skills.py` - 检查幻兽技能配置
- `fix_beast_skill_ids.py` - 自动修复技能ID配置

## 注意事项

1. **备份文件**：修复脚本会自动备份原配置文件
2. **重生机制**：重生幻兽会重新随机生成初始技能
3. **技能数量**：初始技能数量完全随机，可能为0
4. **技能学习**：可以通过技能书学习新技能

## 后续建议

1. **配置验证**：在配置文件中同时维护 `all_skill_ids` 和 `all_skill_names`
2. **代码优化**：考虑在模板加载时自动从 `all_skill_names` 生成 `all_skill_ids`
3. **测试覆盖**：添加单元测试验证幻兽初始化逻辑

## 修复时间

2026年1月20日

## 修复人员

AI助手 Kiro
