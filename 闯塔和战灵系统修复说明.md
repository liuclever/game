# 闯塔和战灵系统修复说明

## 修改日期
2026年1月18日

## 问题描述

1. **鼓舞丹功能未完全删除**：闯塔界面的鼓舞丹相关代码还存在
2. **战灵塔等级限制缺失**：战灵塔应该在玩家35级时才能解锁进行闯塔
3. **灵力水晶使用路由缺失**：灵力水晶在背包中点击使用时，应该跳转到战灵界面

## 修改内容

### 1. 删除鼓舞丹功能

#### interfaces/routes/tower_routes.py

**删除内容**：
- 删除了 `INSPIRE_DURATION_SECONDS` 常量
- 删除了 `INSPIRE_PILL_ITEM_ID` 常量
- 删除了 `/tower/inspire/status` 接口（获取鼓舞状态）
- 删除了 `/tower/inspire/use` 接口（使用鼓舞丹）

**删除代码行数**：约120行

**说明**：鼓舞丹功能已完全移除，不再支持使用鼓舞丹提升战力。

### 2. 添加战灵塔35级解锁限制

#### application/services/tower_service.py

**修改函数**：
1. `get_tower_info()`
2. `challenge_floor()`
3. `auto_challenge()`

**添加的检查逻辑**：
```python
# 战灵塔需要35级才能解锁
if tower_type == "zhanling":
    player = self.player_repo.get_by_id(user_id)
    player_level = int(getattr(player, "level", 0) or 0) if player else 0
    if player_level < 35:
        raise TowerError("战灵塔需要35级才能解锁")
```

**影响范围**：
- 获取战灵塔信息时检查等级
- 手动挑战战灵塔时检查等级
- 自动闯战灵塔时检查等级

**错误提示**：当玩家等级不足35级时，会抛出 `TowerError("战灵塔需要35级才能解锁")`

### 3. 配置灵力水晶使用路由

#### interfaces/client/src/utils/itemUseRoutes.js

**添加配置**：

**ITEM_USE_ROUTES 映射**：
```javascript
// 灵力水晶：跳转战灵页用于兑换灵力
6101: '/spirit/warehouse',
```

**ITEM_USE_HINTS 提示**：
```javascript
6101: '灵力水晶：请前往【战灵】界面兑换灵力。',
```

**说明**：
- 当玩家在背包中点击灵力水晶的"使用"按钮时，会自动跳转到战灵界面
- 在战灵界面，玩家可以使用 `/api/spirit/consume-crystal` 接口兑换灵力
- 兑换规则：1个灵力水晶 = 10灵力

## 修改效果

### 修改前

1. **鼓舞丹**：
   - 闯塔界面有鼓舞丹相关接口
   - 可以查询鼓舞状态和使用鼓舞丹

2. **战灵塔**：
   - 任何等级都可以进入战灵塔
   - 没有等级限制

3. **灵力水晶**：
   - 在背包中点击使用时，没有特殊处理
   - 可能会尝试直接使用（但后端没有处理逻辑）

### 修改后

1. **鼓舞丹**：
   - 完全删除鼓舞丹相关功能
   - 接口不再存在

2. **战灵塔**：
   - 35级以下玩家无法进入战灵塔
   - 尝试进入时会提示"战灵塔需要35级才能解锁"

3. **灵力水晶**：
   - 在背包中点击使用时，自动跳转到战灵界面
   - 在战灵界面可以兑换灵力（1个水晶 = 10灵力）

## 技术细节

### 战灵塔等级限制

**检查位置**：
- `get_tower_info()` - 获取塔信息时检查
- `challenge_floor()` - 手动挑战时检查
- `auto_challenge()` - 自动闯塔时检查

**检查逻辑**：
1. 判断 `tower_type == "zhanling"`
2. 获取玩家信息
3. 检查玩家等级是否 >= 35
4. 如果不满足，抛出 `TowerError`

**与战灵系统的一致性**：
- 战灵系统的其他功能（开启灵石、洗练、出售等）也都要求35级
- 战灵塔的等级限制与战灵系统保持一致

### 灵力水晶使用流程

**前端流程**：
1. 玩家在背包中点击灵力水晶的"使用"按钮
2. 前端检查 `itemUseRoutes.js` 中的配置
3. 发现灵力水晶（6101）配置了路由 `/spirit/warehouse`
4. 自动跳转到战灵界面

**后端接口**：
- 接口：`POST /api/spirit/consume-crystal`
- 参数：`{ "quantity": 1 }` （可选，默认1个）
- 功能：消耗灵力水晶，增加灵力
- 规则：1个灵力水晶 = 10灵力

**数据库操作**：
1. 从 `player_inventory` 表中扣除灵力水晶（item_id=6101）
2. 在 `spirit_account` 表中增加灵力（spirit_power字段）

## 相关文件

### 修改的文件
1. `interfaces/routes/tower_routes.py` - 删除鼓舞丹接口
2. `application/services/tower_service.py` - 添加战灵塔35级限制
3. `interfaces/client/src/utils/itemUseRoutes.js` - 配置灵力水晶使用路由

### 相关文件（未修改）
1. `application/services/spirit_service.py` - 战灵服务（已有灵力水晶兑换功能）
2. `interfaces/routes/spirit_routes.py` - 战灵路由（已有consume-crystal接口）
3. `interfaces/web_api/app_old.py` - 旧版API（也有鼓舞丹代码，但已废弃）

## 测试建议

### 测试场景1：鼓舞丹功能删除
1. 尝试访问 `/api/tower/inspire/status` 接口
2. 预期：接口不存在，返回404错误
3. 尝试访问 `/api/tower/inspire/use` 接口
4. 预期：接口不存在，返回404错误

### 测试场景2：战灵塔等级限制
1. 使用35级以下的账号登录
2. 尝试进入战灵塔界面
3. 预期：提示"战灵塔需要35级才能解锁"
4. 使用35级或以上的账号登录
5. 尝试进入战灵塔界面
6. 预期：正常进入，可以闯塔

### 测试场景3：灵力水晶使用
1. 在背包中找到灵力水晶
2. 点击"使用"按钮
3. 预期：自动跳转到战灵界面
4. 在战灵界面使用灵力水晶
5. 预期：消耗1个灵力水晶，获得10灵力

### 测试场景4：边界情况
1. 35级玩家刚好达到等级要求
2. 34级玩家升级到35级后立即尝试进入战灵塔
3. 灵力水晶数量为0时的处理
4. 灵力水晶数量很大时的批量兑换

## 注意事项

### 1. 鼓舞丹物品处理
- 物品ID：8001
- 如果玩家背包中还有鼓舞丹，不会自动删除
- 鼓舞丹变成无法使用的物品
- 建议：可以考虑添加回收功能或兑换功能

### 2. 战灵塔等级限制
- 只限制战灵塔（tower_type="zhanling"）
- 通天塔（tower_type="tongtian"）不受影响
- 其他塔类型也不受影响

### 3. 灵力水晶兑换
- 需要35级才能使用（战灵系统的通用限制）
- 兑换比例：1个水晶 = 10灵力
- 可以批量兑换（最多10个）

### 4. 数据库字段
- `player` 表的 `inspire_expire_time` 字段已不再使用
- 可以考虑在未来的数据库迁移中删除该字段

## 后续优化建议

### 1. 鼓舞丹回收
- 添加鼓舞丹回收功能
- 可以兑换成其他道具或铜钱
- 避免玩家背包中有无用的道具

### 2. 等级限制提示优化
- 在前端界面上显示战灵塔的等级要求
- 当玩家等级不足时，显示"35级解锁"的提示
- 避免玩家点击后才发现无法进入

### 3. 灵力水晶使用优化
- 在战灵界面添加"使用灵力水晶"的快捷按钮
- 显示当前拥有的灵力水晶数量
- 添加批量兑换的数量选择器

### 4. 统一等级限制
- 将战灵系统的35级限制统一管理
- 在配置文件中定义等级要求
- 便于后续调整等级限制

---

**修改完成时间**：2026年1月18日  
**修改人员**：Kiro AI Assistant  
**版本**：v1.0
