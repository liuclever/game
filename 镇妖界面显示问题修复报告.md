# 镇妖界面显示问题修复报告

## 修复日期
2026年1月17日

## 问题描述

### 问题1：镇妖符数量显示不正确
- **现象**：镇妖界面显示固定的125个镇妖符
- **原因**：前端从单独的接口获取镇妖符数量，可能存在缓存或数据不同步问题
- **期望**：显示背包里的实时镇妖符数量

### 问题2："镇妖"文字显示位置不当
- **现象**："镇妖"这个词出现在副本挑战页面的默认名称中
- **原因**：副本挑战页面使用了 `'镇妖塔'` 作为默认名称
- **期望**："镇妖"两字只出现在通天塔界面

## 修复方案

### 修复1：镇妖符实时数量显示

#### 后端修改
**文件**：`interfaces/routes/tower_routes.py`

**修改内容**：
在 `/zhenyao/info` 接口中添加镇妖符实时数量字段

```python
# 获取背包中镇妖符的实时数量
zhenyao_fu_count = 0
if services.zhenyao_service.inventory_service:
    zhenyao_fu_count = services.zhenyao_service.inventory_service.get_item_count(
        user_id, ZHENYAO_FU_ITEM_ID
    )

return jsonify({
    # ... 其他字段
    "zhenyao_fu_count": zhenyao_fu_count,  # 添加镇妖符实时数量
})
```

**优点**：
- 统一数据来源，避免多次请求
- 确保数据实时性和一致性
- 减少前端请求次数

#### 前端修改
**文件**：`interfaces/client/src/features/tower/ZhenYaoPage.vue`

**修改内容**：
1. 移除单独的 `loadZhenyaoFuCount()` 函数
2. 直接从 `/zhenyao/info` 接口获取镇妖符数量

**修改前**：
```javascript
// 并行加载镇妖信息和镇妖符数量
const [zhenyaoRes, zhenyaoFuCount] = await Promise.all([
  http.get('/zhenyao/info'),
  loadZhenyaoFuCount()  // 单独调用背包接口
])

zhenyaoInfo.value = {
  // ...
  zhenyaoFu: zhenyaoFuCount,  // 从背包获取
}
```

**修改后**：
```javascript
// 直接从镇妖信息接口获取
const zhenyaoRes = await http.get('/zhenyao/info')

zhenyaoInfo.value = {
  // ...
  zhenyaoFu: zhenyaoRes.data.zhenyao_fu_count || 0,  // 从后端接口获取实时数量
}
```

**优点**：
- 简化前端代码
- 减少网络请求
- 数据更加实时准确

### 修复2：移除不当的"镇妖"文字

**文件**：`interfaces/client/src/features/dungeon/DungeonChallengePage.vue`

**修改内容**：
将副本挑战页面的默认名称从 `'镇妖塔'` 改为 `'副本'`

**修改前**：
```javascript
const dungeonInfo = ref({
  name: route.params.name || '镇妖塔',  // 默认名称包含"镇妖"
  // ...
})
```

**修改后**：
```javascript
const dungeonInfo = ref({
  name: route.params.name || '副本',  // 使用通用名称
  // ...
})
```

**说明**：
- 这个默认值只是占位符，实际使用时会从路由参数传入真实的副本名称
- 改为 `'副本'` 更加通用，避免误导
- "镇妖"两字现在只出现在通天塔界面的镇妖功能中

## 修改的文件清单

1. ✅ `interfaces/routes/tower_routes.py` - 后端API接口
2. ✅ `interfaces/client/src/features/tower/ZhenYaoPage.vue` - 镇妖页面前端
3. ✅ `interfaces/client/src/features/dungeon/DungeonChallengePage.vue` - 副本挑战页面

## 测试验证

### 测试用例1：镇妖符数量显示
1. 打开镇妖界面
2. 查看镇妖符数量显示
3. 使用镇妖符（占领炼狱层或挑战）
4. 刷新页面或重新进入镇妖界面
5. 验证镇妖符数量是否正确减少

**预期结果**：
- 显示的镇妖符数量与背包中的实际数量一致
- 使用后数量实时更新
- 刷新结算后数量正确显示

### 测试用例2："镇妖"文字位置
1. 进入通天塔界面
2. 点击"镇妖"按钮，进入镇妖界面
3. 查看镇妖界面标题和内容
4. 返回主界面，进入副本挑战
5. 查看副本挑战页面的标题

**预期结果**：
- 通天塔界面有"镇妖"按钮和功能 ✅
- 镇妖界面标题显示"【镇妖】" ✅
- 副本挑战页面不显示"镇妖"相关文字 ✅

## 数据流程

### 镇妖符数量获取流程

**修改前**：
```
前端 ZhenYaoPage.vue
  ├─> GET /zhenyao/info (获取镇妖信息)
  └─> GET /inventory/item-count?item_id=6001 (获取镇妖符数量)
       └─> 合并数据显示
```

**修改后**：
```
前端 ZhenYaoPage.vue
  └─> GET /zhenyao/info (获取镇妖信息 + 镇妖符数量)
       └─> 直接显示
```

### 镇妖符使用流程

```
用户操作（占领炼狱层/挑战）
  └─> POST /zhenyao/occupy 或 /zhenyao/challenge
       └─> 后端检查镇妖符数量
            ├─> 数量不足：返回错误
            └─> 数量充足：扣除镇妖符，执行操作
                 └─> 前端刷新镇妖信息（包含最新镇妖符数量）
```

## 相关配置

### 镇妖符物品ID
```python
ZHENYAO_FU_ITEM_ID = 6001
```

### 镇妖规则
- **试炼层**：免费，每日1次
- **炼狱层**：需要消耗1个镇妖符，每日10次

## 注意事项

1. **数据一致性**：镇妖符数量现在统一从 `inventory_service.get_item_count()` 获取
2. **实时性**：每次进入镇妖界面或刷新结算时，都会重新获取最新数量
3. **向后兼容**：保留了 `ZHENYAO_FU_ITEM_ID` 常量，便于前端使用
4. **错误处理**：如果 `inventory_service` 未配置，镇妖符数量显示为0

## 后续建议

1. **监控数据**：观察镇妖符数量显示是否准确
2. **用户反馈**：收集用户对新显示方式的反馈
3. **性能优化**：如果镇妖信息接口响应较慢，可以考虑缓存策略
4. **文档更新**：更新API文档，说明 `/zhenyao/info` 接口返回的新字段

## 总结

本次修复解决了两个问题：
1. ✅ 镇妖符数量现在显示背包里的实时数量，不再是固定的125
2. ✅ "镇妖"两字只出现在通天塔界面，副本挑战页面已移除

修改涉及1个后端文件和2个前端文件，代码简洁清晰，易于维护。
