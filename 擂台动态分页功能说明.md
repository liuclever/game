# 擂台动态分页功能说明

## 需求
擂台动态只会展示近5页，每页10行（共50条记录）

## 实现方案

### 后端修改

#### 1. 数据库仓库层（`infrastructure/db/arena_battle_repo_mysql.py`）

**修改方法**：
- `get_recent_battles()` - 添加 `offset` 参数
- `get_user_battles()` - 添加 `offset` 参数

**SQL查询**：
```python
def get_recent_battles(self, arena_type: Optional[str] = None, limit: int = 20, offset: int = 0):
    sql = """
        SELECT ... FROM arena_battle_log
        ORDER BY created_at DESC
        LIMIT %s OFFSET %s
    """
```

#### 2. 路由层（`interfaces/routes/arena_routes.py`）

**接口**：`GET /api/arena/dynamics`

**新增参数**：
- `page` - 当前页码（默认1）
- 固定配置：
  - `page_size = 10` - 每页10条
  - `max_pages = 5` - 最多5页
  - `max_records = 50` - 最多50条记录

**分页逻辑**：
```python
page = int(request.args.get("page", 1))
page_size = 10
max_pages = 5
max_records = 50

# 先查询最多50条记录
total_logs = ARENA_BATTLE_REPO.get_recent_battles(limit=max_records, offset=0)
total_count = len(total_logs)

# 计算实际总页数（有几页显示几页，最多5页）
if total_count == 0:
    total_pages = 0
else:
    total_pages = min((total_count + page_size - 1) // page_size, max_pages)

# 如果请求的页码超过实际页数，返回空
if page > total_pages:
    return jsonify({"ok": True, "dynamics": [], "totalPages": total_pages})

# 从内存中切片获取当前页数据
start_idx = (page - 1) * page_size
end_idx = start_idx + page_size
logs = total_logs[start_idx:end_idx]

has_more = page < total_pages
```

**返回数据**：
```json
{
  "ok": true,
  "dynamics": [...],
  "page": 1,
  "pageSize": 10,
  "totalPages": 3,      // 实际页数（如果只有25条记录，则为3页）
  "totalCount": 25,     // 总记录数
  "hasMore": true
}
```

### 前端修改（`interfaces/client/src/features/arena/ArenaPage.vue`）

#### 1. 新增状态
```javascript
const currentPage = ref(1)
const totalPages = ref(5)
const hasMore = ref(false)
```

#### 2. 修改加载函数
```javascript
const loadDynamics = async (page = 1) => {
  const res = await http.get(`/arena/dynamics?type=${dynamicType.value}&page=${page}`)
  if (res.data.ok) {
    arenaDynamics.value = res.data.dynamics
    currentPage.value = res.data.page || 1
    totalPages.value = res.data.totalPages || 5
    hasMore.value = res.data.hasMore || false
  }
}
```

#### 3. 新增分页控制函数
```javascript
// 上一页
const prevPage = () => {
  if (currentPage.value > 1) {
    loadDynamics(currentPage.value - 1)
  }
}

// 下一页
const nextPage = () => {
  if (hasMore.value) {
    loadDynamics(currentPage.value + 1)
  }
}

// 跳转到指定页
const goToPage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    loadDynamics(page)
  }
}
```

#### 4. 分页UI
```vue
<div class="section pagination">
  <a class="link" :class="{ disabled: currentPage === 1 }" @click="prevPage">上一页</a>
  <span class="gray"> 第{{ currentPage }}/{{ totalPages }}页 </span>
  <a class="link" :class="{ disabled: !hasMore }" @click="nextPage">下一页</a>
  <span class="gray"> | 跳转到: </span>
  <a 
    v-for="p in totalPages" 
    :key="p"
    class="link page-num"
    :class="{ active: p === currentPage }"
    @click="goToPage(p)"
  >{{ p }}</a>
</div>
```

## 功能特性

### 1. 动态页数计算
- 根据实际数据量计算总页数
- 如果只有15条记录，显示2页
- 如果有25条记录，显示3页
- 最多显示5页（50条记录）
- 避免显示空页面

### 2. 分页控制
- **上一页/下一页**：快速翻页
- **页码跳转**：点击页码直接跳转（只显示实际存在的页码）
- **当前页高亮**：橙色背景显示当前页
- **禁用状态**：第1页禁用"上一页"，最后一页禁用"下一页"

### 3. 动态类型切换
- 切换"擂台动态"/"个人动态"时，自动重置到第1页
- 保持分页状态独立
- 重新计算总页数

### 4. 空数据处理
- 无动态时显示"暂无动态"，不显示分页控制
- 只有1页时不显示页码跳转
- 有多页时显示完整分页控制

## 显示效果

### 分页控制栏

**有多页时**：
```
上一页 第1/3页 下一页 | 跳转到: [1] [2] [3]
```

**只有1页时**：
```
上一页 第1/1页 下一页
```
（不显示页码跳转）

**无数据时**：
不显示分页控制

- 当前页：橙色背景
- 可点击页：蓝色链接
- 禁用按钮：灰色不可点击

### 数据示例

**场景1：只有15条记录**
- 总页数：2页
- 第1页：显示1-10条
- 第2页：显示11-15条
- 页码跳转：[1] [2]

**场景2：有25条记录**
- 总页数：3页
- 第1页：显示1-10条
- 第2页：显示11-20条
- 第3页：显示21-25条
- 页码跳转：[1] [2] [3]

**场景3：有50条以上记录**
- 总页数：5页（最多）
- 第1-4页：各显示10条
- 第5页：显示41-50条
- 页码跳转：[1] [2] [3] [4] [5]

## 测试场景

1. **首次加载（无数据）**：不显示分页控制
2. **只有5条记录**：显示第1/1页，不显示页码跳转
3. **有15条记录**：显示2页，页码跳转 [1] [2]
4. **有25条记录**：显示3页，页码跳转 [1] [2] [3]
5. **有50条以上记录**：显示5页（最多），页码跳转 [1] [2] [3] [4] [5]
6. **点击第2页（数据不足）**：如果实际只有1页，点击第2页返回空数据
7. **切换动态类型**：重置到第1页，重新计算总页数

## 技术细节

### 为什么先查询50条再切片？
```python
# 先查询最多50条记录
total_logs = ARENA_BATTLE_REPO.get_recent_battles(limit=50, offset=0)
total_count = len(total_logs)

# 计算实际总页数
total_pages = min((total_count + 9) // 10, 5)

# 从内存中切片获取当前页
start_idx = (page - 1) * 10
end_idx = start_idx + 10
logs = total_logs[start_idx:end_idx]
```

**优点**：
1. 可以准确计算总页数，避免显示空页
2. 只需一次数据库查询，性能更好
3. 数据量小（最多50条），内存切片开销可忽略

**缺点**：
- 每次请求都查询50条（但这是可接受的，因为擂台动态本身就是热点数据）

### 为什么限制5页？
- 避免用户翻页过多影响性能
- 擂台动态主要关注最新的战斗
- 50条记录足够展示近期活跃情况
- 动态计算页数，有几页显示几页，最多5页

## 总结

实现了完整的擂台动态分页功能：
- 每页10条记录
- 根据实际数据量动态计算总页数（最多5页）
- 避免显示空页面
- 提供友好的分页控制UI
- 提升了用户体验
