# 测试地图副本Boss进化石掉落

## 自动化测试

运行测试脚本验证配置：

```bash
python test_dungeon_boss_evolution_stone.py
```

该脚本会验证所有地图的进化石映射关系是否正确。

## 手动测试步骤

### 准备工作

1. 准备测试账号（建议不同等级段各一个）
2. 确保账号有足够的骰子和活力
3. 准备双倍卡（可选，用于测试双倍效果）

### 测试场景1：定老城（黄阶进化石）

**步骤：**

1. 登录20-29级的测试账号
2. 前往定老城地图
3. 进入"幻灵湖畔"副本
4. 使用骰子前进到第35层
5. 击败Boss
6. 开启战利品（消耗15点活力）
7. 查看奖励

**预期结果：**

- 必得：铜钱 × 600、随机结晶 × 1
- 可能获得（30%概率）：猎魔骨魂 × 1、黄阶进化石 × 1

**验证方法：**

多次测试（建议10次以上），统计进化石掉落次数，应该接近30%。

### 测试场景2：迷雾城（玄阶进化石）

**步骤：**

1. 登录30-39级的测试账号
2. 前往迷雾城地图
3. 进入"死亡沼泽"副本
4. 使用骰子前进到第35层
5. 击败Boss
6. 开启战利品

**预期结果：**

- 必得：铜钱 × 600、随机结晶 × 1
- 可能获得（30%概率）：龙炎骨魂 × 1、玄阶进化石 × 1

### 测试场景3：飞龙港（地阶进化石）

**步骤：**

1. 登录40-49级的测试账号
2. 前往飞龙港地图
3. 进入"聚灵孤岛"副本
4. 使用骰子前进到第35层
5. 击败Boss
6. 开启战利品

**预期结果：**

- 必得：铜钱 × 600、随机结晶 × 1
- 可能获得（30%概率）：奔雷骨魂 × 1、地阶进化石 × 1

### 测试场景4：落龙镇（天阶进化石）

**步骤：**

1. 登录50-59级的测试账号
2. 前往落龙镇地图
3. 进入"巨龙冰原"副本
4. 使用骰子前进到第35层
5. 击败Boss
6. 开启战利品

**预期结果：**

- 必得：铜钱 × 600、随机结晶 × 1
- 可能获得（30%概率）：凌霄骨魂 × 1、天阶进化石 × 1

### 测试场景5：圣龙城（飞马进化石）

**步骤：**

1. 登录60-69级的测试账号
2. 前往圣龙城地图
3. 进入"皇城迷宫"副本
4. 使用骰子前进到第35层
5. 击败Boss
6. 开启战利品

**预期结果：**

- 必得：铜钱 × 600、随机结晶 × 1
- 可能获得（30%概率）：武神骨魂 × 1、飞马进化石 × 1

### 测试场景6：乌托邦（天龙进化石）

**步骤：**

1. 登录70级以上的测试账号
2. 前往乌托邦地图
3. 进入"幻光公园"副本
4. 使用骰子前进到第35层
5. 击败Boss
6. 开启战利品

**预期结果：**

- 必得：铜钱 × 600、随机结晶 × 1
- 可能获得（30%概率）：毁灭骨魂 × 1、天龙进化石 × 1

### 测试场景7：双倍卡效果

**步骤：**

1. 选择任意地图副本
2. 前进到第35层并击败Boss
3. 使用双倍卡开启战利品（而不是消耗活力）
4. 查看奖励

**预期结果：**

- 必得：铜钱 × 1200、随机结晶 × 2
- 如果触发掉落：骨魂 × 2、进化石 × 2

## 快速测试方法

### 使用数据库直接设置进度

如果想快速测试，可以直接修改数据库：

```sql
-- 将玩家设置到35层，已击败Boss，未领取战利品
UPDATE player_dungeon_progress 
SET current_floor = 35, 
    floor_cleared = TRUE, 
    floor_event_type = 'boss',
    loot_claimed = FALSE
WHERE user_id = 玩家ID AND dungeon_name = '副本名称';

-- 给玩家添加足够的活力
UPDATE player SET energy = 100 WHERE user_id = 玩家ID;

-- 给玩家添加双倍卡（可选）
INSERT INTO player_inventory (user_id, item_id, quantity) 
VALUES (玩家ID, 6024, 10)
ON DUPLICATE KEY UPDATE quantity = quantity + 10;
```

### 批量测试脚本

可以创建一个脚本，自动重置副本并开启战利品多次，统计掉落概率：

```python
# 伪代码示例
for i in range(100):
    # 重置副本到35层
    # 开启战利品
    # 记录是否掉落进化石
    # 统计掉落次数
```

## 验证要点

- ✓ 每个地图掉落对应的进化石类型正确
- ✓ 掉落概率接近30%（大样本测试）
- ✓ 双倍卡效果正确（数量翻倍）
- ✓ 骨魂和进化石可以同时掉落
- ✓ 普通层（1-34层）不掉落进化石
- ✓ 进化石正确添加到背包

## 常见问题

### Q: 为什么没有掉落进化石？

A: 进化石掉落概率是30%，不是100%。多次测试可能会连续不掉落，这是正常的随机现象。

### Q: 可以同时获得骨魂和进化石吗？

A: 可以。骨魂和进化石的掉落是独立计算的，都是30%概率，理论上有9%的概率同时获得。

### Q: 普通层（非Boss层）会掉落进化石吗？

A: 不会。只有35层（Boss层）才会掉落进化石。

### Q: 使用双倍卡后，掉落概率会提高吗？

A: 不会。双倍卡只影响掉落数量（1 → 2），不影响掉落概率（仍然是30%）。

### Q: 不同副本的进化石掉落有区别吗？

A: 同一地图的所有副本掉落相同的进化石。例如，定老城的"石工矿场"和"幻灵湖畔"都掉落黄阶进化石。

## 测试完成标准

- [ ] 所有6个地图的进化石掉落类型正确
- [ ] 掉落概率接近30%（大样本测试）
- [ ] 双倍卡效果正确
- [ ] 骨魂和进化石可以同时掉落
- [ ] 进化石正确添加到背包
- [ ] 前端正确显示进化石奖励

## 数据统计表格

可以使用以下表格记录测试结果：

| 地图 | 副本 | 测试次数 | 掉落次数 | 掉落概率 | 进化石类型 |
|------|------|---------|---------|---------|-----------|
| 定老城 | 幻灵湖畔 | 10 | 3 | 30% | 黄阶进化石 |
| 迷雾城 | 死亡沼泽 | 10 | 2 | 20% | 玄阶进化石 |
| 飞龙港 | 聚灵孤岛 | 10 | 4 | 40% | 地阶进化石 |
| 落龙镇 | 巨龙冰原 | 10 | 3 | 30% | 天阶进化石 |
| 圣龙城 | 皇城迷宫 | 10 | 3 | 30% | 飞马进化石 |
| 乌托邦 | 幻光公园 | 10 | 2 | 20% | 天龙进化石 |

**注意：** 10次测试的样本量较小，掉落概率可能会有较大波动。建议至少测试30次以上才能得到较准确的概率统计。
