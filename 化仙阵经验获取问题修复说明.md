# 化仙阵经验获取问题修复说明

## 问题描述

用户反馈：化仙池的化仙阵开启后，没有幻兽经验获得。

## 问题原因

化仙阵的经验是通过**后台定时任务**每小时自动结算的，不是开启时立即获得。

定时任务代码在 `infrastructure/scheduler.py` 中的 `_run_immortalize_formation` 函数，该函数每小时执行一次，为所有正在运行的化仙阵结算经验。

**问题根源**：定时任务在创建 `ImmortalizePoolService` 时，缺少了 `config` 参数，导致使用默认配置，可能无法正确读取每小时的经验值。

### 原代码

```python
service = ImmortalizePoolService(
    pool_repo=pool_repo,
    player_repo=player_repo,
)
```

缺少 `config` 参数，导致使用默认的 `ImmortalizeConfig()`，但配置文件可能没有正确加载。

## 修复方案

在定时任务中添加 `config` 参数，确保正确加载化仙阵配置。

### 修改文件

**文件**：`infrastructure/scheduler.py`

### 修改内容

1. **添加导入**：
```python
from infrastructure.config.immortalize_config import ImmortalizeConfig
```

2. **修改定时任务函数**：
```python
def _run_immortalize_formation():
    """每小时结算化仙阵收益"""
    logger.debug("[Scheduler] 执行化仙阵经验结算任务")
    rows = execute_query(
        """
        SELECT user_id
        FROM player_immortalize_pool
        WHERE formation_started_at IS NOT NULL
          AND formation_ends_at > NOW()
        """
    )
    if not rows:
        return

    pool_repo = MySQLImmortalizePoolRepo()
    player_repo = MySQLPlayerRepo()
    config = ImmortalizeConfig()  # 添加这一行
    service = ImmortalizePoolService(
        pool_repo=pool_repo,
        player_repo=player_repo,
        config=config,  # 添加这个参数
    )
    
    # ... 其余代码不变
```

## 化仙阵工作原理

### 1. 开启化仙阵

玩家点击"开启"按钮后：
- 消耗7种结晶各1个
- 设置开始时间和结束时间（持续4小时）
- 记录到数据库 `player_immortalize_pool` 表

### 2. 后台定时结算

后台定时任务每小时执行一次（整点执行）：
- 查询所有正在运行的化仙阵
- 计算每个化仙阵应该获得的经验
- 将经验添加到化仙池的 `current_exp` 字段
- 如果化仙池已满或化仙阵结束，停止结算

### 3. 经验计算

每小时获得的经验 = 配置文件中的 `formation.hourly_exp[化仙阵等级]`

例如：
- 1级化仙阵：每小时 100 经验
- 2级化仙阵：每小时 200 经验
- ...

### 4. 容量限制

化仙池有容量上限，如果经验池已满，新的经验无法添加，化仙阵会自动停止。

## 测试步骤

### 1. 重启后端服务

修改代码后，必须重启后端服务：

```bash
restart_flask.bat
```

### 2. 开启化仙阵

1. 进入"化仙池"页面
2. 确保有足够的7种结晶（各1个）
3. 点击"开启化仙阵"
4. 确认开启成功

### 3. 等待结算

化仙阵的经验是**每小时整点结算**的，例如：
- 如果在 8:30 开启，第一次结算在 9:00
- 如果在 9:05 开启，第一次结算在 10:00

**注意**：不是开启后立即获得经验，需要等到下一个整点！

### 4. 检查经验

等待到下一个整点后：
1. 刷新化仙池页面
2. 查看"经验池"的数值是否增加
3. 应该增加了对应等级的每小时经验值

### 5. 查看日志

如果经验仍然没有增加，检查后端日志：

```bash
# 查看日志文件
tail -f logs/app.log

# 或者在控制台查看
```

应该能看到类似的日志：
```
[Scheduler] 执行化仙阵经验结算任务
[Scheduler] 化仙阵结算: user=8, hours=1, exp=100, finished=False
```

## 配置文件

化仙阵的配置在 `configs/immortalize.json` 文件中：

```json
{
  "formation": {
    "duration_hours": 4,
    "hourly_exp": {
      "1": 100,
      "2": 200,
      "3": 300,
      ...
    }
  }
}
```

- `duration_hours`：化仙阵持续时间（小时）
- `hourly_exp`：每个等级的化仙阵每小时获得的经验

## 常见问题

### Q1: 为什么开启后没有立即获得经验？

**A**: 化仙阵的经验是每小时整点结算的，不是立即获得。需要等到下一个整点（例如 9:00, 10:00）才会结算。

### Q2: 如何确认定时任务是否正常运行？

**A**: 查看后端日志，应该能看到每小时的结算日志。如果没有日志，说明定时任务可能没有启动。

### Q3: 经验池满了怎么办？

**A**: 如果经验池已满，新的经验无法添加，化仙阵会自动停止。需要先使用经验（给幻兽升级或使用化仙丹），然后重新开启化仙阵。

### Q4: 化仙阵结束后经验会消失吗？

**A**: 不会。化仙阵结束后，已经结算的经验会保留在经验池中，可以随时使用。

## 相关文件

- `infrastructure/scheduler.py` - 定时任务（已修复）
- `application/services/immortalize_pool_service.py` - 化仙池服务
- `infrastructure/config/immortalize_config.py` - 化仙池配置
- `configs/immortalize.json` - 化仙池配置文件
- `interfaces/routes/immortalize_routes.py` - 化仙池路由

## 注意事项

1. **定时任务依赖后端服务**：如果后端服务停止，定时任务也会停止，化仙阵不会结算经验
2. **时区问题**：定时任务使用 UTC 时间，可能与本地时间有时差
3. **容量限制**：经验池有容量上限，满了之后无法继续获得经验
4. **重启服务**：修改代码后必须重启后端服务才能生效

## 总结

化仙阵经验获取问题的根源是定时任务缺少配置参数。修复后，定时任务会正确加载配置，每小时为正在运行的化仙阵结算经验。

记得重启后端服务，然后等待到下一个整点查看经验是否增加。
