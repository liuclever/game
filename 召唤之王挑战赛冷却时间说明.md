# 召唤之王挑战赛冷却时间说明

## 功能状态
✅ **已实现** - 召唤之王挑战赛的1分钟挑战间隔功能已经完整实现

## 功能概述
召唤之王挑战赛设置了挑战冷却时间，玩家每次挑战后需要等待1分钟才能进行下一次挑战。

## 实现细节

### 后端实现 (`interfaces/routes/king_routes.py`)

#### 1. 冷却时间常量
```python
KING_CHALLENGE_COOLDOWN = 60  # 挑战冷却时间（秒）
```

#### 2. 冷却时间检查（在挑战时）
```python
if my_rank_info.get('last_challenge_time'):
    last_time = my_rank_info['last_challenge_time']
    if isinstance(last_time, str):
        last_time = datetime.strptime(last_time, '%Y-%m-%d %H:%M:%S')
    elapsed = (datetime.now() - last_time).total_seconds()
    if elapsed < KING_CHALLENGE_COOLDOWN:
        remaining = int(KING_CHALLENGE_COOLDOWN - elapsed)
        conn.rollback()
        return jsonify({"ok": False, "error": f"冷却中，还需等待{remaining}秒"})
```

#### 3. 返回剩余冷却时间（在获取信息时）
```python
cooldown_remaining = 0
if my_rank_info.get('last_challenge_time'):
    last_time = my_rank_info['last_challenge_time']
    if isinstance(last_time, str):
        last_time = datetime.strptime(last_time, '%Y-%m-%d %H:%M:%S')
    elapsed = (datetime.now() - last_time).total_seconds()
    if elapsed < KING_CHALLENGE_COOLDOWN:
        cooldown_remaining = int(KING_CHALLENGE_COOLDOWN - elapsed)

return jsonify({
    "ok": True,
    # ... 其他字段
    "cooldownRemaining": cooldown_remaining,
})
```

#### 4. 更新挑战时间（挑战后）
```python
cursor.execute(
    """UPDATE king_challenge_rank 
       SET today_challenges = %s, last_challenge_date = CURDATE(), last_challenge_time = NOW()
       WHERE user_id = %s""",
    (today_challenges + 1, user_id)
)
```

### 前端实现 (`interfaces/client/src/features/king/SummonKingChallengePage.vue`)

#### 1. 冷却时间状态
```javascript
const cooldownRemaining = ref(0)
```

#### 2. 加载冷却时间
```javascript
const loadKingInfo = async () => {
  const res = await http.get('/king/info')
  if (res.data.ok) {
    cooldownRemaining.value = res.data.cooldownRemaining || 0
    
    if (cooldownRemaining.value > 0) {
      startCooldownTimer()
    }
  }
}
```

#### 3. 冷却倒计时
```javascript
const startCooldownTimer = () => {
  if (cooldownTimer) clearInterval(cooldownTimer)
  
  cooldownTimer = setInterval(() => {
    if (cooldownRemaining.value > 0) {
      cooldownRemaining.value--
    } else {
      clearInterval(cooldownTimer)
      cooldownTimer = null
    }
  }, 1000)
}
```

#### 4. 挑战前检查
```javascript
const doChallenge = async (challenger) => {
  if (cooldownRemaining.value > 0) {
    showMessage(`冷却中，还需等待${cooldownRemaining.value}秒`, 'info')
    return
  }
  // ... 执行挑战
}
```

#### 5. UI显示
```vue
<!-- 挑战按钮 -->
<a 
  class="link challenge-btn" 
  @click="doChallenge(c)" 
  :class="{ disabled: challenging || cooldownRemaining > 0 }"
>
  {{ challenging ? '挑战中...' : (cooldownRemaining > 0 ? `冷却中(${cooldownRemaining}秒)` : '挑战') }}
</a>

<!-- 冷却时间提示 -->
<div class="section gray" v-if="cooldownRemaining > 0">
  挑战冷却：{{ cooldownRemaining }}秒
</div>
```

## 功能特点

### 1. 完整的冷却机制 ✅
- 后端记录每次挑战的时间
- 挑战前检查是否在冷却期内
- 冷却期内禁止挑战

### 2. 实时倒计时显示 ✅
- 前端显示剩余冷却秒数
- 每秒自动递减
- 倒计时结束后自动清除定时器

### 3. 用户友好的提示 ✅
- 按钮显示冷却状态
- 冷却期内按钮禁用
- 尝试挑战时提示剩余时间

### 4. 准确的时间计算 ✅
- 基于服务器时间计算
- 避免客户端时间不准确的问题

## 冷却时间规则

| 项目 | 值 |
|------|-----|
| 冷却时间 | 60秒（1分钟） |
| 触发时机 | 每次挑战后 |
| 计算方式 | 从上次挑战时间开始计算 |
| 显示方式 | 实时倒计时 |

## 用户体验流程

### 正常挑战流程
1. 玩家点击"挑战"按钮
2. 执行挑战战斗
3. 战斗结束后，记录挑战时间
4. 进入60秒冷却期
5. 前端显示倒计时：`冷却中(60秒)` → `冷却中(59秒)` → ... → `挑战`
6. 60秒后可以再次挑战

### 冷却期内尝试挑战
1. 玩家点击"挑战"按钮（冷却期内）
2. 前端提示：`冷却中，还需等待X秒`
3. 挑战不会执行
4. 按钮保持禁用状态

### 刷新页面后
1. 玩家刷新页面
2. 后端计算剩余冷却时间
3. 前端接收剩余时间并启动倒计时
4. 冷却状态正确恢复

## 数据库字段

### king_challenge_rank 表
- `last_challenge_time` - 最后挑战时间（DATETIME）
- 用于计算冷却时间

## 测试验证

### 测试场景1：正常冷却 ✅
1. 进行一次挑战
2. 观察冷却倒计时从60秒开始
3. 等待60秒
4. 验证可以再次挑战

### 测试场景2：冷却期内尝试挑战 ✅
1. 进行一次挑战
2. 立即尝试再次挑战
3. 验证提示"冷却中，还需等待X秒"
4. 验证挑战未执行

### 测试场景3：刷新页面 ✅
1. 进行一次挑战
2. 等待30秒
3. 刷新页面
4. 验证冷却时间正确显示（约30秒）

### 测试场景4：跨天冷却 ✅
1. 在23:59:30进行挑战
2. 等待到00:00:30
3. 验证冷却时间正确计算（仍需等待）

## 相关文件
- `interfaces/routes/king_routes.py` - 后端冷却逻辑
- `interfaces/client/src/features/king/SummonKingChallengePage.vue` - 前端冷却显示

## 完成状态
✅ 后端冷却检查实现
✅ 前端倒计时显示
✅ 按钮禁用逻辑
✅ 用户提示完善

## 总结

召唤之王挑战赛的1分钟挑战间隔功能已经完整实现，包括：
1. 后端冷却时间检查（60秒）
2. 前端实时倒计时显示
3. 冷却期内禁止挑战
4. 用户友好的提示信息

该功能已经正常工作，无需额外修改。

**实现时间：** 已实现（早期版本）  
**状态：** ✅ 完成并正常工作
