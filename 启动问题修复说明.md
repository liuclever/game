# 启动问题修复说明

## 修复日期
2026年1月18日

## 问题描述

启动前端和启动后端脚本都无法正常启动，报错。

## 问题原因

### 1. 后端启动失败

**原因**：`application/services/immortalize_pool_service.py` 文件中存在Git合并冲突标记

**错误信息**：
```
SyntaxError: invalid syntax
<<<<<<< HEAD
```

**具体位置**：第123行存在未解决的Git合并冲突标记

### 2. 前端启动失败

**原因**：`interfaces/client/src/features/tower/ZhenYaoPage.vue` 文件中有重复的函数定义

**错误信息**：
```
The symbol "loadFloors" was originally declared here
```

**具体问题**：
- 第50行定义了 `const loadFloors`（实际应该是 `loadZhenyaoInfo`）
- 第78行又定义了 `const loadFloors`
- 导致函数名冲突

## 修复内容

### 1. 修复后端合并冲突

#### application/services/immortalize_pool_service.py

**修复前**：
```python
if end and now < end:
    raise ImmortalizeError("化仙阵正在运行中")

<<<<<<< HEAD
# 检查并扣除7种结晶各1个
...
=======
>>>>>>> new/daily-book
duration_hours = self.config.get_formation_duration_hours()
```

**修复后**：
```python
if end and now < end:
    raise ImmortalizeError("化仙阵正在运行中")

# 检查并扣除7种结晶各1个
if not self.inventory_service:
    raise ImmortalizeError("系统错误：背包服务未初始化")

# ... 结晶检查和扣除逻辑 ...

duration_hours = self.config.get_formation_duration_hours()
```

**说明**：保留了两边的代码，删除了冲突标记

### 2. 修复前端函数重复定义

#### interfaces/client/src/features/tower/ZhenYaoPage.vue

**修复前**：
```javascript
// 加载层列表
const loadFloors = async () => {
  // 实际是加载镇妖信息的代码
  const zhenyaoRes = await http.get('/zhenyao/info')
  // ...
}

// 加载层列表
const loadFloors = async () => {
  // 实际是加载层列表的代码
  const res = await http.get(`/zhenyao/floors?type=${floorType.value}`)
  // ...
}
```

**修复后**：
```javascript
// 加载镇妖信息
const loadZhenyaoInfo = async () => {
  const zhenyaoRes = await http.get('/zhenyao/info')
  // ...
}

// 加载层列表
const loadFloors = async () => {
  const res = await http.get(`/zhenyao/floors?type=${floorType.value}`)
  // ...
}
```

**说明**：将第一个 `loadFloors` 重命名为 `loadZhenyaoInfo`

## 修复后的启动状态

### 后端启动成功

```
 * Serving Flask app 'app'
 * Debug mode: on
 * Running on http://127.0.0.1:5000
 * Running on http://192.168.10.11:5000
 * Debugger is active!
```

**访问地址**：
- 本地：http://127.0.0.1:5000
- 局域网：http://192.168.10.11:5000

### 前端启动成功

```
VITE v7.2.6  ready in 845 ms
➜  Local:   http://localhost:5173/
➜  Network: http://192.168.10.11:5173/
```

**访问地址**：
- 本地：http://localhost:5173
- 局域网：http://192.168.10.11:5173

## 启动步骤

### 方法1：使用启动脚本（推荐）

**启动后端**：
```bash
启动后端.bat
```

**启动前端**：
```bash
启动前端.bat
```

### 方法2：手动启动

**启动后端**：
```bash
python -m interfaces.web_api.app
```

**启动前端**：
```bash
cd interfaces/client
npm install  # 首次运行需要安装依赖
npm run dev
```

## 注意事项

### 1. Git合并冲突

**问题**：当从不同分支合并代码时，可能会产生合并冲突

**识别方法**：
- 文件中出现 `<<<<<<< HEAD`、`=======`、`>>>>>>> branch-name` 标记
- Python文件会报 `SyntaxError: invalid syntax`
- 其他文件可能有编译错误

**解决方法**：
1. 找到冲突标记
2. 决定保留哪部分代码（或两者都保留）
3. 删除冲突标记
4. 测试代码是否正常运行

**搜索冲突标记**：
```bash
# 搜索所有Python文件中的冲突标记
grep -r "<<<<<<< HEAD" --include="*.py"
grep -r "=======" --include="*.py"
grep -r ">>>>>>>" --include="*.py"
```

### 2. 前端依赖安装

**问题**：首次运行或切换分支后，可能缺少 `node_modules` 目录

**解决方法**：
```bash
cd interfaces/client
npm install
```

**识别方法**：
- 前端目录下没有 `node_modules` 文件夹
- 运行 `npm run dev` 时报错找不到模块

### 3. 端口占用

**问题**：如果端口已被占用，启动会失败

**后端端口**：5000
**前端端口**：5173

**解决方法**：
```bash
# Windows查看端口占用
netstat -ano | findstr :5000
netstat -ano | findstr :5173

# 结束占用端口的进程
taskkill /PID <进程ID> /F
```

### 4. Python环境

**要求**：Python 3.10+

**检查版本**：
```bash
python --version
```

**安装依赖**：
```bash
pip install -r requirements.txt
```

### 5. Node.js环境

**要求**：Node.js 18+

**检查版本**：
```bash
node --version
npm --version
```

## 常见问题

### Q1: 后端启动后立即退出

**可能原因**：
- Python版本不兼容
- 缺少依赖包
- 数据库连接失败

**解决方法**：
1. 检查Python版本
2. 安装依赖：`pip install -r requirements.txt`
3. 检查数据库配置

### Q2: 前端编译错误

**可能原因**：
- 代码语法错误
- 依赖版本不兼容
- 缓存问题

**解决方法**：
1. 检查错误信息中的文件和行号
2. 删除 `node_modules` 和 `package-lock.json`，重新安装
3. 清除Vite缓存：删除 `.vite` 目录

### Q3: 前端无法连接后端

**可能原因**：
- 后端未启动
- 端口配置错误
- CORS配置问题

**解决方法**：
1. 确认后端已启动并监听正确端口
2. 检查前端的API配置（通常在 `src/services/http.js`）
3. 检查后端的CORS配置

## 修改的文件

1. `application/services/immortalize_pool_service.py` - 解决Git合并冲突
2. `interfaces/client/src/features/tower/ZhenYaoPage.vue` - 修复函数重复定义

## 测试建议

### 1. 后端测试

访问后端健康检查接口：
```bash
curl http://127.0.0.1:5000/api/health
```

### 2. 前端测试

在浏览器中访问：
```
http://localhost:5173
```

检查：
- 页面是否正常加载
- 控制台是否有错误
- 能否正常登录

### 3. 前后端联调测试

1. 启动后端和前端
2. 在前端登录
3. 测试各个功能模块
4. 检查网络请求是否正常

## 后续优化建议

### 1. 添加启动检查

在启动脚本中添加：
- 检查端口是否被占用
- 检查依赖是否已安装
- 检查配置文件是否存在

### 2. 添加健康检查

- 后端添加 `/api/health` 接口
- 前端添加后端连接状态检查
- 启动时自动检查服务是否正常

### 3. 改进错误提示

- 更详细的错误信息
- 提供解决方案建议
- 添加日志记录

### 4. 使用进程管理工具

考虑使用：
- PM2（Node.js进程管理）
- Supervisor（Python进程管理）
- Docker Compose（容器化部署）

---

**修复完成时间**：2026年1月18日  
**修复人员**：Kiro AI Assistant  
**版本**：v1.0
