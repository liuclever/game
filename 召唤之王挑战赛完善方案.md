# 召唤之王挑战赛完善方案

## 当前状态分析

### 已实现功能
1. ✅ 基础排名系统（两个赛区）
2. ✅ 挑战机制（胜利排名上升，失败排名不变）
3. ✅ 每日15次免费挑战
4. ✅ 60秒冷却时间
5. ✅ 预选赛铜钱奖励（胜利20000，失败2000）
6. ✅ 正赛淘汰赛系统
7. ✅ 正赛奖励配置（冠军、亚军、4强、8强、16强、32强）
8. ✅ 定时任务（周一重置、周四晋级、周五正赛）

### 需要完善的功能

#### 1. 等级限制（20级）
**位置**: `king_routes.py` - `get_king_info()` 和 `king_challenge()`

```python
# 在 get_king_info() 开头添加
player = services.player_repo.get_by_id(user_id)
if not player or player.level < 20:
    return jsonify({"ok": False, "error": "需要达到20级才能参加召唤之王挑战赛"})
```

#### 2. 预选赛时间限制
**位置**: `king_routes.py` - `king_challenge()`

```python
# 在挑战函数中添加时间检查
today = datetime.now()
weekday = today.weekday()  # 0=周一, 1=周二, ..., 6=周日

# 周一是报名日，不能挑战
if weekday == 0:
    return jsonify({"ok": False, "error": "周一为报名日，预选赛将于周二开始"})

# 周二、周三、周四可以挑战（预选赛）
# 周五是正赛日，预选赛已结束
if weekday == 4:  # 周五
    return jsonify({"ok": False, "error": "预选赛已结束，正赛进行中"})

# 周六、周日休赛
if weekday >= 5:
    return jsonify({"ok": False, "error": "本周赛事已结束，请等待下周一报名"})
```

#### 3. 战令增加挑战次数
**需要实现**:
- 检查玩家是否拥有战令道具
- 使用战令增加挑战次数（例如+5次）
- 扣除战令道具

```python
@king_bp.post("/use-battle-pass")
def use_battle_pass():
    """使用战令增加挑战次数"""
    user_id = get_current_user_id()
    if not user_id:
        return jsonify({"ok": False, "error": "请先登录"})
    
    # 战令道具ID（需要在items.json中配置）
    BATTLE_PASS_ITEM_ID = 8001  # 示例ID
    EXTRA_CHALLENGES = 5  # 增加5次挑战
    
    try:
        # 检查是否有战令
        inventory = services.inventory_service.get_item_quantity(user_id, BATTLE_PASS_ITEM_ID)
        if inventory < 1:
            return jsonify({"ok": False, "error": "没有战令道具"})
        
        # 扣除战令
        services.inventory_service.remove_item(user_id, BATTLE_PASS_ITEM_ID, 1)
        
        # 增加挑战次数（修改today_challenges，减少已用次数）
        execute_update(
            """UPDATE king_challenge_rank 
               SET today_challenges = GREATEST(0, today_challenges - %s)
               WHERE user_id = %s""",
            (EXTRA_CHALLENGES, user_id)
        )
        
        return jsonify({
            "ok": True,
            "message": f"使用战令成功！增加{EXTRA_CHALLENGES}次挑战机会"
        })
    except Exception as e:
        return jsonify({"ok": False, "error": str(e)})
```

#### 4. 奖励领取时间限制
**位置**: `king_routes.py` - `claim_king_reward()`

```python
# 在 claim_king_reward() 中添加时间检查
today = datetime.now()
weekday = today.weekday()

# 只能在本周内领取（周一0点前）
# 如果是周一，检查是否是新的一周
if weekday == 0:
    return jsonify({"ok": False, "error": "新赛季已开始，上周奖励已过期无法领取"})
```

#### 5. 前32名晋级逻辑确认
**位置**: `domain/services/king_final_service.py` - `advance_to_finals()`

当前实现是每个赛区前16名，共32名。需要确认是否正确。

根据需求："各区前32名玩家进入正赛"
- 如果是两个赛区，应该是每个赛区前16名（共32名）✅ 当前实现正确
- 如果是一个赛区，应该是前32名

#### 6. 报名时间限制
**位置**: `king_routes.py` - `king_register()`

```python
# 修改报名函数，确保只能在周一0:00-23:59报名
today = datetime.now()
if today.weekday() != 0:
    return jsonify({"ok": False, "error": "只能在每周一0:00-23:59报名参赛"})
```

## 实施步骤

1. 添加等级限制检查
2. 添加预选赛时间限制
3. 实现战令增加挑战次数功能
4. 添加奖励领取时间限制
5. 确认前32名晋级逻辑
6. 测试完整流程

## 数据库表结构确认

需要确认以下表是否存在：
- `king_challenge_rank` - 排名表
- `king_challenge_logs` - 挑战记录表
- `king_reward_claimed` - 奖励领取记录表
- `king_finals` - 正赛记录表

## 前端页面需求

需要创建或更新以下页面：
1. 召唤之王主页面 - 显示赛区、排名、挑战次数等
2. 挑战页面 - 选择对手并发起挑战
3. 排行榜页面 - 显示赛区排名
4. 奖励页面 - 显示和领取奖励
5. 动态页面 - 显示挑战记录
6. 正赛页面 - 显示正赛对阵和结果

## 配置文件

需要在 `configs/items.json` 中添加战令道具：
```json
{
  "id": 8001,
  "name": "召唤之王战令",
  "description": "使用后可增加5次召唤之王挑战次数",
  "type": "consumable",
  "rarity": "rare"
}
```
