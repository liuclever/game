# 增幅技能属性加成功能说明

## 问题描述

技能打书功能中，增幅技能（防御、高级防御、魔抗、高级魔抗、敏捷、高级敏捷、强力、高级强力、智慧、高级智慧、体魄、高级体魄）打上去后没有增加幻兽的物防、法防、速度、气血、物攻、法攻的数值。

## 解决方案

### 1. 增幅技能规则

增幅技能增加属性数值的规则：**用对应的百分比乘以去掉魔魂、战骨、战灵加成后的纯裸数值**

例如：
- 15级血螳螂物攻裸数值为200
- 打上强力（增加10%物攻）技能
- 增加的物攻值为 10% × 200 = 20
- 最终物攻为 220

### 2. 增幅技能配置

所有增幅技能的配置在 `configs/skills.json` 的 `buff_skills` 部分：

| 技能名称 | 属性 | 加成百分比 |
|---------|------|-----------|
| 强力 | physical_attack | +9% |
| 高级强力 | physical_attack | +18% |
| 智慧 | magic_attack | +9% |
| 高级智慧 | magic_attack | +18% |
| 防御 | physical_defense | +5% |
| 高级防御 | physical_defense | +10% |
| 魔抗 | magic_defense | +5% |
| 高级魔抗 | magic_defense | +10% |
| 敏捷 | speed | +10% |
| 高级敏捷 | speed | +20% |
| 体魄 | hp | +10% |
| 高级体魄 | hp | +20% |

### 3. 实现细节

#### 3.1 新增函数：`get_buff_skill_bonuses`

位置：`domain/services/beast_stats.py`

功能：根据幻兽的技能列表，计算所有增幅技能的属性加成百分比

```python
def get_buff_skill_bonuses(skills: List[str]) -> Dict[str, float]:
    """计算增幅技能的属性加成百分比
    
    Args:
        skills: 幻兽当前技能列表
        
    Returns:
        各属性的加成百分比字典
    """
```

#### 3.2 修改函数：`calc_beast_attributes`

位置：`domain/services/beast_stats.py`

修改内容：
1. 新增参数 `skills: List[str] = None` - 幻兽技能列表
2. 计算流程改为：
   - 先计算裸属性（不含增幅技能）
   - 调用 `get_buff_skill_bonuses` 获取增幅技能加成
   - 应用增幅技能加成到裸属性上
   - 返回最终属性

```python
# 计算裸属性
hp_naked = int(hp_base + hp_level_bonus)
phys_atk_naked = ...
# ... 其他属性

# 计算增幅技能加成
buff_bonuses = get_buff_skill_bonuses(skills or [])

# 应用增幅技能加成
hp = int(hp_naked * (1 + buff_bonuses.get('hp', 0.0)))
phys_atk = int(phys_atk_naked * (1 + buff_bonuses.get('physical_attack', 0.0)))
# ... 其他属性
```

#### 3.3 修改函数：`_calc_beast_stats`

位置：`interfaces/routes/beast_routes.py`

修改内容：
1. 获取幻兽的技能列表
2. 将技能列表传递给 `calc_beast_attributes` 函数

```python
# 获取幻兽技能列表
beast_skills = getattr(beast, 'skills', []) or []
if isinstance(beast_skills, str):
    try:
        beast_skills = json.loads(beast_skills)
    except:
        beast_skills = []

attrs = calc_beast_attributes(
    # ... 其他参数
    skills=beast_skills,  # 传递技能列表
)
```

#### 3.4 修改接口：`use_skill_book_api`

位置：`interfaces/routes/beast_routes.py`

修改内容：
1. 打书成功后，调用 `_calc_beast_stats` 重新计算幻兽属性
2. 返回更新后的属性值给前端

```python
# 更新幻兽技能
beast.skills = result.final_skills

# 重新计算幻兽属性（应用增幅技能加成）
beast = _calc_beast_stats(beast)
services.player_beast_repo.update_beast(beast)

# 返回更新后的属性
return jsonify({
    "ok": True,
    # ... 其他字段
    "updatedStats": {
        "hp": beast.hp,
        "physical_attack": beast.physical_attack,
        "magic_attack": beast.magic_attack,
        "physical_defense": beast.physical_defense,
        "magic_defense": beast.magic_defense,
        "speed": beast.speed,
        "combat_power": beast.combat_power,
    }
})
```

### 4. 测试验证

运行测试脚本：
```bash
python test_skill_amplification.py
```

测试结果：
- ✅ 强力技能（+9%物攻）加成正确
- ✅ 高级强力技能（+18%物攻）加成正确
- ✅ 多个增幅技能可以叠加
- ✅ 所有12种增幅技能配置正确

### 5. 使用流程

1. 玩家在游戏中使用技能书给幻兽打书
2. 后端接收到打书请求，验证技能书有效性
3. 使用 `use_skill_book` 函数处理技能学习/替换逻辑
4. 更新幻兽的技能列表
5. **调用 `_calc_beast_stats` 重新计算幻兽属性（包含增幅技能加成）**
6. 保存更新后的幻兽数据到数据库
7. 返回更新后的属性给前端
8. 前端刷新幻兽详情页面，显示新的属性值

### 6. 注意事项

1. **增幅技能基于裸属性计算**：增幅技能的加成是基于幻兽的裸属性（不含魔魂、战骨、战灵）计算的
2. **战力同步更新**：属性增加后，战力也会相应增加
3. **前端需要刷新**：打书成功后，前端需要重新获取幻兽详情才能看到更新后的属性
4. **多个增幅技能可叠加**：同一幻兽可以拥有多个增幅技能，加成效果会叠加
5. **后端需要重启**：修改后端代码后需要重启后端服务才能生效

### 7. 修改的文件

1. `domain/services/beast_stats.py`
   - 新增 `get_buff_skill_bonuses` 函数
   - 修改 `calc_beast_attributes` 函数，新增 `skills` 参数

2. `interfaces/routes/beast_routes.py`
   - 修改 `_calc_beast_stats` 函数，传递技能列表
   - 修改 `use_skill_book_api` 函数，打书后重新计算属性

3. `test_skill_amplification.py`
   - 新增测试脚本，验证增幅技能加成功能

4. `增幅技能属性加成功能说明.md`
   - 本文档

## 测试步骤

1. 重启后端服务：
   ```bash
   # 停止当前后端服务
   # 重新启动后端服务
   python start-backend.bat
   ```

2. 登录测试账号：
   - 账号：test50_97355
   - 密码：123456

3. 查看幻兽当前属性（记录打书前的数值）

4. 使用强力技能书给幻兽打书

5. 刷新幻兽详情页面，查看属性是否增加

6. 验证：
   - 物攻应该增加约 9%（基于裸属性）
   - 战力应该相应增加

## 完成状态

✅ 功能已实现并测试通过
✅ 增幅技能加成计算正确
✅ 打书后属性自动更新
✅ 战力同步更新
