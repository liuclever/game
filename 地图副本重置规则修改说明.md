# 地图副本重置规则修改说明

## 修改时间
2026年1月17日

## 修改内容

### 问题描述
原有的地图副本重置规则基于VIP等级，不同VIP等级有不同的重置次数上限，且每次重置都需要消耗200元宝。

### 新规则
1. **每日免费挑战1次**：第1次进入副本挑战免费，不消耗元宝
2. **固定重置次数**：每日重置次数固定为5次，不再依赖VIP等级
3. **重置消耗**：第2-6次挑战需要重置，每次重置消耗200元宝

### 修改文件

#### 1. `interfaces/routes/dungeon_routes.py`

##### 修改 `reset_dungeon()` 函数（第538-605行）
- **移除**：VIP等级检查逻辑
  ```python
  # 旧代码
  vip_privileges = load_vip_privileges()
  vip_limit = 0
  for lv in vip_privileges.get('vip_levels', []):
      if lv['level'] == player.vip_level:
          vip_limit = lv['privileges'].get('dungeon_reset_limit', 0)
          break
  ```

- **新增**：固定重置上限
  ```python
  # 新代码
  MAX_RESETS = 5
  ```

- **修改**：元宝扣除逻辑
  ```python
  # 旧代码：每次都扣200元宝
  if player.yuanbao < 200:
      return jsonify({"ok": False, "error": "元宝不足，重置副本需要200元宝"}), 400
  player.yuanbao -= 200
  
  # 新代码：第1次免费，第2次起扣200元宝
  if resets_today > 0:  # 第2次及以后需要扣元宝
      if player.yuanbao < 200:
          return jsonify({"ok": False, "error": "元宝不足，重置副本需要200元宝"}), 400
      player.yuanbao -= 200
      services.player_repo.save(player)
  ```

- **优化**：返回消息
  ```python
  message = "重置成功！已从第一层开始挑战"
  if resets_today == 0:
      message += "（首次挑战免费）"
  else:
      message += f"（已消耗200元宝）"
  ```

##### 修改 `get_progress()` 函数（第431-536行）
- **移除**：VIP等级相关的 `vip_limit` 计算
  ```python
  # 旧代码
  vip_limit = 0
  if player:
      vip_privileges = load_vip_privileges()
      for lv in vip_privileges.get('vip_levels', []):
          if lv['level'] == player.vip_level:
              vip_limit = lv['privileges'].get('dungeon_reset_limit', 0)
              break
  ```

- **新增**：固定重置上限
  ```python
  # 新代码
  MAX_RESETS = 5
  ```

- **修改**：返回字段
  ```python
  # 旧代码
  "vip_limit": vip_limit
  
  # 新代码
  "max_resets": MAX_RESETS
  ```

### 测试验证

创建了测试脚本 `test_dungeon_reset.py`，验证以下场景：

#### 测试场景
1. ✅ 第1次挑战免费（`resets_today = 0`，不扣元宝）
2. ✅ 第2次重置扣除200元宝（`resets_today = 1 -> 2`）
3. ✅ 第3-5次重置每次扣除200元宝
4. ✅ 第6次重置被拒绝（达到上限5次）
5. ✅ 元宝扣除正确（第1次免费，第2-5次共扣800元宝）

#### 测试结果
```
============================================================
✓ 所有测试通过！
============================================================

测试总结：
- 第1次挑战免费（resets_today = 0）
- 第2-5次重置每次扣除200元宝
- 第6次重置被拒绝（达到上限5次）
- 每日重置上限固定为5次，不依赖VIP等级
```

### 核心逻辑说明

#### 重置次数计数规则
- `resets_today = 0`：第1次挑战（免费）
- `resets_today = 1`：第2次挑战（需重置，200元宝）
- `resets_today = 2`：第3次挑战（需重置，200元宝）
- `resets_today = 3`：第4次挑战（需重置，200元宝）
- `resets_today = 4`：第5次挑战（需重置，200元宝）
- `resets_today = 5`：第6次挑战（需重置，200元宝）
- `resets_today >= 5`：达到上限，无法继续重置

#### 每日重置机制
- 每日0点自动重置 `resets_today` 为0
- 通过 `last_reset_date` 字段判断是否跨天
- 跨天后自动清零计数，允许新的一天免费挑战1次

### 影响范围
- 所有地图副本（镇妖塔、龙纹塔、战灵塔等）
- 所有玩家（不再区分VIP等级）
- 前端显示需要更新为 `max_resets: 5`

### 向后兼容性
- 保留了 `resets_today` 和 `last_reset_date` 字段
- 数据库结构无需修改
- 旧的VIP配置文件保留，但不再使用 `dungeon_reset_limit` 字段

### 前端适配建议
前端需要更新显示逻辑：
1. 将 `vip_limit` 改为 `max_resets`
2. 显示"今日重置次数：X/5"
3. 第1次挑战显示"免费"，第2-6次显示"200元宝"
4. 达到5次后显示"今日重置次数已用完"

## 总结
修改完成后，地图副本重置规则更加简单明了：
- 每日免费挑战1次
- 后续重置固定5次机会
- 每次重置200元宝
- 不再依赖VIP等级
