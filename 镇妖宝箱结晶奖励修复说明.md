# 镇妖宝箱结晶奖励修复说明

## 问题描述

打开三星试炼宝箱时，显示"七类结晶×3"，但实际获得的是同一种结晶的3个（例如：金之结晶×3），而不是3种不同的结晶各1个。

## 问题原因

原代码逻辑错误：
```python
# 错误逻辑
if not item_id and "pool" in item_cfg:
    pool = item_cfg.get("pool") or []
    if pool:
        item_id = random.choice(pool)  # 只随机选1种

if item_id:
    count = int(item_cfg.get("count", 1) or 1)  # count=3
    self.add_item(user_id, int(item_id), count)  # 给同一种结晶3个
```

这导致：
- 从7种结晶中随机选择**1种**
- 然后给这1种结晶**N个**
- 例如：随机到金之结晶，给3个金之结晶

## 正确逻辑

应该是：
- 从7种结晶中随机选择**N种不同的**
- 每种结晶给**1个**
- 例如：随机选3种（金、木、水），各给1个

## 修复方案

### 修改代码逻辑

```python
# 正确逻辑
for item_cfg in rewards_def.get("items", []) or []:
    # 检查是否是从池中随机选择
    if "pool" in item_cfg:
        pool = item_cfg.get("pool") or []
        count = int(item_cfg.get("count", 1) or 1)
        if pool and count > 0:
            # 从池中随机选择count个不同的物品，每个给1个
            selected_items = random.sample(pool, min(count, len(pool)))
            for item_id in selected_items:
                self.add_item(user_id, int(item_id), 1)
                # ... 记录到item_summary
    else:
        # 普通物品，直接发放
        item_id = item_cfg.get("id")
        if item_id:
            count = int(item_cfg.get("count", 1) or 1)
            self.add_item(user_id, int(item_id), count)
```

### 关键改进

1. **使用 `random.sample()`**
   - 确保选择的结晶不重复
   - `random.sample(pool, count)` 返回count个不同的元素

2. **每种结晶给1个**
   - 遍历选中的结晶ID
   - 每个ID调用 `add_item(user_id, item_id, 1)`

3. **处理边界情况**
   - `min(count, len(pool))` 确保不超过池大小
   - 8星宝箱要求8种，但只有7种结晶，所以给全部7种

## 七类结晶

| ID   | 名称 |
|------|------|
| 1001 | 金之结晶 |
| 1002 | 木之结晶 |
| 1003 | 水之结晶 |
| 1004 | 火之结晶 |
| 1005 | 土之结晶 |
| 1006 | 电之结晶 |
| 1007 | 风之结晶 |

## 星级与结晶数量对应

| 星级 | 宝箱名称 | 结晶数量 | 说明 |
|------|---------|---------|------|
| 3星 | 三星试炼宝箱 | 3种不同结晶 | 从7种中随机选3种 |
| 4星 | 四星试炼宝箱 | 4种不同结晶 | 从7种中随机选4种 |
| 5星 | 五星试炼宝箱 | 5种不同结晶 | 从7种中随机选5种 |
| 6星 | 六星试炼宝箱 | 6种不同结晶 | 从7种中随机选6种 |
| 7星 | 七星试炼宝箱 | 7种不同结晶 | 全部7种 |
| 8星 | 八星试炼宝箱 | 7种不同结晶 | 全部7种（最多7种） |

## 奖励示例

### 三星试炼宝箱
- **铜钱**: 100000
- **结晶**: 从7种中随机选3种，例如：
  - 金之结晶×1
  - 木之结晶×1
  - 水之结晶×1
- **其他**: 活力草×1

### 五星炼狱宝箱
- **铜钱**: 140000
- **结晶**: 从7种中随机选5种，例如：
  - 火之结晶×1
  - 土之结晶×1
  - 电之结晶×1
  - 风之结晶×1
  - 金之结晶×1
- **其他**: 活力草×2、强力捕捉球×2、追魂法宝×2、灵力水晶×1

### 七星试炼宝箱
- **铜钱**: 180000
- **结晶**: 全部7种：
  - 金之结晶×1
  - 木之结晶×1
  - 水之结晶×1
  - 火之结晶×1
  - 土之结晶×1
  - 电之结晶×1
  - 风之结晶×1
- **其他**: 活力草×4

## 配置文件

配置文件 `configs/zhenyao_rewards.json` 中使用 `pool` 字段表示结晶池：

```json
{
  "pool": [1001, 1002, 1003, 1004, 1005, 1006, 1007],
  "name": "七类结晶",
  "count": 3
}
```

- `pool`: 结晶ID列表
- `count`: 从池中随机选择的数量
- 修复后：选择3种不同的结晶，每种给1个

## 测试验证

### 测试脚本
```bash
python test_zhenyao_chest_crystals.py
```

### 测试内容
1. 结晶选择逻辑测试
   - 验证从7种中随机选N种
   - 确保选择的结晶不重复
   - 测试各星级宝箱

2. 奖励分配测试
   - 验证各星级宝箱的奖励配置
   - 检查结晶数量正确
   - 确认其他奖励正确

3. 边界情况测试
   - 8星宝箱（要求8种，但只有7种）
   - 确保不会超过池大小

### 测试结果示例
```
三星宝箱 - 应该获得 3 种不同的结晶:
  第1次: 水之结晶, 木之结晶, 火之结晶 (共3种)
  第2次: 风之结晶, 火之结晶, 水之结晶 (共3种)
  第3次: 电之结晶, 土之结晶, 金之结晶 (共3种)
```

## 修复前后对比

### 修复前
```
打开三星试炼宝箱:
- 金之结晶×3  ❌ 错误：同一种结晶3个
- 活力草×1
- 铜钱×100000
```

### 修复后
```
打开三星试炼宝箱:
- 金之结晶×1  ✓ 正确：3种不同结晶
- 木之结晶×1
- 水之结晶×1
- 活力草×1
- 铜钱×100000
```

## 影响范围

### 受影响的物品
- 试炼宝箱（92001）
- 炼狱宝箱（92002）
- 所有使用 `pool` 配置的物品

### 不受影响的物品
- 普通物品（使用 `id` 字段）
- 固定奖励物品

## 相关文件

### 后端
- `application/services/inventory_service.py` - 物品使用逻辑（主要修改）
  - 修改宝箱打开逻辑
  - 处理 `pool` 字段的随机选择

### 配置
- `configs/zhenyao_rewards.json` - 镇妖奖励配置
  - 定义各星级宝箱的奖励
  - 使用 `pool` 字段配置结晶池

### 测试
- `test_zhenyao_chest_crystals.py` - 结晶奖励测试脚本

## 注意事项

1. **随机性**
   - 每次打开宝箱，获得的结晶种类是随机的
   - 但数量固定（星级决定）

2. **不重复**
   - 使用 `random.sample()` 确保不重复
   - 同一次打开不会获得重复的结晶

3. **边界处理**
   - 8星宝箱要求8种，但只有7种结晶
   - 自动限制为7种（全部）

4. **配置灵活性**
   - 可以通过修改配置文件调整奖励
   - 可以添加更多结晶种类到池中

## 总结

镇妖宝箱结晶奖励修复已完成：
1. ✓ 修复了结晶选择逻辑
2. ✓ 从池中随机选择N种不同的结晶
3. ✓ 每种结晶给1个
4. ✓ 星级越高，获得的结晶种类越多
5. ✓ 测试脚本验证功能正确

玩家打开镇妖宝箱时，将获得多种不同的结晶，而不是同一种结晶的多个，更加符合游戏设计意图。
