# 副本战斗数据缺失问题排查指南

## 问题描述

用户反馈：地图副本挑战时，无法战斗，没有战斗数据。

## 可能原因

### 1. 后端服务未重启

如果修改了后端代码但没有重启服务，可能导致代码不生效。

**解决方案**：
```bash
# 重启后端服务
restart_flask.bat
```

### 2. 前端缓存问题

浏览器可能缓存了旧版本的前端代码。

**解决方案**：
- 按 `Ctrl + F5` 强制刷新页面
- 或者清除浏览器缓存后重新访问

### 3. 出战幻兽未设置

玩家没有设置出战幻兽，导致无法战斗。

**检查方法**：
```python
python diagnose_dungeon_battle.py
```

查看输出中"出战幻兽数量"是否为0。

**解决方案**：
- 进入"幻兽仓库"
- 选择幻兽并设置为"出战"

### 4. 副本配置文件问题

副本配置文件 `configs/dungeon_beasts.json` 可能损坏或格式错误。

**检查方法**：
```python
python diagnose_dungeon_battle.py
```

查看"检查副本配置文件"部分是否有错误。

### 5. 数据库连接问题

数据库连接失败或查询超时。

**检查方法**：
- 查看后端控制台是否有数据库错误
- 运行 `python test_db_connection.py` 测试数据库连接

## 完整测试流程

### 步骤1：检查后端服务

确保后端服务正在运行：
```bash
# 查看进程
tasklist | findstr python

# 如果没有运行，启动服务
start-backend.bat
```

### 步骤2：检查数据

运行诊断脚本：
```bash
python diagnose_dungeon_battle.py
```

检查输出：
- ✓ 配置文件加载成功
- ✓ 出战幻兽数量 > 0
- ✓ 副本进度记录存在

### 步骤3：测试完整流程

如果后端服务正在运行，可以运行：
```bash
python test_dungeon_battle_flow.py
```

这会模拟完整的副本挑战流程，并显示详细的战斗数据。

### 步骤4：前端测试

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 进入副本挑战页面
4. 点击"挑战幻兽"
5. 查看控制台输出：
   - 是否有网络请求错误
   - 是否有 JavaScript 错误
   - 战斗数据是否正确返回

## 常见错误信息

### "没有幻兽可挑战"

**原因**：当前层没有幻兽数据

**解决方案**：
1. 检查是否在随机事件层（第5, 10, 15, 20, 25, 30层）
2. 如果不是，检查副本配置文件是否正确

### "你没有出战幻兽"

**原因**：玩家没有设置出战幻兽

**解决方案**：
1. 进入"幻兽仓库"
2. 选择幻兽
3. 点击"设置出战"

### "战斗数据为空"

**原因**：后端返回的战斗数据中 `battles` 字段为空

**可能原因**：
1. PVP战斗引擎执行失败
2. 幻兽属性数据异常（HP、攻击力等为0）
3. 战斗日志格式化失败

**排查方法**：
1. 查看后端控制台的错误日志
2. 检查幻兽属性是否正常
3. 运行 `test_dungeon_battle_flow.py` 查看详细错误

## 修复建议

如果以上方法都无法解决问题，建议：

1. **重启所有服务**：
   ```bash
   # 停止所有Python进程
   taskkill /F /IM python.exe
   
   # 重新启动后端
   start-backend.bat
   
   # 重新启动前端
   start-frontend.bat
   ```

2. **清除浏览器缓存**：
   - Chrome: Ctrl + Shift + Delete
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

3. **检查代码版本**：
   ```bash
   git status
   git log -1
   ```
   
   确保所有修改都已提交并且代码是最新版本。

## 联系开发者

如果问题仍然存在，请提供以下信息：

1. `diagnose_dungeon_battle.py` 的完整输出
2. 浏览器控制台的错误信息（截图）
3. 后端控制台的错误日志
4. 用户ID和副本名称
