# 副本随机事件修复说明

## 问题描述
在地图副本中，当玩家扔骰子遇到随机事件（攀登、活力之泉）时，如果事件失败，会出现以下问题：
1. 随机事件本身不需要战斗，但 `floor_cleared` 被设置为 `FALSE`
2. 事件失败后，`floor_cleared` 仍然是 `FALSE`
3. 玩家再次点击骰子时，系统检查到 `floor_cleared = FALSE` 且 `floor_event_type` 不是 `beast` 或 `boss`
4. 导致玩家无法继续前进，也无法再次尝试事件，陷入死锁状态

## 问题根源

### 原有逻辑
在 `interfaces/routes/dungeon_routes.py` 中：

1. **攀登事件（climb）**：
   - 成功率：33.3%
   - 成功时：标记 `floor_cleared = TRUE`，获得声望奖励
   - 失败时：不标记 `floor_cleared`，导致玩家无法前进

2. **活力之泉事件（vitality_spring）**：
   - 成功率：25%
   - 成功时：标记 `floor_cleared = TRUE`，恢复满活力
   - 失败时：不标记 `floor_cleared`，导致玩家无法前进

3. **猜拳事件（rps）**：
   - 无论输赢，都会直接跳转到新楼层，设置 `floor_cleared = FALSE`
   - 这个事件没有问题，因为它会立即改变楼层

### 前进检查逻辑
```python
if not floor_cleared and floor_event_type in ('beast', 'boss'):
    return jsonify({"ok": False, "error": "请先击败本层幻兽才能前进"}), 400
```

这个检查只针对 `beast` 和 `boss` 类型，但当随机事件失败时，`floor_event_type` 仍然是 `climb` 或 `vitality_spring`，不会触发这个错误。

然而，前端会显示"本层尚未通关"的状态，玩家无法继续操作。

## 解决方案

### 修复策略
将随机事件（攀登、活力之泉）的逻辑修改为：**无论成功失败，都标记本层已通关**，允许玩家继续前进。

理由：
1. 随机事件本身不需要战斗，只是一个概率性的奖励机会
2. 玩家已经消耗了骰子，应该允许继续前进
3. 失败只是没有获得奖励，不应该阻止玩家继续探索

### 修复代码

#### 1. 攀登事件修复
```python
@dungeon_bp.route('/event/climb', methods=['POST'])
def event_climb():
    # ... 前面的代码不变 ...
    
    services.player_repo.save(player)
    
    # 无论成功失败，都标记本层已通关，允许玩家继续前进
    execute_update("""
        UPDATE player_dungeon_progress 
        SET floor_cleared = TRUE, updated_at = CURRENT_TIMESTAMP
        WHERE user_id = %s AND dungeon_name = %s
    """, (user_id, dungeon_name))
    
    return jsonify({
        "ok": True,
        "success": success,
        "prestige_gain": prestige_gain,
        "dice": player.dice,
        "message": f"攀登{'成功' if success else '失败'}" + (f"，获得{prestige_gain}声望" if success else "")
    })
```

#### 2. 活力之泉事件修复
```python
@dungeon_bp.route('/event/vitality-spring', methods=['POST'])
def event_vitality_spring():
    # ... 前面的代码不变 ...
    
    services.player_repo.save(player)
    
    # 无论成功失败，都标记本层已通关，允许玩家继续前进
    execute_update("""
        UPDATE player_dungeon_progress 
        SET floor_cleared = TRUE, updated_at = CURRENT_TIMESTAMP
        WHERE user_id = %s AND dungeon_name = %s
    """, (user_id, dungeon_name))
    
    return jsonify({
        "ok": True,
        "success": success,
        "dice": player.dice,
        "energy": player.energy,
        "message": f"浸泡{'成功' if success else '失败'}" + ("，活力已补满" if success else "")
    })
```

## 修复文件
- `interfaces/routes/dungeon_routes.py`
  - 修改 `event_climb()` 函数
  - 修改 `event_vitality_spring()` 函数

## 测试建议
1. 进入任意副本，扔骰子前进到随机事件层（5、10、15、20、25、30层）
2. 遇到攀登事件时，点击"攀登"按钮
3. 如果失败，确认可以继续点击"前进"按钮扔骰子
4. 遇到活力之泉事件时，点击"浸泡"按钮
5. 如果失败，确认可以继续点击"前进"按钮扔骰子
6. 确认成功时仍然能正常获得奖励并继续前进

## 影响范围
- 只影响副本随机事件的处理逻辑
- 不影响幻兽战斗、宝箱开启等其他事件
- 玩家体验改善：不会因为随机事件失败而卡住

## 注意事项
- 猜拳事件（rps）不需要修改，因为它会直接跳转到新楼层
- 幻兽战斗和BOSS战斗仍然需要击败才能通关，逻辑不变
- 宝箱事件可以选择开启或跳过，逻辑不变
