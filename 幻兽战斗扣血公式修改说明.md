# 幻兽战斗扣血公式修改说明

## 修改日期
2026年1月18日

## 修改内容

### 新的扣血公式

所有涉及幻兽对战的扣血公式已统一修改为：

#### 情况1：攻击 - 防御 ≥ 0
```
伤害 = (攻击 - 防御) × 0.069（四舍五入）
最小伤害：1点
```

#### 情况2：攻击 - 防御 < 0
```
固定扣血：5点
```

### 涉及的战斗系统

以下所有战斗系统的扣血机制已全部修改：

1. **竞技场战斗**（擂台）
2. **地图副本挑战**
3. **盟战战斗**
4. **闯塔战斗**
5. **好友切磋战斗**
6. **战场战斗**（古战场）
7. **召唤之王挑战赛**
8. **镇妖塔战斗**
9. **龙宫战斗**
10. **连胜竞技场**

### 修改的文件

#### 1. domain/services/pvp_battle_engine.py
- 修改了 `calc_damage()` 函数
- 这是主要的PVP战斗引擎，被大部分战斗系统使用

#### 2. domain/services/battle_engine.py
- 修改了 `SimpleDamageCalculator` 类
- 修改了 `RandomDamageCalculator` 类
- 这是旧的战斗引擎，保留用于兼容

#### 3. application/services/tower_service.py
- 修改了 `calc_damage()` 方法
- 修改了 `calc_damage_with_type()` 方法
- 用于闯塔战斗

#### 4. application/services/zhenyao_service.py
- 修改了 `_calc_damage()` 方法
- 用于镇妖塔战斗

### 公式示例

| 攻击值 | 防御值 | 攻防差 | 计算过程 | 最终伤害 |
|--------|--------|--------|----------|----------|
| 1000 | 500 | 500 | 500 × 0.069 = 34.5 → 35 | 35 |
| 2000 | 1000 | 1000 | 1000 × 0.069 = 69 | 69 |
| 1500 | 1500 | 0 | 0 × 0.069 = 0 → 1（最小值） | 1 |
| 500 | 1000 | -500 | 固定伤害 | 5 |
| 100 | 200 | -100 | 固定伤害 | 5 |
| 3000 | 2000 | 1000 | 1000 × 0.069 = 69 | 69 |

### 测试验证

已创建测试文件 `test_damage_formula.py` 用于验证新公式的正确性。

运行测试：
```bash
python test_damage_formula.py
```

### 注意事项

1. **最小伤害保护**：所有伤害计算都有最小值保护，确保至少造成1点伤害
2. **四舍五入**：使用Python的 `round()` 函数进行四舍五入
3. **攻击类型**：自动识别物理攻击（物攻-物防）和法术攻击（法攻-法防）
4. **向后兼容**：旧的战斗引擎也已更新，确保所有系统使用统一公式

### 旧公式对比

#### 旧公式（已废弃）
- 正常情况：伤害 = (攻减防) × rand(0.069, 0.071) × 防御档位倍数
- 负数情况：根据差值绝对值分档，使用250~300或20~40的随机区间

#### 新公式（当前）
- 正常情况：伤害 = (攻减防) × 0.069（固定系数，四舍五入）
- 负数情况：固定5点伤害

### 优势

1. **简化计算**：去除了随机浮动和防御档位倍数，计算更简单直观
2. **结果可预测**：玩家可以准确计算战斗伤害，提升策略性
3. **平衡性更好**：固定系数避免了随机性带来的不公平
4. **统一标准**：所有战斗系统使用相同公式，便于维护

## 后续工作

- [x] 修改所有战斗引擎的伤害计算
- [x] 创建测试验证
- [ ] 更新游戏内帮助文档
- [ ] 通知玩家公式变更
- [ ] 观察平衡性，必要时调整系数
