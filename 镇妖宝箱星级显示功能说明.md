# 镇妖宝箱星级显示功能说明

## 功能概述

根据玩家等级，在背包中显示镇妖宝箱时会自动添加星级前缀，体现宝箱的价值等级。

## 星级规则

| 玩家等级 | 星级 | 试炼宝箱显示名称 | 炼狱宝箱显示名称 |
|---------|------|----------------|----------------|
| 30-39级 | 三星 | 三星试炼宝箱 | 三星炼狱宝箱 |
| 40-49级 | 四星 | 四星试炼宝箱 | 四星炼狱宝箱 |
| 50-59级 | 五星 | 五星试炼宝箱 | 五星炼狱宝箱 |
| 60-69级 | 六星 | 六星试炼宝箱 | 六星炼狱宝箱 |
| 70-79级 | 七星 | 七星试炼宝箱 | 七星炼狱宝箱 |
| 80级及以上 | 八星 | 八星试炼宝箱 | 八星炼狱宝箱 |

## 实现方式

### 1. 动态名称生成

宝箱的星级名称是在返回背包数据时**动态生成**的，而不是存储在数据库中。这样做的好处是：

- 玩家升级后，背包中的宝箱名称会自动更新
- 不需要修改物品模板配置
- 不需要在数据库中存储额外的星级信息

### 2. 修改的文件

#### `interfaces/routes/inventory_routes.py`

添加了两个辅助函数：

```python
def _get_chest_star_level(player_level: int) -> int:
    """根据玩家等级获取宝箱星级"""
    if player_level < 30:
        return 0
    elif player_level < 40:
        return 3
    elif player_level < 50:
        return 4
    elif player_level < 60:
        return 5
    elif player_level < 70:
        return 6
    elif player_level < 80:
        return 7
    else:
        return 8

def _get_star_prefix(star_level: int) -> str:
    """根据星级数字获取中文星级前缀"""
    star_map = {
        3: "三星",
        4: "四星",
        5: "五星",
        6: "六星",
        7: "七星",
        8: "八星",
    }
    return star_map.get(star_level, "")
```

修改了两个接口：

1. **`/api/inventory/list`** - 正式背包列表
2. **`/api/inventory/temp`** - 临时背包列表

在返回物品数据时，对镇妖宝箱（物品ID 92001 和 92002）进行特殊处理：

```python
# 动态生成镇妖宝箱的星级名称
item_name = item.item_info.name
if item.item_info.id in (92001, 92002):  # 试炼宝箱或炼狱宝箱
    star_level = _get_chest_star_level(player_level)
    star_prefix = _get_star_prefix(star_level)
    if star_prefix:
        item_name = f"{star_prefix}{item_name}"
```

## 显示效果

### 背包界面

玩家打开背包时，会看到：

- 35级玩家：**三星试炼宝箱**、**三星炼狱宝箱**
- 45级玩家：**四星试炼宝箱**、**四星炼狱宝箱**
- 55级玩家：**五星试炼宝箱**、**五星炼狱宝箱**
- 65级玩家：**六星试炼宝箱**、**六星炼狱宝箱**
- 75级玩家：**七星试炼宝箱**、**七星炼狱宝箱**
- 85级玩家：**八星试炼宝箱**、**八星炼狱宝箱**

### 临时背包

临时背包中的宝箱也会显示相应的星级前缀。

### 镇妖奖励提示

镇妖成功后的奖励提示也会显示星级：

```
镇妖成功！获得 三星试炼宝箱 x1
镇妖成功！获得 五星炼狱宝箱 x1
```

## 测试验证

### 测试脚本

```bash
python test_zhenyao_chest_star_display.py
```

### 测试结果

所有等级段的宝箱星级显示均正确：

- ✓ 35级玩家：三星试炼宝箱、三星炼狱宝箱
- ✓ 45级玩家：四星试炼宝箱、四星炼狱宝箱
- ✓ 55级玩家：五星试炼宝箱、五星炼狱宝箱
- ✓ 65级玩家：六星试炼宝箱、六星炼狱宝箱
- ✓ 75级玩家：七星试炼宝箱、七星炼狱宝箱
- ✓ 85级玩家：八星试炼宝箱、八星炼狱宝箱

## 注意事项

1. **星级是动态的**：玩家升级后，背包中的宝箱名称会自动更新为新的星级
2. **不影响物品ID**：宝箱的物品ID（92001和92002）保持不变
3. **不影响宝箱内容**：宝箱打开后的奖励内容由 `configs/zhenyao_rewards.json` 配置决定
4. **兼容性**：只影响显示名称，不影响其他功能

## 相关文件

### 修改的文件
- `interfaces/routes/inventory_routes.py` - 背包路由（添加星级显示逻辑）

### 测试文件
- `test_zhenyao_chest_star_display.py` - 星级显示测试脚本

### 配置文件
- `configs/items.json` - 物品模板配置（宝箱基础名称）
- `configs/zhenyao_rewards.json` - 镇妖奖励配置（宝箱内容）

### 相关服务
- `application/services/zhenyao_service.py` - 镇妖服务（发放宝箱）
- `application/services/inventory_service.py` - 背包服务（宝箱打开逻辑）

## 总结

镇妖宝箱星级显示功能已完整实现：

1. ✓ 根据玩家等级自动显示星级（三星~八星）
2. ✓ 使用中文数字显示星级（三、四、五、六、七、八）
3. ✓ 正式背包和临时背包都支持星级显示
4. ✓ 玩家升级后星级自动更新
5. ✓ 测试验证通过

玩家在背包中查看镇妖宝箱时，将根据自己的等级看到相应星级的宝箱名称，体现了等级差异和成就感。
