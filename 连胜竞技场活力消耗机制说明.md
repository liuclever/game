# 连胜竞技场活力消耗机制说明

## 需求
竞技没有达成6连胜之前消耗100活力，之后消耗15活力。

## 实现内容

### 1. 后端实现 (`interfaces/routes/arena_streak_routes.py`)

#### 活力消耗规则
- **未达成6连胜（max_streak_today < 6）：** 每次战斗消耗100活力
- **达成6连胜（max_streak_today >= 6）：** 每次战斗消耗15活力

#### 关键代码
```python
# 检查活力消耗
# 规则：未达成6连胜之前消耗100活力，达成6连胜之后消耗15活力
max_streak = record.get('max_streak_today', 0)
energy_cost = 15 if max_streak >= 6 else 100

current_energy = getattr(attacker, 'energy', 0) or 0
if current_energy < energy_cost:
    return jsonify({
        "ok": False, 
        "error": f"活力不足，需要{energy_cost}点活力（当前{current_energy}点）"
    })

# 扣除活力
attacker.energy = current_energy - energy_cost
services.player_repo.save(attacker)
```

#### 战斗结果提示
- 胜利：`"胜利！当前连胜{new_streak}次（消耗活力{energy_cost}点）"`
- 失败：`"失败！连胜归零（消耗活力{energy_cost}点）"`

### 2. 前端实现 (`interfaces/client/src/views/ArenaStreak.vue`)

#### 活力消耗显示
在"我的连胜"下方添加活力消耗提示：

```vue
<!-- 活力消耗提示 -->
<div class="section">
  战斗消耗活力: {{ energyCost }}点（{{ maxStreakToday >= 6 ? '已达成6连胜' : '未达成6连胜' }}）
</div>
```

#### 计算属性
```javascript
computed: {
  energyCost() {
    // 计算活力消耗：未达成6连胜之前消耗100活力，达成6连胜之后消耗15活力
    return this.maxStreakToday >= 6 ? 15 : 100;
  }
}
```

## 功能特点

### 1. 动态活力消耗
- ✅ 根据今日最高连胜次数动态计算活力消耗
- ✅ 达成6连胜后，活力消耗从100降低到15
- ✅ 鼓励玩家达成6连胜

### 2. 活力检查
- ✅ 战斗前检查活力是否充足
- ✅ 活力不足时提示需要的活力和当前活力
- ✅ 避免活力不足时扣除活力

### 3. 清晰的提示
- ✅ 前端显示当前活力消耗
- ✅ 显示是否已达成6连胜
- ✅ 战斗结果提示包含活力消耗信息

## 活力消耗规则详解

### 场景1：新玩家（未达成6连胜）
- 今日最高连胜：0-5次
- 每次战斗消耗：100活力
- 提示：`战斗消耗活力: 100点（未达成6连胜）`

### 场景2：达成6连胜
- 今日最高连胜：6次或以上
- 每次战斗消耗：15活力
- 提示：`战斗消耗活力: 15点（已达成6连胜）`

### 场景3：连胜归零后
- 即使当前连胜归零，只要今日最高连胜 >= 6
- 仍然只消耗15活力
- 这是基于"今日最高连胜"而非"当前连胜"

## 示例流程

### 示例1：从0连胜到6连胜
1. 初始状态：今日最高连胜 = 0
2. 第1次战斗：消耗100活力，胜利，当前连胜 = 1，今日最高 = 1
3. 第2次战斗：消耗100活力，胜利，当前连胜 = 2，今日最高 = 2
4. 第3次战斗：消耗100活力，胜利，当前连胜 = 3，今日最高 = 3
5. 第4次战斗：消耗100活力，胜利，当前连胜 = 4，今日最高 = 4
6. 第5次战斗：消耗100活力，胜利，当前连胜 = 5，今日最高 = 5
7. 第6次战斗：消耗100活力，胜利，当前连胜 = 6，今日最高 = 6
8. 第7次战斗：消耗15活力（已达成6连胜）

### 示例2：达成6连胜后失败
1. 当前状态：今日最高连胜 = 6，当前连胜 = 6
2. 下次战斗：消耗15活力，失败，当前连胜 = 0，今日最高 = 6
3. 再次战斗：消耗15活力（因为今日最高仍然是6）

## 设计理由

### 为什么基于"今日最高连胜"而非"当前连胜"？
1. **奖励玩家努力**：一旦达成6连胜，当天剩余时间都享受低活力消耗
2. **降低挫败感**：即使连胜归零，也不会回到高活力消耗
3. **鼓励持续参与**：达成6连胜后，玩家更愿意继续战斗

### 为什么是100和15？
- **100活力**：初期较高的消耗，限制无限制战斗
- **15活力**：达成6连胜后的奖励，与其他功能（如地图副本）的活力消耗相当
- **差距明显**：100 vs 15，让玩家明显感受到达成6连胜的好处

## 测试建议

### 测试场景1：未达成6连胜
1. 创建新账号或重置连胜记录
2. 确保活力 >= 100
3. 进行战斗
4. 验证：
   - 活力减少100点
   - 提示显示"消耗活力100点"
   - 前端显示"战斗消耗活力: 100点（未达成6连胜）"

### 测试场景2：达成6连胜
1. 连续胜利6次
2. 确保活力 >= 15
3. 进行第7次战斗
4. 验证：
   - 活力减少15点
   - 提示显示"消耗活力15点"
   - 前端显示"战斗消耗活力: 15点（已达成6连胜）"

### 测试场景3：活力不足
1. 将活力设置为50（< 100）
2. 尝试战斗（未达成6连胜）
3. 验证：
   - 提示"活力不足，需要100点活力（当前50点）"
   - 活力未被扣除
   - 战斗未进行

### 测试场景4：连胜归零后
1. 达成6连胜后
2. 故意失败一次（连胜归零）
3. 再次战斗
4. 验证：
   - 仍然只消耗15活力
   - 前端仍显示"战斗消耗活力: 15点（已达成6连胜）"

## 相关文件
- `interfaces/routes/arena_streak_routes.py` - 后端活力消耗逻辑
- `interfaces/client/src/views/ArenaStreak.vue` - 前端活力消耗显示

## 完成状态
✅ 后端活力消耗逻辑实现
✅ 前端活力消耗显示
✅ 活力检查和提示
✅ 文档编写

功能已完整实现，可以进行测试验证。
