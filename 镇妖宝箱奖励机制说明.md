# 镇妖宝箱奖励机制说明

## 验证时间
2026年1月18日

## 需求确认
镇妖成功后获得的试炼宝箱和炼狱宝箱，打开宝箱获得的结晶是七个结晶中的其中一个

## 功能验证

### 1. 宝箱类型

**试炼宝箱（物品ID: 92001）**
- 镇妖试炼层（1-60层）成功后获得
- 打开后获得：铜钱 + 活力草 + 随机结晶

**炼狱宝箱（物品ID: 92002）**
- 镇妖炼狱层（61-120层）成功后获得
- 打开后获得：铜钱 + 活力草 + 随机结晶 + 强力捕捉球 + 追魂法宝 + 灵力水晶

### 2. 结晶奖励机制

**七种结晶（物品ID: 1001-1007）：**
- 1001: 攻击结晶
- 1002: 防御结晶
- 1003: 速度结晶
- 1004: 气血结晶
- 1005: 法攻结晶
- 1006: 法防结晶
- 1007: 全能结晶

**随机机制：**
- 每次打开宝箱时，从7种结晶中**随机选择1种**
- 给予该种结晶 N 个（N 根据玩家等级决定）
- 例如：40级玩家打开试炼宝箱，会随机获得某一种结晶×4个

### 3. 奖励配置（按玩家等级）

#### 30-39级
**试炼宝箱：**
- 铜钱×100,000
- 活力草×1
- 随机结晶×3（从7种中随机选1种）

**炼狱宝箱：**
- 铜钱×100,000
- 活力草×1
- 随机结晶×3（从7种中随机选1种）
- 强力捕捉球×1
- 追魂法宝×1
- 灵力水晶×1

#### 40-49级
**试炼宝箱：**
- 铜钱×120,000
- 活力草×1
- 随机结晶×4

**炼狱宝箱：**
- 铜钱×120,000
- 活力草×1
- 随机结晶×4
- 强力捕捉球×1
- 追魂法宝×1
- 灵力水晶×1

#### 50-59级
**试炼宝箱：**
- 铜钱×140,000
- 活力草×2
- 随机结晶×5

**炼狱宝箱：**
- 铜钱×140,000
- 活力草×2
- 随机结晶×5
- 强力捕捉球×2
- 追魂法宝×2
- 灵力水晶×1

#### 60-69级
**试炼宝箱：**
- 铜钱×160,000
- 活力草×3
- 随机结晶×6

**炼狱宝箱：**
- 铜钱×160,000
- 活力草×3
- 随机结晶×6
- 强力捕捉球×2
- 追魂法宝×2
- 灵力水晶×1

#### 70-79级
**试炼宝箱：**
- 铜钱×180,000
- 活力草×4
- 随机结晶×7

**炼狱宝箱：**
- 铜钱×180,000
- 活力草×4
- 随机结晶×7
- 强力捕捉球×3
- 追魂法宝×3
- 灵力水晶×1

#### 80-100级
**试炼宝箱：**
- 铜钱×200,000
- 活力草×5
- 随机结晶×8

**炼狱宝箱：**
- 铜钱×200,000
- 活力草×5
- 随机结晶×8
- 强力捕捉球×4
- 追魂法宝×3
- 灵力水晶×1

### 4. 代码实现

**配置文件：** `configs/zhenyao_rewards.json`

**关键代码逻辑：** `application/services/inventory_service.py`

```python
# 打开宝箱时的奖励处理
for item_cfg in rewards_def.get("items", []):
    item_id = item_cfg.get("id")
    
    # 如果配置了pool（结晶池），从中随机选择一个
    if not item_id and "pool" in item_cfg:
        pool = item_cfg.get("pool") or []
        if pool:
            item_id = random.choice(pool)  # 从7种结晶中随机选1种
    
    if item_id:
        count = int(item_cfg.get("count", 1))  # 获得count个该结晶
        self.add_item(user_id, int(item_id), count)
```

**配置示例：**
```json
{
  "pool": [1001, 1002, 1003, 1004, 1005, 1006, 1007],
  "name": "七类结晶",
  "count": 3
}
```

这个配置表示：从7种结晶（1001-1007）中随机选择1种，给予3个。

### 5. 功能流程

1. **镇妖成功** → 获得试炼宝箱或炼狱宝箱（自动存入背包）
2. **打开宝箱** → 在背包中点击宝箱的"打开"按钮
3. **随机奖励** → 系统从7种结晶中随机选择1种
4. **发放奖励** → 给予该种结晶N个 + 其他固定奖励（铜钱、活力草等）
5. **显示结果** → 显示获得的所有奖励

### 6. 随机性说明

- **每次打开宝箱都是独立随机**：打开多个宝箱可能获得不同种类的结晶
- **概率均等**：7种结晶被选中的概率相同（各1/7）
- **数量固定**：选中某种结晶后，获得的数量由玩家等级决定（不随机）

### 7. 示例

**场景：** 40级玩家打开1个试炼宝箱

**可能结果1：**
- 铜钱×120,000
- 活力草×1
- 攻击结晶×4（从7种中随机到了攻击结晶）

**可能结果2：**
- 铜钱×120,000
- 活力草×1
- 速度结晶×4（从7种中随机到了速度结晶）

**场景：** 80级玩家打开1个炼狱宝箱

**可能结果：**
- 铜钱×200,000
- 活力草×5
- 全能结晶×8（从7种中随机到了全能结晶）
- 强力捕捉球×4
- 追魂法宝×3
- 灵力水晶×1

## 验证结论

✅ **功能已正确实现**

镇妖宝箱的结晶奖励机制完全符合需求：
1. 每次打开宝箱，从7种结晶中随机选择1种
2. 给予该种结晶N个（N根据玩家等级决定）
3. 配置文件正确设置了结晶池（1001-1007）
4. 代码逻辑正确实现了随机选择机制

## 相关文件

- `configs/zhenyao_rewards.json` - 镇妖宝箱奖励配置
- `application/services/inventory_service.py` - 宝箱打开逻辑
- `application/services/zhenyao_service.py` - 镇妖服务（发放宝箱）

## 测试建议

### 测试场景1：试炼宝箱随机性
1. 获得多个试炼宝箱（通过镇妖试炼层）
2. 逐个打开宝箱
3. 验证：每次获得的结晶种类可能不同
4. 验证：每次获得的结晶数量相同（根据等级）

### 测试场景2：炼狱宝箱随机性
1. 获得多个炼狱宝箱（通过镇妖炼狱层）
2. 逐个打开宝箱
3. 验证：每次获得的结晶种类可能不同
4. 验证：其他奖励（活力草、强力捕捉球等）数量固定

### 测试场景3：等级影响
1. 使用不同等级的账号（30级、50级、80级）
2. 打开相同类型的宝箱
3. 验证：等级越高，获得的结晶数量越多
4. 验证：结晶种类仍然是随机的

## 注意事项

1. **结晶种类随机，数量固定**：每次打开宝箱获得的结晶种类是随机的，但数量由玩家等级决定
2. **独立随机**：每次打开宝箱都是独立的随机事件，不受之前结果影响
3. **配置灵活**：可以通过修改 `zhenyao_rewards.json` 调整奖励内容和数量
4. **pool机制通用**：这个随机池机制也可以用于其他需要随机奖励的场景
