# 镇妖界面修复说明

## 修改日期
2026年1月18日

## 问题描述

1. **镇妖符数量显示问题**：镇妖界面显示固定的125个镇妖符，没有显示背包里的实时数量
2. **"镇妖"文字位置问题**："镇妖"两字出现在镇妖界面标题，但应该只出现在通天塔界面

## 修改内容

### 1. 后端修改

#### interfaces/routes/tower_routes.py

**修改接口**：`/api/zhenyao/info`

**变更内容**：
- 在返回数据中添加 `zhenyao_fu_count` 字段
- 该字段从背包实时查询镇妖符（物品ID: 6001）的数量

**修改代码**：
```python
@tower_bp.get("/zhenyao/info")
def get_zhenyao_info():
    # ... 省略其他代码 ...
    
    # 获取背包中的实时镇妖符数量
    zhenyao_fu_count = 0
    try:
        from infrastructure.db.connection import execute_query
        inv_rows = execute_query(
            "SELECT quantity FROM player_inventory WHERE user_id = %s AND item_id = %s",
            (user_id, ZHENYAO_FU_ITEM_ID)
        )
        if inv_rows:
            zhenyao_fu_count = inv_rows[0].get('quantity', 0)
    except Exception:
        zhenyao_fu_count = 0
    
    return jsonify({
        # ... 省略其他字段 ...
        "zhenyao_fu_count": zhenyao_fu_count,  # 添加实时镇妖符数量
    })
```

### 2. 前端修改

#### interfaces/client/src/features/tower/ZhenYaoPage.vue

**修改1：简化镇妖符数量获取逻辑**

**变更前**：
- 前端通过 `loadZhenyaoFuCount()` 函数单独调用 `/inventory/item-count` 接口
- 使用 `Promise.all` 并行加载镇妖信息和镇妖符数量

**变更后**：
- 直接使用后端 `/zhenyao/info` 接口返回的 `zhenyao_fu_count` 字段
- 删除了 `loadZhenyaoFuCount()` 函数
- 删除了 `ZHENYAO_FU_ITEM_ID` 常量

**修改代码**：
```javascript
// 加载镇妖信息
const loadZhenyaoInfo = async () => {
  try {
    const zhenyaoRes = await http.get('/zhenyao/info')
    
    zhenyaoInfo.value = {
      // ... 省略其他字段 ...
      zhenyaoFu: zhenyaoRes.data.zhenyao_fu_count || 0,  // 使用后端返回的实时数量
    }
  } catch (e) {
    console.error('加载镇妖信息失败', e)
    error.value = '加载失败'
  }
}
```

**修改2：更改页面标题**

**变更前**：
```html
<div class="section title">
  【镇妖】 <a class="link" @click="handleLink('简介')">简介</a> |<a class="link" @click="handleLink('刷新结算')">刷新结算</a>
</div>
```

**变更后**：
```html
<div class="section title">
  【聚魂阵】 <a class="link" @click="handleLink('简介')">简介</a> |<a class="link" @click="handleLink('刷新结算')">刷新结算</a>
</div>
```

**说明**：将标题从"镇妖"改为"聚魂阵"，因为"镇妖"两字应该只出现在通天塔界面的按钮上。

### 3. 通天塔界面确认

#### interfaces/client/src/features/tower/TowerPage.vue

**确认内容**：
- 通天塔界面已经有"镇妖"按钮
- 位置：在"自动闯塔"按钮旁边
- 代码：`<a v-if="currentTower === 'tongtian'" class="link suppress-btn" @click="suppress">镇妖</a>`

**无需修改**：该文件已经正确显示"镇妖"按钮

## 修改效果

### 修改前
1. 镇妖界面显示固定的"镇妖符×125"
2. 镇妖界面标题显示"【镇妖】"

### 修改后
1. 镇妖界面显示实时的镇妖符数量，例如"镇妖符×50"（根据背包实际数量）
2. 镇妖界面标题显示"【聚魂阵】"
3. "镇妖"两字只出现在通天塔界面的按钮上

## 技术细节

### 镇妖符物品ID
- 物品ID：6001
- 物品名称：镇妖符
- 存储位置：`player_inventory` 表

### 数据流程

**修改前**：
```
前端 → /zhenyao/info → 获取基本信息
前端 → /inventory/item-count?item_id=6001 → 获取镇妖符数量
前端 → 合并数据 → 显示
```

**修改后**：
```
前端 → /zhenyao/info → 获取基本信息 + 镇妖符数量
前端 → 直接显示
```

### 优势
1. **减少请求次数**：从2个请求减少到1个请求
2. **提高性能**：减少网络往返时间
3. **简化代码**：前端代码更简洁
4. **实时准确**：每次刷新都从数据库获取最新数量

## 测试建议

### 测试场景1：镇妖符数量显示
1. 登录游戏
2. 进入镇妖界面
3. 检查显示的镇妖符数量是否与背包中的数量一致
4. 使用镇妖符（占领或挑战）
5. 点击"刷新结算"
6. 检查镇妖符数量是否正确减少

### 测试场景2：标题显示
1. 进入通天塔界面
2. 检查是否有"镇妖"按钮
3. 点击"镇妖"按钮进入镇妖界面
4. 检查镇妖界面标题是否显示"【聚魂阵】"而不是"【镇妖】"

### 测试场景3：边界情况
1. 镇妖符数量为0时的显示
2. 镇妖符数量很大时的显示（如999+）
3. 网络错误时的处理

## 相关文件

### 修改的文件
- `interfaces/routes/tower_routes.py` - 后端路由
- `interfaces/client/src/features/tower/ZhenYaoPage.vue` - 前端镇妖页面

### 相关文件（未修改）
- `interfaces/client/src/features/tower/TowerPage.vue` - 通天塔页面
- `application/services/zhenyao_service.py` - 镇妖服务
- `application/services/inventory_service.py` - 背包服务

## 注意事项

1. **镇妖符消耗**：试炼层免费，炼狱层消耗1个镇妖符
2. **数据一致性**：确保背包中的镇妖符数量与实际消耗同步
3. **缓存问题**：前端不缓存镇妖符数量，每次都从后端获取最新值
4. **错误处理**：如果查询失败，默认显示0个镇妖符

## 后续优化建议

1. **添加镇妖符购买入口**：在镇妖界面添加"购买镇妖符"链接，跳转到商城
2. **添加镇妖符获取提示**：当镇妖符不足时，提示玩家如何获取
3. **优化刷新机制**：占领或挑战后自动刷新镇妖符数量，无需手动点击"刷新结算"
4. **添加动画效果**：镇妖符数量变化时添加动画提示

---

**修改完成时间**：2026年1月18日  
**修改人员**：Kiro AI Assistant  
**版本**：v1.0
