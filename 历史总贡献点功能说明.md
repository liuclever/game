# 历史总贡献点功能说明

## 功能概述

联盟成员的贡献点分为两个值：
- **现有贡献点** (`contribution`): 当前可用的贡献点，可以消耗
- **历史总贡献点** (`total_contribution`): 累计获得的所有贡献点，只增不减

## 显示格式

在"我的联盟"页面显示为：`贡献: 现有贡献点/历史总贡献点`

例如：`贡献: 15/25` 表示：
- 现有贡献点：15（可以消耗）
- 历史总贡献点：25（累计获得的总数，不会减少）

## 工作原理

### 增加贡献点（捐赠）
- 现有贡献点增加
- 历史总贡献点同时增加相同的数量
- 例如：捐赠获得 10 点贡献 → 现有贡献点 +10，历史总贡献点 +10

### 减少贡献点（消耗）
- 现有贡献点减少
- **历史总贡献点保持不变**（只增不减）
- 例如：消耗 5 点贡献 → 现有贡献点 -5，历史总贡献点不变

## 数据修复

如果发现历史总贡献点被错误地设置为与现有贡献点相同，可以执行修复脚本：

```bash
python run_migration.py sql/043_fix_total_contribution.sql
```

## 测试

运行测试脚本验证功能：

```bash
python test_alliance_contribution.py
```

## 注意事项

1. **历史总贡献点只增不减**：即使消耗贡献点，历史总贡献点也不会减少
2. **历史总贡献点 >= 现有贡献点**：历史总贡献点应该始终大于或等于现有贡献点
3. **如果两个数字相同**：可能是用户从未消耗过贡献点（正常情况），或者数据被错误初始化

## 常见问题

### Q: 为什么历史总贡献点会减少？
A: 这不应该发生。如果发生了，可能是：
1. 数据库被直接修改（不应该这样做）
2. 有其他地方在更新 `total_contribution`（需要检查代码）
3. 迁移脚本执行时初始化错误

### Q: 为什么两个数字相同？
A: 可能的原因：
1. 用户从未消耗过贡献点（正常情况）
2. 迁移脚本初始化时将 `total_contribution` 设置为 `contribution` 的值
3. 如果用户消耗过贡献点，但两个数字仍然相同，说明数据有问题

### Q: 如何修复数据？
A: 执行修复脚本：
```bash
python run_migration.py sql/043_fix_total_contribution.sql
```
