# 地图副本挑战问题诊断指南

## 问题描述
用户反馈：地图副本挑战功能玩不了

## 可能的原因

### 1. 没有出战幻兽
**症状：** 点击"挑战幻兽"后提示"你没有出战幻兽，请先在幻兽仓库设置出战"

**解决方法：**
1. 进入游戏的【幻兽】页面
2. 点击任意幻兽
3. 点击【出战】按钮
4. 至少需要1只出战幻兽才能挑战副本

### 2. 骰子不足
**症状：** 无法点击"前进"按钮，或提示"骰子不足"

**解决方法：**
1. 在副本页面点击【补充】按钮
2. 使用骰子包（物品ID: 6010）
3. 每个骰子包可获得10个骰子
4. 也可以通过商城购买骰子包

### 3. 活力不足
**症状：** 无法开启战利品，提示"活力不足"

**说明：**
- 挑战幻兽本身**不消耗活力**（免费）
- 只有开启战利品时才需要15点活力
- 如果活力不足，可以选择"继续前进"跳过战利品

**获取活力的方法：**
1. 使用活力草（物品ID: 4001）
2. 等待自然恢复（每小时恢复一定活力）
3. VIP特权可以提升活力上限

### 4. 副本进度异常
**症状：** 进入副本后显示异常，或无法挑战

**解决方法：**
1. 尝试重置副本（点击副本页面的"重置"按钮）
2. 重置需要消耗200元宝
3. 每日最多重置5次

### 5. 浏览器缓存问题
**症状：** 页面显示不正常，或功能无响应

**解决方法：**
1. 按 Ctrl+F5 强制刷新页面
2. 清除浏览器缓存
3. 尝试使用无痕模式

### 6. 网络连接问题
**症状：** 点击按钮后长时间无响应，或提示"网络错误"

**解决方法：**
1. 检查网络连接是否正常
2. 检查后端服务是否正常运行
3. 查看浏览器控制台（F12）是否有错误信息

## 诊断工具

我们提供了一个诊断脚本来帮助快速定位问题：

### 使用方法

```bash
python diagnose_dungeon_challenge.py
```

### 诊断内容

脚本会自动检查：
1. ✅ 玩家是否有出战幻兽
2. ✅ 副本进度是否正常
3. ✅ 副本配置是否正确
4. ✅ 活力值是否充足
5. ✅ 骰子数量是否足够

### 示例输出

```
============================================================
地图副本挑战功能诊断工具
============================================================

请输入要检查的玩家ID（直接回车使用默认ID 1）: 1

开始诊断玩家 1 的副本挑战功能...

检查玩家 1 的出战幻兽...
✅ 找到 2 只出战幻兽：
   - 火焰狮 (等级15, 凡境)
   - 冰霜狼 (等级12, 凡境)

检查玩家 1 的副本进度...
✅ 找到 3 个副本进度：
   - 森林入口: 第5层 (已通关, 战利品已领取, 骰子×8)
   - 宁静之森: 第3层 (未通关, 战利品未领取, 骰子×5)

检查副本配置...
✅ 找到 17 个副本配置
   - 森林入口: 10层
   - 宁静之森: 10层
   - 森林秘境: 15层

检查玩家 1 的活力值...
✅ 当前活力: 120/190

检查玩家 1 的骰子...
✅ 【森林入口】骰子数量: 8

============================================================
诊断总结
============================================================
出战幻兽: ✅ 通过
副本进度: ✅ 通过
副本配置: ✅ 通过
活力值: ✅ 通过
骰子数量: ✅ 通过

✅ 所有检查通过！副本挑战功能应该可以正常使用。
```

## 常见问题解答

### Q1: 为什么点击"挑战幻兽"没有反应？
**A:** 可能的原因：
1. 没有出战幻兽 → 去幻兽页面设置出战
2. 浏览器JavaScript错误 → 按F12查看控制台
3. 网络请求失败 → 检查后端服务是否运行

### Q2: 为什么无法前进到下一层？
**A:** 可能的原因：
1. 骰子不足 → 点击"补充"按钮获取骰子
2. 当前层未通关 → 先挑战并击败当前层的幻兽
3. 有未领取的战利品 → 先领取或跳过战利品

### Q3: 挑战幻兽需要消耗什么？
**A:** 
- 挑战幻兽本身**不消耗任何资源**（免费）
- 前进需要消耗骰子（每次1个）
- 开启战利品需要消耗活力（15点）或双倍卡（1张）

### Q4: 如何获得更多骰子？
**A:** 
1. 使用骰子包（物品ID: 6010），每个获得10个骰子
2. 在副本页面点击"补充"按钮
3. 通过商城购买骰子包
4. 完成任务可能获得骰子包奖励

### Q5: 战利品必须领取吗？
**A:** 
- 不是必须的
- 如果活力不足或不想领取，可以点击"继续前进"跳过
- 跳过后战利品会消失，无法再领取

### Q6: 副本重置有什么用？
**A:** 
- 重置后可以重新挑战副本，获得更多奖励
- 每日免费挑战1次，后续需要重置
- 每次重置消耗200元宝
- 每日最多重置5次

## 技术细节

### 副本挑战流程

1. **进入副本** → 自动创建进度记录，赠送初始骰子
2. **扔骰子前进** → 消耗1个骰子，前进N层（N=骰子点数）
3. **遇到幻兽** → 点击"挑战幻兽"进入战斗
4. **战斗结算** → 胜利后标记当前层已通关，掉落战利品
5. **领取战利品** → 消耗15活力或1双倍卡，获得奖励
6. **继续前进** → 重复步骤2-5，直到通关或失败

### API端点

- `GET /api/dungeon/progress` - 获取副本进度
- `POST /api/dungeon/advance` - 前进（扔骰子）
- `POST /api/dungeon/challenge` - 挑战幻兽
- `POST /api/dungeon/loot/open` - 开启战利品
- `POST /api/dungeon/reset` - 重置副本
- `GET /api/dungeon/floor/beasts` - 获取当前层幻兽信息

### 数据库表

- `player_dungeon_progress` - 副本进度表
- `player_beasts` - 玩家幻兽表（is_in_team字段标记出战）
- `players` - 玩家表（energy字段存储活力值）

## 联系支持

如果按照上述方法仍然无法解决问题，请提供以下信息：

1. 玩家ID
2. 具体的错误提示
3. 浏览器控制台的错误信息（F12 -> Console标签）
4. 网络请求的响应内容（F12 -> Network标签）
5. 诊断脚本的输出结果

## 相关文件

- `diagnose_dungeon_challenge.py` - 诊断脚本
- `interfaces/routes/dungeon_routes.py` - 副本路由（后端）
- `interfaces/client/src/features/dungeon/DungeonChallengePage.vue` - 副本挑战页面（前端）
- `configs/dungeons.json` - 副本配置文件
