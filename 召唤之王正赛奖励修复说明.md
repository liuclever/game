# 召唤之王正赛奖励修复说明

## 问题描述

用户反馈：测试账号未参加正赛，但可以领取正赛亚军礼包。

## 问题原因

原代码中，正赛奖励的判定逻辑错误地基于**预赛排名**（`king_challenge_rank.rank_position`），而不是**正赛成绩**（`king_final_stage` 表）。

### 错误逻辑示例

```python
# 错误：根据预赛排名判定正赛奖励
rank_rows = execute_query(
    "SELECT rank_position FROM king_challenge_rank WHERE user_id = %s",
    (user_id,)
)
my_rank = rank_rows[0]['rank_position']

if my_rank == 1:
    reward_tier = KING_FINAL_REWARDS["champion"]  # 错误！
elif my_rank == 2:
    reward_tier = KING_FINAL_REWARDS["runner_up"]  # 错误！
```

这导致：
- 预赛排名第1的玩家可以领取冠军奖励（即使未参加正赛）
- 预赛排名第2的玩家可以领取亚军奖励（即使未参加正赛）
- 预赛排名3-4的玩家可以领取4强奖励（即使未参加正赛）
- 以此类推...

## 修复方案

### 1. 修改奖励信息接口 (`GET /api/king/reward_info`)

**修复逻辑**：
1. 查询 `king_final_stage` 表，获取玩家在本赛季的正赛记录
2. 如果没有正赛记录，返回"未参加正赛，无法领取奖励"
3. 如果有正赛记录，根据最佳阶段判定奖励等级

**奖励判定规则**：
- `stage = 'champion'` 且 `is_winner = 1` → 冠军奖励
- `stage = 'champion'` 且 `is_winner = 0` → 亚军奖励
- `stage = '2'` → 4强奖励（进入半决赛）
- `stage = '4'` → 8强奖励（进入8进4）
- `stage = '8'` → 16强奖励（进入16进8）
- `stage = '16'` 或 `'32'` → 32强奖励（进入32进16或64进32）

### 2. 修改领取奖励接口 (`POST /api/king/claim_reward`)

**修复逻辑**：
1. 查询 `king_final_stage` 表，获取玩家的正赛成绩
2. 如果没有正赛记录，返回错误："未参加正赛，无法领取奖励"
3. 根据正赛成绩判定奖励配置
4. 检查是否已领取
5. 发放奖励并记录

## 修复后的效果

### 场景1：未参加正赛的玩家
- **预赛排名**：第1名
- **正赛记录**：无
- **结果**：❌ 不能领取任何奖励
- **提示**："未参加正赛，无法领取奖励"

### 场景2：进入32强的玩家
- **预赛排名**：第10名
- **正赛记录**：进入64进32（`stage='32'`）
- **结果**：✓ 可以领取32强奖励
- **奖励**：50000铜钱 + 物品

### 场景3：进入决赛但失败的玩家
- **预赛排名**：第1名
- **正赛记录**：进入决赛但失败（`stage='champion'`, `is_winner=0`）
- **结果**：✓ 可以领取亚军奖励
- **奖励**：350000铜钱 + 物品

### 场景4：冠军玩家
- **预赛排名**：第1名
- **正赛记录**：决赛获胜（`stage='champion'`, `is_winner=1`）
- **结果**：✓ 可以领取冠军奖励
- **奖励**：450000铜钱 + 物品

## 数据库表说明

### king_challenge_rank（预赛排名表）
- 记录玩家在预赛中的排名和战绩
- **不应该**用于判定正赛奖励

### king_final_stage（正赛阶段表）
- 记录玩家在正赛各阶段的参赛情况
- 字段：
  - `season`: 赛季编号
  - `user_id`: 玩家ID
  - `stage`: 阶段（'32', '16', '8', '4', '2', 'champion'）
  - `is_winner`: 是否获胜（1=胜, 0=负, NULL=未比赛）
  - `is_bye`: 是否轮空（1=轮空晋级）
  - `opponent_id`: 对手ID
  - `match_id`: 比赛场次
- **应该**用于判定正赛奖励

### king_reward_claimed（奖励领取记录表）
- 记录玩家已领取的奖励
- 防止重复领取

## 测试验证

### 测试脚本
```bash
python test_king_final_reward_fix.py
```

### 测试内容
1. 检查正赛记录
2. 检查玩家奖励资格
3. 模拟各种场景的奖励判定

### 预期结果
- 未参加正赛的玩家无法领取奖励
- 只有参加正赛并取得成绩的玩家才能领取对应奖励
- 奖励等级与正赛成绩匹配

## 历史数据处理

### 已错误领取的奖励
从测试结果看，有2个玩家已经错误地领取了奖励：
- 玩家 "456"：预赛第2名，未参加正赛，但已领取奖励
- 玩家 "但就是"：预赛第2名，未参加正赛，但已领取奖励

### 处理建议
1. **不追溯**：已发放的奖励不回收（避免影响玩家体验）
2. **记录日志**：记录这次修复，作为系统优化的一部分
3. **未来防范**：修复后的逻辑将防止此类问题再次发生

## 正赛流程说明

### 完整流程
1. **周一**：报名
2. **周二至周六**：预赛（排名挑战）
3. **周五**：正赛开始
   - 12:00 - 64进32
   - 13:00 - 32进16
   - 14:00 - 16进8
   - 15:00 - 8进4
   - 16:00 - 半决赛
   - 17:00 - 决赛
4. **周日**：领取奖励

### 正赛参赛资格
- 预赛排名前32名的玩家自动进入正赛
- 系统自动安排对阵
- 按时间自动进行战斗

### 奖励领取
- 只有参加正赛并取得成绩的玩家才能领取奖励
- 每个赛季只能领取一次
- 奖励等级取决于正赛最佳成绩

## 相关文件

### 后端
- `interfaces/routes/king_routes.py` - 主要修改文件
  - `get_king_reward_info()` - 奖励信息接口
  - `claim_king_reward()` - 领取奖励接口

### 测试
- `test_king_final_reward_fix.py` - 奖励修复验证脚本

### 数据库
- `king_challenge_rank` - 预赛排名表
- `king_final_stage` - 正赛阶段表
- `king_reward_claimed` - 奖励领取记录表

## 总结

这次修复解决了正赛奖励判定逻辑错误的问题，确保：
1. ✓ 只有参加正赛的玩家才能领取奖励
2. ✓ 奖励等级与正赛成绩匹配
3. ✓ 预赛排名不影响正赛奖励
4. ✓ 防止未参赛玩家领取奖励

修复后，召唤之王挑战赛的奖励系统将更加公平合理。
