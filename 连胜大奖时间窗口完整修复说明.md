# 连胜大奖时间窗口完整修复说明

## 问题描述
连胜竞技场功能中，连胜大奖无法正确领取。原有逻辑存在以下问题：
1. 没有时间窗口限制（任何时间都可以领取）
2. 领取的是当天的大奖（应该是前一天的）
3. 没有过期机制

## 需求规则
按照正确的领取逻辑：
- **领取时间窗口**：每天00:00-08:00
- **领取资格**：前一天全服连胜次数最多的玩家
- **过期机制**：超过08:00后无法领取
- **示例**：1月12日的连胜王，可以在1月13日00:00-08:00领取大奖

## 修复内容

### 1. 后端修复 (`interfaces/routes/arena_streak_routes.py`)

#### 1.1 修改 `claim_grand_prize()` 函数
```python
# 添加时间窗口检查
if current_hour >= 8:
    return jsonify({"ok": False, "error": "连胜大奖领取时间为每天00:00-08:00，当前已过期"})

# 改为查询和领取前一天的大奖
yesterday = today - timedelta(days=1)
streak_king = execute_query(
    """SELECT user_id, max_streak_today 
       FROM arena_streak 
       WHERE record_date = %s 
       ORDER BY max_streak_today DESC LIMIT 1""",
    (yesterday,)  # 查询前一天
)

# 检查前一天的领取状态
yesterday_record = execute_query(
    """SELECT claimed_grand_prize 
       FROM arena_streak 
       WHERE user_id = %s AND record_date = %s""",
    (user_id, yesterday)  # 查询前一天
)

# 更新前一天的记录
execute_update(
    "UPDATE arena_streak SET claimed_grand_prize = 1 WHERE user_id = %s AND record_date = %s",
    (user_id, yesterday)  # 更新前一天
)
```

#### 1.2 修改 `get_info()` 函数
新增以下字段供前端使用：
```python
# 获取昨日连胜王信息
yesterday = today - timedelta(days=1)
yesterday_king = execute_query(
    """SELECT p.user_id, p.nickname, a.max_streak_today, a.claimed_grand_prize 
       FROM arena_streak a 
       JOIN player p ON a.user_id = p.user_id 
       WHERE a.record_date = %s 
       ORDER BY a.max_streak_today DESC LIMIT 1""",
    (yesterday,)
)

# 判断当前用户是否是昨日连胜王
is_yesterday_king = False
yesterday_claimed = True
if yesterday_king:
    is_yesterday_king = yesterday_king[0]['user_id'] == user_id
    yesterday_claimed = yesterday_king[0].get('claimed_grand_prize', 0) == 1

# 判断是否在大奖领取时间窗口内（00:00-08:00）
current_hour = now.hour
can_claim_grand_prize = is_yesterday_king and not yesterday_claimed and current_hour < 8

# 返回新增字段
return jsonify({
    # ... 原有字段 ...
    "yesterday_king": {
        "user_id": yesterday_king[0]['user_id'] if yesterday_king else None,
        "nickname": yesterday_king[0]['nickname'] if yesterday_king else "暂无",
        "streak": yesterday_king[0]['max_streak_today'] if yesterday_king else 0
    },
    "is_yesterday_king": is_yesterday_king,
    "can_claim_grand_prize": can_claim_grand_prize,
    "grand_prize_time_window": "00:00-08:00",
    "current_hour": current_hour
})
```

### 2. 前端修复 (`interfaces/client/src/views/ArenaStreak.vue`)

#### 2.1 新增数据字段
```javascript
data() {
  return {
    // ... 原有字段 ...
    yesterdayKing: { nickname: '暂无', streak: 0 },  // 昨日连胜王
    isYesterdayKing: false,                          // 是否是昨日连胜王
    canClaimGrandPrize: false,                       // 是否可以领取大奖
    grandPrizeTimeWindow: '00:00-08:00',             // 领取时间窗口
    currentHour: 0,                                  // 当前小时
  };
}
```

#### 2.2 更新 `loadInfo()` 函数
```javascript
async loadInfo() {
  const res = await axios.get('/api/arena-streak/info');
  if (res.data.ok) {
    // ... 原有字段 ...
    this.yesterdayKing = res.data.yesterday_king || { nickname: '暂无', streak: 0 };
    this.isYesterdayKing = res.data.is_yesterday_king || false;
    this.canClaimGrandPrize = res.data.can_claim_grand_prize || false;
    this.grandPrizeTimeWindow = res.data.grand_prize_time_window || '00:00-08:00';
    this.currentHour = res.data.current_hour || 0;
  }
}
```

#### 2.3 更新模板显示
```vue
<!-- 显示昨日连胜王 -->
<div class="section" v-if="yesterdayKing.user_id">
  昨日连胜王: <a class="link username" @click="viewPlayer(yesterdayKing.user_id)">{{ yesterdayKing.nickname }}</a> - {{ yesterdayKing.streak }}连胜
</div>

<!-- 更新大奖领取按钮逻辑 -->
<div class="section">
  <div class="section indent">
    连胜大奖（昨日连胜王专属，领取时间{{ grandPrizeTimeWindow }}）: 铜钱60万+追魂法宝1+金袋5+招财神符1. 
    <a class="link" @click="claimGrandPrize" v-if="canClaimGrandPrize">领取</a>
    <span v-else-if="isYesterdayKing && currentHour >= 8">[已过期]</span>
    <span v-else-if="isYesterdayKing && !canClaimGrandPrize">[已领取]</span>
    <span v-else-if="!isYesterdayKing">[仅昨日连胜王可领取]</span>
  </div>
</div>
```

#### 2.4 更新 `claimGrandPrize()` 函数
```javascript
async claimGrandPrize() {
  const res = await axios.post('/api/arena-streak/claim-grand-prize');
  if (res.data.ok) {
    this.canClaimGrandPrize = false;  // 更新为不可领取
    // 重新加载信息以更新状态
    await this.loadInfo();
    // ... 显示成功消息 ...
  }
}
```

#### 2.5 移除旧的 `isStreakKing` 计算属性
不再需要检查当前用户是否是今日连胜王，改为使用后端返回的 `is_yesterday_king` 和 `can_claim_grand_prize` 字段。

## 测试验证

### 测试脚本
运行 `python test_grand_prize_time_window.py` 可以查看：
- 当前时间和昨日连胜王信息
- 是否在领取时间窗口内（00:00-08:00）
- 大奖领取状态
- 模拟不同时间的领取状态

### 测试场景
1. **00:00-08:00 时间段**
   - 昨日连胜王可以看到"领取"按钮
   - 点击后成功领取大奖
   - 领取后按钮变为"[已领取]"

2. **08:00 之后**
   - 昨日连胜王看到"[已过期]"提示
   - 无法领取大奖
   - 后端返回错误："连胜大奖领取时间为每天00:00-08:00，当前已过期"

3. **非昨日连胜王**
   - 显示"[仅昨日连胜王可领取]"
   - 无法点击领取按钮

## 部署步骤

1. **重启后端服务**
   ```bash
   python start-backend.bat
   ```

2. **重新编译前端**（如果前端有修改）
   ```bash
   cd interfaces/client
   npm run build
   ```

3. **强制刷新浏览器**
   - 按 Ctrl+F5 清除缓存并刷新

## 注意事项

1. **时区问题**：所有时间判断使用服务器本地时间（中国时区 UTC+8）
2. **数据库记录**：大奖领取状态记录在前一天的 `arena_streak` 记录中
3. **过期机制**：超过08:00后，即使是昨日连胜王也无法领取
4. **唯一性**：每天只有一个昨日连胜王，且只能领取一次

## 修复文件清单

- `interfaces/routes/arena_streak_routes.py` - 后端路由逻辑
- `interfaces/client/src/views/ArenaStreak.vue` - 前端页面
- `test_grand_prize_time_window.py` - 测试脚本
- `连胜大奖时间窗口完整修复说明.md` - 本文档

## 完成时间
2026年1月26日
