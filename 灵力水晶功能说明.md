# 灵力水晶功能说明

## 功能概述

灵力水晶是一种消耗道具，使用后可以获得灵力。灵力用于洗练战灵的属性条，重新随机战灵的属性值。

## 道具信息

- **道具ID**: 6101
- **道具名称**: 灵力水晶
- **道具类型**: 消耗品
- **使用效果**: 1个灵力水晶 = 10灵力

## 获取途径

1. **镇妖宝箱**: 镇妖成功后有概率获得炼狱宝箱，开启可获得灵力水晶
2. **战灵塔**: 闯塔过程中有概率掉落灵力水晶
3. **签到奖励**: 
   - 第7天奖励：灵力水晶×1
   - 第30天奖励：灵力水晶×1
4. **老玩家回馈礼包**: 包含灵力水晶×1

## 使用方法

### 方法1：背包直接使用
1. 打开背包
2. 找到灵力水晶
3. 点击"使用"按钮
4. 自动跳转到灵力水晶使用页面
5. 选择使用数量
6. 点击"确定使用"

### 方法2：战灵页面使用
1. 前往战灵页面
2. 点击"使用灵力水晶"（如果有的话）
3. 选择使用数量
4. 确认使用

## 使用页面功能

### 显示信息
- 拥有灵力水晶数量
- 当前灵力值
- 使用规则说明

### 操作功能
- 输入使用数量
- 快捷选择：1个、10个、50个、全部
- 显示可获得的灵力
- 确定使用按钮

### 使用后
- 扣除对应数量的灵力水晶
- 增加对应的灵力值
- 显示使用结果

## 灵力用途

灵力主要用于战灵系统的洗练功能：

### 洗练消耗
根据战灵元素和锁定词条数量，洗练消耗不同：

| 元素 | 0条锁定 | 1条锁定 | 2条锁定 |
|------|---------|---------|---------|
| 土灵 | 1灵力   | 3灵力   | 9灵力   |
| 火灵 | 2灵力   | 6灵力   | 18灵力  |
| 水灵 | 3灵力   | 9灵力   | 27灵力  |
| 木灵 | 4灵力   | 12灵力  | 36灵力  |
| 金灵 | 5灵力   | 15灵力  | 45灵力  |
| 神灵 | 10灵力  | 30灵力  | 90灵力  |

### 洗练效果
- 重新随机战灵的属性值
- 可以锁定已满意的属性条（消耗战灵钥匙）
- 锁定的属性条不会被重新随机

## 实现细节

### 后端接口

#### 使用灵力水晶
- **接口**: `POST /api/spirit/consume-crystal`
- **参数**: 
  - `quantity`: 使用数量（默认1，最多10）
- **返回**:
  ```json
  {
    "ok": true,
    "gained_spirit_power": 10,
    "used_crystals": 1,
    "account": {
      "spirit_power": 100,
      ...
    }
  }
  ```

#### 获取战灵账户信息
- **接口**: `GET /api/spirit/account`
- **返回**: 包含当前灵力值等信息

### 前端页面

#### 灵力水晶使用页面
- **路径**: `/spirit/crystal-use`
- **组件**: `SpiritCrystalUsePage.vue`
- **功能**:
  - 显示拥有的灵力水晶数量
  - 显示当前灵力值
  - 输入使用数量
  - 快捷选择按钮
  - 显示可获得灵力
  - 确定使用按钮

#### 路由配置
```javascript
{
  path: '/spirit/crystal-use',
  name: 'SpiritCrystalUse',
  component: SpiritCrystalUsePage,
}
```

#### 物品使用路由
```javascript
// itemUseRoutes.js
6101: '/spirit/crystal-use',  // 灵力水晶
```

### 数据库

#### player 表
- 无需修改，灵力存储在 `spirit_account` 表中

#### spirit_account 表
- `spirit_power`: 灵力值（INT）

#### inventory 表
- 存储灵力水晶物品（item_id=6101）

## 使用流程

```
用户在背包点击灵力水晶
    ↓
跳转到灵力水晶使用页面
    ↓
显示当前拥有数量和灵力值
    ↓
用户选择使用数量
    ↓
点击确定使用
    ↓
调用后端接口 /api/spirit/consume-crystal
    ↓
后端扣除灵力水晶，增加灵力
    ↓
返回使用结果
    ↓
前端显示成功提示，刷新数据
```

## 测试验证

### 测试脚本
```bash
python test_spirit_crystal.py
```

### 测试内容
1. 检查背包中的灵力水晶数量
2. 检查当前灵力值
3. 使用1个灵力水晶
4. 验证灵力增加10点
5. 验证背包数量减少1个
6. 批量使用5个灵力水晶
7. 验证灵力增加50点

### 预期结果
- ✓ 使用1个水晶，灵力+10
- ✓ 使用5个水晶，灵力+50
- ✓ 背包数量正确扣除
- ✓ 灵力值正确增加

## 注意事项

1. **等级限制**: 需要35级才能使用战灵系统（包括灵力水晶）
2. **数量限制**: 单次最多使用10个灵力水晶
3. **背包空间**: 灵力水晶占用背包空间
4. **不可交易**: 灵力水晶不能交易或丢弃
5. **灵力上限**: 灵力没有上限，可以无限累积

## 相关功能

### 战灵洗练
- 路径: `/spirit/:id/refine`
- 消耗灵力重新随机属性
- 可以锁定满意的属性条

### 战灵出售
- 路径: `/spirit/warehouse`
- 出售战灵可以获得灵力
- 不同品质战灵获得的灵力不同

### 战灵钥匙
- 道具ID: 6006
- 用于激活战灵的第2、第3条属性
- 用于锁定洗练时的属性条

## 相关文件

### 后端
- `application/services/spirit_service.py` - 灵力水晶使用逻辑
- `interfaces/routes/spirit_routes.py` - 灵力水晶接口

### 前端
- `interfaces/client/src/features/beast/SpiritCrystalUsePage.vue` - 使用页面
- `interfaces/client/src/router/index.js` - 路由配置
- `interfaces/client/src/utils/itemUseRoutes.js` - 物品使用路由

### 测试
- `test_spirit_crystal.py` - 功能测试脚本

### 配置
- `configs/items.json` - 道具配置（item_id=6101）

## 总结

灵力水晶功能已完整实现：
1. ✓ 后端接口已实现（`consume_spirit_crystal`）
2. ✓ 前端使用页面已创建
3. ✓ 路由配置已添加
4. ✓ 物品使用路由已配置
5. ✓ 测试脚本已创建
6. ✓ 使用规则：1个水晶 = 10灵力
7. ✓ 支持批量使用
8. ✓ 灵力用于战灵洗练

玩家可以通过镇妖宝箱和战灵塔获得灵力水晶，在背包中点击使用，获得灵力后用于洗练战灵属性。
