# 副本重置次数限制说明

## 需求描述
每个地图副本每日免费挑战1次，后续想挑战第2次需要重置，每日重置次数为5次，重置一次花费200元宝。

## 实现方案

### 1. 后端修改

#### 1.1 副本进度查询接口 (`/api/dungeon/progress`)
**文件**: `interfaces/routes/dungeon_routes.py`

**修改内容**:
- 移除VIP等级相关的重置次数限制
- 设置固定的每日重置上限：5次
- 返回 `reset_limit` 字段（固定值5）替代 `vip_limit`

**关键代码**:
```python
# 每日重置上限：5次
DAILY_RESET_LIMIT = 5

return jsonify({
    "ok": True,
    "current_floor": row['current_floor'],
    "total_floors": row['total_floors'],
    "floor_cleared": floor_cleared,
    "floor_event_type": floor_event_type,
    "dice": dice_count,
    "energy": f"{player.energy}/{player.max_energy}",
    "resets_today": resets_today,
    "reset_limit": DAILY_RESET_LIMIT,  # 固定5次
    "loot_claimed": loot_claimed
})
```

#### 1.2 副本重置接口 (`/api/dungeon/reset`)
**文件**: `interfaces/routes/dungeon_routes.py`

**修改内容**:
- 移除VIP等级相关的重置次数检查
- 设置固定的每日重置上限：5次
- 设置固定的重置花费：200元宝
- 优化错误提示信息

**关键代码**:
```python
# 每日重置上限：5次
DAILY_RESET_LIMIT = 5
RESET_COST = 200  # 元宝

# 检查重置次数
if resets_today >= DAILY_RESET_LIMIT:
    return jsonify({"ok": False, "error": f"今日重置次数已达上限({DAILY_RESET_LIMIT}次)"}), 400

# 检查元宝
if player.yuanbao < RESET_COST:
    return jsonify({"ok": False, "error": f"元宝不足，重置副本需要{RESET_COST}元宝"}), 400

# 扣除元宝
player.yuanbao -= RESET_COST
services.player_repo.save(player)
```

### 2. 前端修改

#### 2.1 副本挑战页面 (`DungeonChallengePage.vue`)
**文件**: `interfaces/client/src/features/dungeon/DungeonChallengePage.vue`

**修改内容**:
1. 将数据结构中的 `vip_limit` 改为 `reset_limit`
2. 在进度查询时更新 `reset_limit` 字段
3. 在页面上显示重置次数信息

**关键代码**:
```javascript
// 数据结构
const dungeonInfo = ref({
  name: route.params.name || '镇妖塔',
  current_floor: 1,
  total_floors: 35,
  dice: 0,
  current_event: '',
  intro: '',
  energy: '',
  map_path: '前进|迷踪|放弃操作',
  floor_status: ['怪', '怪', '精', '怪', 'boss'],
  resets_today: 0,
  reset_limit: 5  // 改为固定值
})

// 获取进度时更新
dungeonInfo.value.resets_today = data.resets_today || 0
dungeonInfo.value.reset_limit = data.reset_limit || 5
```

**模板显示**:
```vue
<div class="section">
  今日重置:{{ dungeonInfo.resets_today }}/{{ dungeonInfo.reset_limit }}次 
  <span class="gray">(每次200元宝)</span>
</div>
```

## 功能说明

### 重置规则
1. **首次挑战**: 免费，无需重置
2. **通关后重置**: 
   - 消耗200元宝
   - 重置到第1层
   - 重置次数+1
3. **每日限制**: 最多重置5次
4. **次数重置**: 每日0点自动重置重置次数

### 数据库字段
使用 `player_dungeon_progress` 表中的字段：
- `resets_today`: 今日重置次数
- `last_reset_date`: 最后重置日期（用于判断是否跨天）

### 跨天处理
后端在查询进度时自动检查：
```python
resets_today = row.get('resets_today', 0)
last_reset_date = row.get('last_reset_date')
if last_reset_date and str(last_reset_date) != str(date.today()):
    resets_today = 0  # 新的一天，重置计数
```

## 用户体验

### 显示信息
- 页面上显示：`今日重置:2/5次 (每次200元宝)`
- 清晰展示当前重置次数和剩余次数
- 提示重置花费

### 错误提示
1. 重置次数用完：`今日重置次数已达上限(5次)`
2. 元宝不足：`元宝不足，重置副本需要200元宝`
3. 重置成功：`重置成功！消耗200元宝，已从第一层开始挑战`

## 测试建议

### 测试场景
1. **首次进入副本**
   - 确认显示 `今日重置:0/5次`
   - 可以正常挑战

2. **通关后重置**
   - 点击重置按钮
   - 确认扣除200元宝
   - 确认重置到第1层
   - 确认重置次数+1

3. **多次重置**
   - 连续重置5次
   - 确认第6次重置时提示次数用完

4. **元宝不足**
   - 元宝少于200时点击重置
   - 确认提示元宝不足

5. **跨天重置**
   - 今天重置5次
   - 明天再次进入副本
   - 确认重置次数归零

## 注意事项

1. **VIP特权移除**: 本次修改移除了VIP等级对副本重置次数的影响，所有玩家统一为每日5次
2. **免费挑战**: 首次挑战（未通关前）不计入重置次数，只有通关后的重置才计数
3. **元宝消耗**: 每次重置固定消耗200元宝，不受其他因素影响
4. **数据兼容**: 修改后仍然使用原有的数据库字段，不需要数据迁移

## 相关文件

### 后端
- `interfaces/routes/dungeon_routes.py`
  - `get_progress()` 函数
  - `reset_dungeon()` 函数

### 前端
- `interfaces/client/src/features/dungeon/DungeonChallengePage.vue`
  - 数据结构定义
  - `fetchDungeonProgress()` 函数
  - 模板显示部分
