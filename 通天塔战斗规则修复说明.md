# 通天塔战斗规则修复说明

## 问题描述

用户反馈：相同的幻兽和相同战力，在通天塔只能打到20层，而在龙纹塔能打到61层。

要求：将通天塔的战斗规则和扣血公式设置为与龙纹塔完全一致。

## 问题诊断

### 1. 战斗引擎和伤害公式

经过代码审查，发现通天塔和龙纹塔已经使用：
- **相同的战斗引擎**：`run_pvp_battle()` 统一PVP战斗引擎
- **相同的伤害公式**：`(攻击 - 防御) × 0.069`（四舍五入），当攻防差<0时固定扣5点血
- **相同的鼓舞加成**：攻击、防御、气血、速度均+10%

### 2. 守护兽属性差异

通过 `diagnose_tower_guardians.py` 诊断脚本对比发现，**守护兽属性存在巨大差异**：

#### 第20层对比（通天塔卡关层）

**通天塔守护兽**（旧配置）：
- 气血: 683
- 物攻: 599
- 法攻: 599
- 物防: 590
- 法防: 594
- 速度: 3

**龙纹塔守护兽**：
- 气血: 1260
- 物攻: 139
- 法攻: 125
- 物防: 65
- 法防: 39
- 速度: 31

**关键差异**：
- 通天塔守护兽的**物防高9倍**（590 vs 65）
- 通天塔守护兽的**法防高15倍**（594 vs 39）
- 通天塔守护兽的**速度慢10倍**（3 vs 31）

#### 第61层对比（龙纹塔可达层）

**通天塔守护兽**（旧配置）：
- 气血: 2873
- 物攻: 2703
- 法攻: 2162
- 物防: 2669
- 法防: 2733
- 速度: 3

**龙纹塔守护兽**：
- 气血: 3720
- 物攻: 385
- 法攻: 346
- 物防: 188
- 法防: 112
- 速度: 72

**关键差异**：
- 通天塔守护兽的**物防高14倍**（2669 vs 188）
- 通天塔守护兽的**法防高24倍**（2733 vs 112）

### 3. 根本原因

通天塔使用了 `configs/tower_tongtian_beasts.json` 中的精确幻兽配置，这些配置基于真实的幻兽资质和成长率计算，导致守护兽拥有**极高的防御属性**。

而龙纹塔使用简单的模板配置（`configs/tower_guardians.json`），防御属性较低，更容易被玩家击败。

## 解决方案

### 修改1：更新通天塔守护兽配置

**文件**：`configs/tower_guardians.json`

**修改内容**：将通天塔的守护兽配置改为与龙纹塔完全相同的模板：

```json
"tongtian": [
  {
    "floor_range": [1, 120],
    "guardians": [
      {
        "name": "通天守护兽",
        "description": "通天塔守护兽，使用与龙纹塔相同的战斗规则",
        "nature": "法系物防",
        "base_level": 1,
        "level_per_floor": 1,
        "base_hp": 120,
        "hp_per_floor": 60,
        "base_attack": 25,
        "attack_per_floor": 6,
        "base_defense": 8,
        "defense_per_floor": 3,
        "base_speed": 12,
        "speed_per_floor": 1
      }
    ]
  }
]
```

**关键参数**（与龙纹塔完全一致）：
- 基础气血：120，每层+60
- 基础攻击：25，每层+6
- 基础防御：8，每层+3
- 基础速度：12，每层+1

### 修改2：禁用通天塔精确配置

**文件**：`infrastructure/config/tower_config_repo.py`

**修改内容**：注释掉使用 `tower_tongtian_beasts.json` 的代码逻辑：

```python
def get_guardians_for_floor(self, tower_type: str, floor: int) -> List[TowerGuardian]:
    """获取某层的守塔幻兽列表"""
    guardians = []
    
    # 注释掉通天塔精确配置，改用与龙纹塔相同的模板配置
    # if tower_type == "tongtian" and floor in self._tongtian_beasts_config:
    #     ...
    
    # 使用模板+层级成长方式（通天塔和龙纹塔使用相同规则）
    count = self.get_guardian_count_for_floor(tower_type, floor)
    # ...
```

## 验证结果

运行 `diagnose_tower_guardians.py` 验证修复效果：

### 所有层数属性完全一致

```
第 1 层对比
【属性差异】
  气血差: 0 (1.00x)
  物攻差: 0 (1.00x)
  法攻差: 0 (1.00x)
  物防差: 0 (1.00x)
  法防差: 0 (1.00x)
  速度差: 0

第 20 层对比
【属性差异】
  气血差: 0 (1.00x)
  物攻差: 0 (1.00x)
  法攻差: 0 (1.00x)
  物防差: 0 (1.00x)
  法防差: 0 (1.00x)
  速度差: 0

第 61 层对比
【属性差异】
  气血差: 0 (1.00x)
  物攻差: 0 (1.00x)
  法攻差: 0 (1.00x)
  物防差: 0 (1.00x)
  法防差: 0 (1.00x)
  速度差: 0
```

✅ **验证通过**：通天塔和龙纹塔在所有层数的守护兽属性完全一致。

## 预期效果

修复后，相同战力的玩家在通天塔和龙纹塔应该能达到相近的层数：

- **修复前**：通天塔20层 vs 龙纹塔61层（差距41层）
- **修复后**：通天塔和龙纹塔应该能达到相近层数（差距<5层）

差异可能来源于：
1. 守护兽数量配置（21层后通天塔可能有更多守护兽）
2. 随机因素（先手顺序、暴击等）
3. 玩家幻兽技能差异

## 相关文件

### 修改的文件
- `configs/tower_guardians.json` - 通天塔守护兽配置
- `infrastructure/config/tower_config_repo.py` - 塔配置加载逻辑

### 诊断工具
- `diagnose_tower_guardians.py` - 守护兽属性对比诊断脚本

### 保留的文件（未使用）
- `configs/tower_tongtian_beasts.json` - 通天塔精确幻兽配置（已禁用）

## 技术细节

### 战斗规则统一性

通天塔和龙纹塔现在完全共享：

1. **战斗引擎**：`domain/services/pvp_battle_engine.py`
   - 多级先手规则（速度 > 品质 > 星数 > 资质 > 属性）
   - 统一伤害计算
   - 技能系统支持

2. **伤害公式**：
   ```python
   if (攻击 - 防御) >= 0:
       伤害 = round((攻击 - 防御) × 0.069)
   else:
       伤害 = 5
   ```

3. **鼓舞加成**：
   - 攻击 +10%
   - 防御 +10%
   - 气血 +10%
   - 速度 +10%

4. **守护兽成长**：
   - 等级 = 基础等级 + (层数 - 起始层) × 每层等级增长
   - 属性 = 基础属性 + (层数 - 起始层) × 每层属性增长

## 后续建议

1. **测试验证**：使用相同战力的账号分别测试通天塔和龙纹塔，确认能达到相近层数
2. **平衡调整**：如果需要通天塔更难，建议通过以下方式：
   - 调整守护兽数量配置
   - 调整鼓舞加成比例
   - 而不是修改守护兽基础属性
3. **配置保留**：`tower_tongtian_beasts.json` 保留作为备份，如果未来需要差异化可以重新启用

## 修复日期

2026-01-20
