# 召唤之王挑战赛报名机制和无幻兽挑战功能说明

## 修改概述

本次修改实现了两个重要功能：
1. **强制报名机制**：玩家必须先报名才能参加预赛挑战
2. **允许挑战无幻兽对手**：即使对手没有出战幻兽，也可以发起挑战（视为对手弃权）

## 功能详情

### 1. 强制报名机制

#### 修改内容
- 在 `POST /api/king/challenge` 接口中添加报名状态检查
- 未报名的玩家尝试挑战时会收到错误提示："请先报名参加本周挑战赛"

#### 实现逻辑
```python
# 检查是否已报名
rank_info = ensure_king_rank(user_id)
if not rank_info.get('is_registered'):
    return jsonify({"ok": False, "error": "请先报名参加本周挑战赛"})
```

#### 报名流程
1. 玩家等级达到 20 级
2. 在星期一通过 `POST /api/king/register` 接口报名
3. 报名成功后，`king_challenge_rank` 表中的 `is_registered` 字段设为 1
4. 报名后即可在预赛期间（周二至周六）进行挑战

#### 数据库字段
- 表：`king_challenge_rank`
- 字段：`is_registered` (TINYINT, 默认 0)
  - 0: 未报名
  - 1: 已报名

### 2. 允许挑战无幻兽对手

#### 修改内容
- 移除了"对方没有出战幻兽"的错误检查
- 当对手没有出战幻兽时，挑战者自动获胜
- 记录简化版战报，标注"对手未出战"

#### 实现逻辑

**原代码（会拒绝挑战）：**
```python
if not defender_beasts:
    conn.rollback()
    return jsonify({"ok": False, "error": "对方没有出战幻兽"})
```

**新代码（允许挑战，自动获胜）：**
```python
if not defender_beasts:
    # 对手没有幻兽，挑战者自动获胜
    reward = KING_WIN_REWARD  # 20000 铜钱
    
    # 更新挑战者金币
    cursor.execute("UPDATE player SET gold = gold + %s WHERE user_id = %s", (reward, user_id))
    
    # 更新挑战次数和时间
    cursor.execute(
        """UPDATE king_challenge_rank 
           SET today_challenges = %s, last_challenge_date = CURDATE(), last_challenge_time = NOW()
           WHERE user_id = %s""",
        (today_challenges + 1, user_id)
    )
    
    # 交换排名
    cursor.execute(
        "UPDATE king_challenge_rank SET rank_position = %s, win_streak = win_streak + 1, total_wins = total_wins + 1 WHERE user_id = %s",
        (target_rank, user_id)
    )
    cursor.execute(
        "UPDATE king_challenge_rank SET rank_position = %s, win_streak = 0, total_losses = total_losses + 1 WHERE user_id = %s",
        (my_rank, target_user_id)
    )
    
    message = f"对手未出战，你不战而胜！排名上升至第{target_rank}名！获得{KING_WIN_REWARD}铜钱"
    
    # 记录简化版战报
    battle_report_data = {
        "winner": user_id,
        "message": "对手未出战，挑战者不战而胜",
        "current_streak": my_rank_info.get('win_streak', 0) + 1
    }
    
    return jsonify({
        "ok": True, "win": True, "message": message,
        "newRank": target_rank, "reward": reward, "battleReport": battle_report_data
    })
```

#### 游戏逻辑说明
- **挑战者收益**：
  - 获得胜利奖励（20000 铜钱）
  - 排名上升到对手的位置
  - 连胜数 +1
  - 总胜场 +1
  - 消耗 1 次每日挑战次数

- **对手惩罚**：
  - 排名下降到挑战者的位置
  - 连胜数清零
  - 总败场 +1

- **战报记录**：
  - 记录在 `king_challenge_logs` 表中
  - `challenger_wins` = 1（挑战者获胜）
  - `battle_report` 包含简化信息，标注"对手未出战"

## 使用场景

### 场景1：正常挑战流程
1. 玩家达到 20 级
2. 星期一报名参赛
3. 周二至周六期间挑战排名更高的玩家
4. 双方都有出战幻兽，进行正常战斗

### 场景2：挑战无幻兽对手
1. 玩家已报名
2. 选择一个没有出战幻兽的对手
3. 系统判定挑战者自动获胜
4. 挑战者获得完整奖励和排名提升
5. 对手排名下降

### 场景3：未报名尝试挑战
1. 玩家未报名
2. 尝试发起挑战
3. 系统返回错误："请先报名参加本周挑战赛"
4. 玩家需要先完成报名

## 前端交互

### 报名按钮
- 显示条件：`isRegistered === false`
- 点击后调用 `POST /api/king/register`
- 成功后刷新页面，显示"已报名"状态

### 挑战按钮
- 启用条件：`isRegistered === true`
- 禁用条件：`isRegistered === false`
- 禁用时提示："请先报名参加挑战赛"

### 挑战结果显示
- 正常战斗：显示完整战报
- 对手未出战：显示特殊消息"对手未出战，你不战而胜！"

## 测试方法

### 测试1：未报名挑战限制
```bash
python test_king_registration_requirement.py
```

**预期结果**：
- 未报名玩家尝试挑战时收到错误："请先报名参加本周挑战赛"

### 测试2：报名后挑战
1. 使用测试账号登录
2. 调用报名接口（需要在星期一）
3. 报名成功后尝试挑战
4. 挑战应该成功执行

### 测试3：挑战无幻兽对手
1. 创建一个测试账号，不设置出战幻兽
2. 使用另一个账号挑战该测试账号
3. 验证挑战者自动获胜
4. 验证排名交换和奖励发放

## 数据库影响

### 表：king_challenge_rank
- `is_registered` 字段用于标记报名状态
- 每周一可以报名，设置为 1
- 每周日正赛结束后可以重置为 0（需要定时任务）

### 表：king_challenge_logs
- 记录所有挑战日志，包括对手未出战的情况
- `battle_report` 字段存储战报 JSON
- 对手未出战时，战报为简化版本

## 注意事项

1. **报名时间限制**：
   - 只能在星期一报名
   - 其他时间报名会收到错误提示

2. **等级限制**：
   - 报名和挑战都需要 20 级
   - 低于 20 级会收到错误提示

3. **挑战次数**：
   - 每日最多 15 次挑战
   - 对手未出战也会消耗挑战次数

4. **冷却时间**：
   - 每次挑战后有 60 秒冷却
   - 对手未出战也会触发冷却

5. **排名交换**：
   - 只有挑战成功才会交换排名
   - 对手未出战视为挑战成功

## 相关文件

### 后端
- `interfaces/routes/king_routes.py` - 挑战赛路由（主要修改）
- `infrastructure/db/connection.py` - 数据库连接
- `domain/services/pvp_battle_engine.py` - PVP 战斗引擎

### 前端
- `interfaces/client/src/features/king/SummonKingChallengePage.vue` - 挑战赛页面
- 需要添加报名按钮和状态显示

### 测试
- `test_king_registration_requirement.py` - 报名机制测试脚本

## 后续优化建议

1. **定时任务**：
   - 每周日晚上自动重置 `is_registered` 字段
   - 清理上周的挑战记录

2. **前端优化**：
   - 添加报名倒计时显示
   - 显示当前赛季信息
   - 优化对手未出战的战报展示

3. **通知系统**：
   - 报名成功后发送系统消息
   - 被挑战时发送通知
   - 排名变化时发送提醒

4. **数据统计**：
   - 统计每周报名人数
   - 统计对手未出战的挑战次数
   - 生成赛季报告
