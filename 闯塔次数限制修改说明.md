# é—¯å¡”æ¬¡æ•°é™åˆ¶ä¿®æ”¹è¯´æ˜

## ä¿®æ”¹æ—¶é—´
2026å¹´1æœˆ17æ—¥

## éœ€æ±‚æè¿°

ç”¨æˆ·è¦æ±‚ï¼š
> é€šå¤©å¡”ã€é¾™çº¹å¡”ã€æˆ˜çµå¡”æ¯æ—¥é—¯å¡”æ¬¡æ•°ä¸º4æ¬¡ï¼Œç¬¬ä¸€æ¬¡é—¯å¡”å…è´¹ï¼Œç¬¬äºŒæ¬¡å¼€å§‹æ¯æ¬¡èŠ±è´¹200å…ƒå®é‡ç½®ï¼Œé‡ç½®åå¯ä»¥å¼€å§‹ç¬¬äºŒæ¬¡é—¯å¡”ï¼Œä»¥æ­¤ç±»æ¨åˆ°ç¬¬å››æ¬¡ï¼›åªèƒ½åˆ°å››æ¬¡ï¼Œä¸èƒ½è‡ªåŠ¨é—¯å¡”ç¬¬äº”æ¬¡ã€‚

## ä¿®æ”¹å‰çš„é€»è¾‘

### æ—§è§„åˆ™ï¼ˆåŸºäºVIPç­‰çº§ï¼‰
- VIP 0-5ï¼šæ¯æ—¥1æ¬¡
- VIP 6-7ï¼šæ¯æ—¥2æ¬¡
- VIP 8ï¼šæ¯æ—¥3æ¬¡
- VIP 9+ï¼šæ¯æ—¥4æ¬¡
- è¶…è¿‡å…è´¹æ¬¡æ•°åï¼Œéœ€è¦200å…ƒå®é‡ç½®

### é—®é¢˜
1. ä¸åŒVIPç­‰çº§çš„æ¬¡æ•°ä¸åŒï¼Œä¸å…¬å¹³
2. é€»è¾‘å¤æ‚ï¼Œéš¾ä»¥ç†è§£

## ä¿®æ”¹åçš„é€»è¾‘

### æ–°è§„åˆ™ï¼ˆç»Ÿä¸€æ ‡å‡†ï¼‰
- **æ‰€æœ‰ç©å®¶**ï¼šæ¯æ—¥å›ºå®š4æ¬¡
- **ç¬¬1æ¬¡**ï¼šå…è´¹
- **ç¬¬2-4æ¬¡**ï¼šæ¯æ¬¡éœ€è¦200å…ƒå®é‡ç½®
- **ç¬¬5æ¬¡åŠä»¥å**ï¼šä¸å…è®¸ï¼Œæç¤º"ä»Šæ—¥é—¯å¡”æ¬¡æ•°å·²ç”¨å®Œï¼ˆ4æ¬¡ï¼‰"

### ä¼˜ç‚¹
1. è§„åˆ™ç®€å•æ˜ç¡®
2. æ‰€æœ‰ç©å®¶å…¬å¹³
3. é¼“åŠ±ç©å®¶å¤šæ¬¡æŒ‘æˆ˜

## ä»£ç ä¿®æ”¹

### 1. ç§»é™¤VIPç›¸å…³é€»è¾‘

**æ–‡ä»¶**ï¼š`application/services/tower_service.py`

**åˆ é™¤çš„æ–¹æ³•**ï¼š
```python
# âŒ åˆ é™¤
def _get_player_vip_level(self, user_id: int) -> int:
    ...

def _get_daily_limit_by_vip(self, vip_level: int) -> int:
    ...

def _ensure_paid_reset_if_needed(self, user_id: int, state: TowerState) -> int:
    ...
```

**æ–°å¢çš„æ–¹æ³•**ï¼š
```python
# âœ… æ–°å¢
def _get_daily_limit(self) -> int:
    """è·å–æ¯æ—¥é—¯å¡”æ¬¡æ•°é™åˆ¶ï¼ˆå›ºå®šä¸º4æ¬¡ï¼‰"""
    return 4
```

### 2. é‡å†™æ¬¡æ•°æ£€æŸ¥é€»è¾‘

**æ–‡ä»¶**ï¼š`application/services/tower_service.py`

**ä¿®æ”¹å‰**ï¼š
```python
def _ensure_can_challenge_today(self, user_id: int, state: TowerState) -> int:
    vip_level = self._get_player_vip_level(user_id)
    daily_limit = self._get_daily_limit_by_vip(vip_level)
    if int(state.today_count or 0) >= daily_limit:
        raise TowerError(f"ä»Šæ—¥é—¯å¡”æ¬¡æ•°å·²ç”¨å®Œï¼ˆ{daily_limit}æ¬¡ï¼‰")
    return daily_limit
```

**ä¿®æ”¹å**ï¼š
```python
def _ensure_can_challenge_today(self, user_id: int, state: TowerState, is_continue: bool = False) -> int:
    """æ£€æŸ¥ä»Šæ—¥æ˜¯å¦è¿˜èƒ½é—¯å¡”
    
    è§„åˆ™ï¼š
    - æ¯æ—¥æœ€å¤š4æ¬¡
    - ç¬¬1æ¬¡å…è´¹
    - ç¬¬2-4æ¬¡æ¯æ¬¡éœ€è¦200å…ƒå®é‡ç½®
    
    Args:
        is_continue: æ˜¯å¦æ˜¯ç»§ç»­æŒ‘æˆ˜ï¼ˆç»§ç»­æŒ‘æˆ˜ä¸æ‰£å…ƒå®ï¼Œä¸é‡ç½®å±‚æ•°ï¼‰
    """
    daily_limit = self._get_daily_limit()
    current_count = int(state.today_count or 0)
    
    # æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°æ¯æ—¥ä¸Šé™
    if current_count >= daily_limit:
        raise TowerError(f"ä»Šæ—¥é—¯å¡”æ¬¡æ•°å·²ç”¨å®Œï¼ˆ{daily_limit}æ¬¡ï¼‰")
    
    # ç»§ç»­æŒ‘æˆ˜ä¸éœ€è¦æ‰£å…ƒå®å’Œé‡ç½®å±‚æ•°
    if is_continue:
        return daily_limit
    
    # ç¬¬1æ¬¡å…è´¹ï¼Œç¬¬2-4æ¬¡éœ€è¦èŠ±è´¹å…ƒå®
    if current_count >= 1:
        if self.player_repo is None:
            raise TowerError("ç³»ç»Ÿé”™è¯¯ï¼šPlayerRepo æœªé…ç½®")
        
        player = self.player_repo.get_by_id(user_id)
        if player is None:
            raise TowerError("ç©å®¶ä¸å­˜åœ¨")
        
        cost = 200
        if int(getattr(player, "yuanbao", 0) or 0) < cost:
            raise TowerError(f"å…ƒå®ä¸è¶³ï¼Œéœ€è¦{cost}å…ƒå®å¼€å§‹ç¬¬{current_count + 1}æ¬¡é—¯å¡”")
        
        # æ‰£é™¤å…ƒå®
        player.yuanbao = int(getattr(player, "yuanbao", 0) or 0) - cost
        self.player_repo.save(player)
        
        # é‡ç½®å½“å‰å±‚æ•°ä¸º1
        state.current_floor = 1
    
    return daily_limit
```

### 3. æ›´æ–° get_tower_info æ–¹æ³•

**æ–‡ä»¶**ï¼š`application/services/tower_service.py`

**ä¿®æ”¹å‰**ï¼š
```python
def get_tower_info(self, user_id: int, tower_type: str = "tongtian") -> dict:
    # ...
    vip_level = self._get_player_vip_level(user_id)
    daily_limit = self._get_daily_limit_by_vip(vip_level)
    # ...
```

**ä¿®æ”¹å**ï¼š
```python
def get_tower_info(self, user_id: int, tower_type: str = "tongtian") -> dict:
    # ...
    daily_limit = self._get_daily_limit()
    # ...
```

### 4. æ›´æ–°è°ƒç”¨æ–¹æ³•

**æ–‡ä»¶**ï¼š`application/services/tower_service.py`

**challenge_floor æ–¹æ³•**ï¼š
```python
# ä»Šæ—¥æ¬¡æ•°é™åˆ¶ï¼ˆç¬¬2-4æ¬¡ä¼šè‡ªåŠ¨æ‰£å…ƒå®é‡ç½®ï¼‰
self._ensure_can_challenge_today(user_id=user_id, state=state, is_continue=False)
```

**auto_challenge æ–¹æ³•**ï¼š
```python
# ä»Šæ—¥æ¬¡æ•°é™åˆ¶ï¼ˆç¬¬2-4æ¬¡ä¼šè‡ªåŠ¨æ‰£å…ƒå®é‡ç½®ï¼‰
self._ensure_can_challenge_today(user_id=user_id, state=state, is_continue=is_continue)
```

## åŠŸèƒ½è¯´æ˜

### åœºæ™¯1ï¼šç¬¬1æ¬¡é—¯å¡”ï¼ˆå…è´¹ï¼‰

**æµç¨‹**ï¼š
1. ç©å®¶ç‚¹å‡»"è‡ªåŠ¨é—¯å¡”"
2. æ£€æŸ¥ä»Šæ—¥æ¬¡æ•°ï¼š0 < 4 âœ…
3. æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰£å…ƒå®ï¼š0 < 1ï¼Œä¸éœ€è¦ âœ…
4. å¼€å§‹é—¯å¡”
5. å¢åŠ ä»Šæ—¥æ¬¡æ•°ï¼š0 â†’ 1

**ç»“æœ**ï¼š
- âœ… å…è´¹é—¯å¡”
- âœ… ä¸é‡ç½®å±‚æ•°
- âœ… ä»Šæ—¥æ¬¡æ•° +1

### åœºæ™¯2ï¼šç¬¬2æ¬¡é—¯å¡”ï¼ˆ200å…ƒå®ï¼‰

**æµç¨‹**ï¼š
1. ç©å®¶ç‚¹å‡»"è‡ªåŠ¨é—¯å¡”"
2. æ£€æŸ¥ä»Šæ—¥æ¬¡æ•°ï¼š1 < 4 âœ…
3. æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰£å…ƒå®ï¼š1 >= 1ï¼Œéœ€è¦ âœ…
4. æ£€æŸ¥å…ƒå®æ˜¯å¦è¶³å¤Ÿï¼š>= 200 âœ…
5. æ‰£é™¤200å…ƒå®
6. é‡ç½®å±‚æ•°ä¸º1
7. å¼€å§‹é—¯å¡”
8. å¢åŠ ä»Šæ—¥æ¬¡æ•°ï¼š1 â†’ 2

**ç»“æœ**ï¼š
- âœ… æ¶ˆè€—200å…ƒå®
- âœ… é‡ç½®å±‚æ•°ä¸º1
- âœ… ä»Šæ—¥æ¬¡æ•° +1

### åœºæ™¯3ï¼šç¬¬3-4æ¬¡é—¯å¡”ï¼ˆæ¯æ¬¡200å…ƒå®ï¼‰

**æµç¨‹**ï¼šåŒåœºæ™¯2

**ç»“æœ**ï¼š
- âœ… æ¯æ¬¡æ¶ˆè€—200å…ƒå®
- âœ… æ¯æ¬¡é‡ç½®å±‚æ•°ä¸º1
- âœ… ä»Šæ—¥æ¬¡æ•° +1

### åœºæ™¯4ï¼šç¬¬5æ¬¡é—¯å¡”ï¼ˆæ‹’ç»ï¼‰

**æµç¨‹**ï¼š
1. ç©å®¶ç‚¹å‡»"è‡ªåŠ¨é—¯å¡”"
2. æ£€æŸ¥ä»Šæ—¥æ¬¡æ•°ï¼š4 >= 4 âŒ
3. æŠ›å‡ºé”™è¯¯ï¼š"ä»Šæ—¥é—¯å¡”æ¬¡æ•°å·²ç”¨å®Œï¼ˆ4æ¬¡ï¼‰"

**ç»“æœ**ï¼š
- âŒ æ‹’ç»é—¯å¡”
- âŒ ä¸æ‰£å…ƒå®
- âŒ ä»Šæ—¥æ¬¡æ•°ä¸å˜

### åœºæ™¯5ï¼šç»§ç»­æŒ‘æˆ˜ï¼ˆä¸æ¶ˆè€—æ¬¡æ•°ï¼‰

**æµç¨‹**ï¼š
1. ç©å®¶åœ¨æŸå±‚å¤±è´¥
2. ç‚¹å‡»"é‡æ–°æŒ‘æˆ˜ç¬¬Xå±‚"
3. è°ƒç”¨ `auto_challenge(is_continue=True)`
4. æ£€æŸ¥ä»Šæ—¥æ¬¡æ•°ï¼š< 4 âœ…
5. æ£€æŸ¥æ˜¯å¦ç»§ç»­æŒ‘æˆ˜ï¼šis_continue=True âœ…
6. ä¸æ‰£å…ƒå®ï¼Œä¸é‡ç½®å±‚æ•°
7. å¼€å§‹é—¯å¡”
8. ä¸å¢åŠ ä»Šæ—¥æ¬¡æ•°

**ç»“æœ**ï¼š
- âœ… ä¸æ¶ˆè€—å…ƒå®
- âœ… ä¸é‡ç½®å±‚æ•°
- âœ… ä»Šæ—¥æ¬¡æ•°ä¸å˜
- âœ… å¯ä»¥æ— é™æ¬¡é‡è¯•

## å…ƒå®æ¶ˆè€—è®¡ç®—

### æ¯æ—¥æœ€å¤šæ¶ˆè€—
- ç¬¬1æ¬¡ï¼š0å…ƒå®ï¼ˆå…è´¹ï¼‰
- ç¬¬2æ¬¡ï¼š200å…ƒå®
- ç¬¬3æ¬¡ï¼š200å…ƒå®
- ç¬¬4æ¬¡ï¼š200å…ƒå®
- **æ€»è®¡**ï¼š600å…ƒå®/å¤©

### ç»§ç»­æŒ‘æˆ˜
- å¤±è´¥åé‡æ–°æŒ‘æˆ˜ï¼š0å…ƒå®
- å¯ä»¥æ— é™æ¬¡é‡è¯•

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
åˆ›å»ºäº† `test_tower_daily_limit.py` æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š

1. **æ¯æ—¥é™åˆ¶**ï¼š
   - âœ… ç¬¬1æ¬¡å…è´¹
   - âœ… ç¬¬2-4æ¬¡æ¯æ¬¡æ‰£200å…ƒå®
   - âœ… ç¬¬5æ¬¡æ‹’ç»

2. **ç»§ç»­æŒ‘æˆ˜**ï¼š
   - âœ… ä¸æ‰£å…ƒå®
   - âœ… ä¸é‡ç½®å±‚æ•°
   - âœ… ä¸å¢åŠ ä»Šæ—¥æ¬¡æ•°

3. **å…ƒå®ä¸è¶³**ï¼š
   - âœ… æç¤º"å…ƒå®ä¸è¶³ï¼Œéœ€è¦200å…ƒå®å¼€å§‹ç¬¬Xæ¬¡é—¯å¡”"

### æµ‹è¯•ç”¨ä¾‹

#### ç”¨ä¾‹1ï¼šæ­£å¸¸é—¯å¡”4æ¬¡
```
åˆå§‹çŠ¶æ€ï¼šä»Šæ—¥æ¬¡æ•° 0, å…ƒå® 1000

ç¬¬1æ¬¡ï¼šä»Šæ—¥æ¬¡æ•° 0 â†’ 1, å…ƒå® 1000 â†’ 1000 (å…è´¹)
ç¬¬2æ¬¡ï¼šä»Šæ—¥æ¬¡æ•° 1 â†’ 2, å…ƒå® 1000 â†’ 800 (æ‰£200)
ç¬¬3æ¬¡ï¼šä»Šæ—¥æ¬¡æ•° 2 â†’ 3, å…ƒå® 800 â†’ 600 (æ‰£200)
ç¬¬4æ¬¡ï¼šä»Šæ—¥æ¬¡æ•° 3 â†’ 4, å…ƒå® 600 â†’ 400 (æ‰£200)
ç¬¬5æ¬¡ï¼šæ‹’ç»ï¼Œæç¤º"ä»Šæ—¥é—¯å¡”æ¬¡æ•°å·²ç”¨å®Œï¼ˆ4æ¬¡ï¼‰"
```

#### ç”¨ä¾‹2ï¼šå…ƒå®ä¸è¶³
```
åˆå§‹çŠ¶æ€ï¼šä»Šæ—¥æ¬¡æ•° 1, å…ƒå® 100

ç¬¬2æ¬¡ï¼šæ‹’ç»ï¼Œæç¤º"å…ƒå®ä¸è¶³ï¼Œéœ€è¦200å…ƒå®å¼€å§‹ç¬¬2æ¬¡é—¯å¡”"
```

#### ç”¨ä¾‹3ï¼šç»§ç»­æŒ‘æˆ˜
```
åˆå§‹çŠ¶æ€ï¼šä»Šæ—¥æ¬¡æ•° 2, å…ƒå® 400

ç»§ç»­æŒ‘æˆ˜ï¼šä»Šæ—¥æ¬¡æ•° 2 â†’ 2, å…ƒå® 400 â†’ 400 (ä¸æ‰£)
ç»§ç»­æŒ‘æˆ˜ï¼šä»Šæ—¥æ¬¡æ•° 2 â†’ 2, å…ƒå® 400 â†’ 400 (ä¸æ‰£)
ç»§ç»­æŒ‘æˆ˜ï¼šä»Šæ—¥æ¬¡æ•° 2 â†’ 2, å…ƒå® 400 â†’ 400 (ä¸æ‰£)
```

## å‘åå…¼å®¹æ€§

### æ•°æ®åº“å…¼å®¹
- âœ… ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“ç»“æ„
- âœ… ä½¿ç”¨ç°æœ‰çš„ `today_count` å­—æ®µ
- âœ… è‡ªåŠ¨é’³åˆ¶è¶…é™æ¬¡æ•°ï¼ˆå¦‚ 5/4 â†’ 4/4ï¼‰

### APIå…¼å®¹
- âœ… ä¸éœ€è¦ä¿®æ”¹APIæ¥å£
- âœ… å‰ç«¯ä¸éœ€è¦ä¿®æ”¹
- âœ… ç°æœ‰åŠŸèƒ½ç»§ç»­å·¥ä½œ

### æ—§æ•°æ®å¤„ç†
```python
# å…¼å®¹æ—§é€»è¾‘é—ç•™çš„è¶…é™æ¬¡æ•°ï¼ˆä¾‹å¦‚ 5/4ï¼‰ï¼Œé’³åˆ¶åˆ°ä¸Šé™å¹¶å›å†™
if int(state.today_count or 0) > int(daily_limit or 0):
    state.today_count = int(daily_limit or 0)
    self.state_repo.save(state)
```

## æ³¨æ„äº‹é¡¹

1. **å…ƒå®æ‰£é™¤æ—¶æœº**ï¼š
   - åœ¨ `_ensure_can_challenge_today` æ–¹æ³•ä¸­æ‰£é™¤
   - åœ¨å¼€å§‹é—¯å¡”å‰æ‰£é™¤ï¼Œç¡®ä¿ç©å®¶æœ‰è¶³å¤Ÿå…ƒå®

2. **å±‚æ•°é‡ç½®æ—¶æœº**ï¼š
   - ç¬¬2-4æ¬¡é—¯å¡”æ—¶è‡ªåŠ¨é‡ç½®ä¸º1
   - ç»§ç»­æŒ‘æˆ˜ä¸é‡ç½®å±‚æ•°

3. **ä»Šæ—¥æ¬¡æ•°å¢åŠ æ—¶æœº**ï¼š
   - åœ¨ `auto_challenge` å’Œ `challenge_floor` æ–¹æ³•ä¸­å¢åŠ 
   - ç»§ç»­æŒ‘æˆ˜ä¸å¢åŠ ä»Šæ—¥æ¬¡æ•°

4. **é”™è¯¯æç¤º**ï¼š
   - æ¬¡æ•°ç”¨å®Œï¼šæç¤º"ä»Šæ—¥é—¯å¡”æ¬¡æ•°å·²ç”¨å®Œï¼ˆ4æ¬¡ï¼‰"
   - å…ƒå®ä¸è¶³ï¼šæç¤º"å…ƒå®ä¸è¶³ï¼Œéœ€è¦200å…ƒå®å¼€å§‹ç¬¬Xæ¬¡é—¯å¡”"

## æ€»ç»“

### ä¿®æ”¹å†…å®¹
1. âœ… ç§»é™¤VIPç›¸å…³é€»è¾‘
2. âœ… ç»Ÿä¸€æ¯æ—¥æ¬¡æ•°ä¸º4æ¬¡
3. âœ… ç¬¬1æ¬¡å…è´¹ï¼Œç¬¬2-4æ¬¡æ¯æ¬¡200å…ƒå®
4. âœ… ç¬¬5æ¬¡åŠä»¥åæ‹’ç»
5. âœ… ç»§ç»­æŒ‘æˆ˜ä¸æ¶ˆè€—æ¬¡æ•°å’Œå…ƒå®

### ä¼˜ç‚¹
1. âœ… è§„åˆ™ç®€å•æ˜ç¡®
2. âœ… æ‰€æœ‰ç©å®¶å…¬å¹³
3. âœ… é¼“åŠ±ç©å®¶å¤šæ¬¡æŒ‘æˆ˜
4. âœ… å‘åå…¼å®¹

### æµ‹è¯•
1. âœ… åˆ›å»ºæµ‹è¯•è„šæœ¬
2. âœ… éªŒè¯å„ç§åœºæ™¯
3. âœ… ç¡®ä¿é€»è¾‘æ­£ç¡®

**ä¿®æ”¹å®Œæˆï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼** ğŸ‰
