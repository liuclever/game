# 闯塔次数限制修改说明

## 修改日期
2026年1月18日

## 需求描述

修改通天塔、龙纹塔、战灵塔的每日闯塔次数规则：
1. **每日4次**：所有玩家统一，每日最多闯塔4次
2. **第1次免费**：首次闯塔不需要花费元宝
3. **第2-4次付费**：每次需要花费200元宝重置
4. **最多4次**：不能超过4次，即使有元宝也不能继续

## 原有逻辑

### VIP等级限制
**原代码**：
```python
def _get_daily_limit_by_vip(self, vip_level: int) -> int:
    v = int(vip_level or 0)
    if v >= 9:
        return 4
    if v >= 8:
        return 3
    if v >= 6:
        return 2
    return 1
```

**问题**：
- 不同VIP等级有不同的闯塔次数
- VIP0：1次/天
- VIP6-7：2次/天
- VIP8：3次/天
- VIP9+：4次/天
- 不符合新需求（所有玩家统一4次）

### 付费重置逻辑
**原代码**：
```python
def _ensure_paid_reset_if_needed(self, user_id: int, state: TowerState) -> int:
    vip_level = self._get_player_vip_level(user_id)
    free_limit = self._get_daily_limit_by_vip(vip_level)
    if int(state.today_count or 0) < free_limit:
        return 0
    # ... 扣除200元宝
```

**问题**：
- 基于VIP等级判断是否需要付费
- VIP0玩家第1次免费，第2次开始付费
- VIP9玩家前4次都免费
- 不符合新需求（第1次免费，第2-4次付费）

## 修改内容

### 1. 统一每日次数限制

#### application/services/tower_service.py

**修改函数**：`_get_daily_limit_by_vip`

**修改前**：
```python
def _get_daily_limit_by_vip(self, vip_level: int) -> int:
    v = int(vip_level or 0)
    if v >= 9:
        return 4
    if v >= 8:
        return 3
    if v >= 6:
        return 2
    return 1
```

**修改后**：
```python
def _get_daily_limit_by_vip(self, vip_level: int) -> int:
    """获取每日闯塔次数限制
    
    所有玩家统一：每日4次闯塔机会
    - 第1次：免费
    - 第2-4次：每次花费200元宝重置
    """
    return 4
```

**说明**：
- 移除VIP等级判断
- 固定返回4次
- 所有玩家统一规则

### 2. 修改付费重置逻辑

#### application/services/tower_service.py

**修改函数**：`_ensure_paid_reset_if_needed`

**修改前**：
```python
def _ensure_paid_reset_if_needed(self, user_id: int, state: TowerState) -> int:
    vip_level = self._get_player_vip_level(user_id)
    free_limit = self._get_daily_limit_by_vip(vip_level)
    if int(state.today_count or 0) < free_limit:
        return 0
    # ... 扣除200元宝
```

**修改后**：
```python
def _ensure_paid_reset_if_needed(self, user_id: int, state: TowerState) -> int:
    """检查并执行付费重置
    
    闯塔次数规则：
    - 第1次：免费（today_count = 0）
    - 第2次：花费200元宝重置（today_count = 1）
    - 第3次：花费200元宝重置（today_count = 2）
    - 第4次：花费200元宝重置（today_count = 3）
    - 第5次及以上：不允许（today_count >= 4）
    
    Returns:
        int: 本次重置花费的元宝数量（0表示免费）
    """
    current_count = int(state.today_count or 0)
    
    # 第1次免费
    if current_count == 0:
        return 0
    
    # 第5次及以上不允许
    if current_count >= 4:
        raise TowerError("今日闯塔次数已用完（最多4次）")
    
    # 第2-4次需要花费200元宝重置
    if self.player_repo is None:
        raise TowerError("系统错误：PlayerRepo 未配置")

    player = self.player_repo.get_by_id(user_id)
    if player is None:
        raise TowerError("玩家不存在")

    cost = 200
    if int(getattr(player, "yuanbao", 0) or 0) < cost:
        raise TowerError(f"元宝不足，需要{cost}元宝重置闯塔（第{current_count + 1}次）")

    # 扣除元宝
    player.yuanbao = int(getattr(player, "yuanbao", 0) or 0) - cost
    self.player_repo.save(player)

    # 重置当前层数到第1层
    state.current_floor = 1
    
    return cost
```

**说明**：
- 移除VIP等级判断
- 基于 `today_count` 判断是否需要付费
- `today_count = 0`：第1次，免费
- `today_count = 1-3`：第2-4次，花费200元宝
- `today_count >= 4`：不允许，抛出错误

### 3. 修改次数检查逻辑

#### application/services/tower_service.py

**修改函数**：`_ensure_can_challenge_today`

**修改前**：
```python
def _ensure_can_challenge_today(self, user_id: int, state: TowerState) -> int:
    vip_level = self._get_player_vip_level(user_id)
    daily_limit = self._get_daily_limit_by_vip(vip_level)
    if int(state.today_count or 0) >= daily_limit:
        raise TowerError(f"今日闯塔次数已用完（{daily_limit}次）")
    return daily_limit
```

**修改后**：
```python
def _ensure_can_challenge_today(self, user_id: int, state: TowerState) -> int:
    """检查今日是否还能闯塔
    
    每日最多4次闯塔机会
    """
    daily_limit = 4  # 固定为4次
    current_count = int(state.today_count or 0)
    
    if current_count >= daily_limit:
        raise TowerError(f"今日闯塔次数已用完（最多{daily_limit}次）")
    
    return daily_limit
```

**说明**：
- 移除VIP等级判断
- 固定限制为4次
- 简化逻辑

### 4. 修改自动闯塔逻辑

#### application/services/tower_service.py

**修改函数**：`auto_challenge`

**修改前**：
```python
def auto_challenge(...):
    state = self.state_repo.get_by_user_id(user_id, tower_type)
    state.reset_daily_if_needed()

    # 今日次数限制（不自动扣元宝重置）
    self._ensure_can_challenge_today(user_id=user_id, state=state)

    # 只有首次进入自动闯塔时才增加次数，继续挑战不增加
    if not is_continue:
        state.today_count += 1
```

**修改后**：
```python
def auto_challenge(...):
    state = self.state_repo.get_by_user_id(user_id, tower_type)
    state.reset_daily_if_needed()

    # 只有首次进入自动闯塔时才处理次数和重置逻辑
    if not is_continue:
        # 检查今日次数限制
        self._ensure_can_challenge_today(user_id=user_id, state=state)
        
        # 检查并执行付费重置（第2-4次需要花费200元宝）
        reset_cost = self._ensure_paid_reset_if_needed(user_id=user_id, state=state)
        
        # 增加今日闯塔次数
        state.today_count += 1
```

**说明**：
- 添加付费重置检查
- 第2-4次进入时自动扣除200元宝
- 元宝不足时抛出错误，阻止闯塔

### 5. 前端显示优化

#### interfaces/client/src/features/tower/TowerPage.vue

**修改前**：
```vue
<div class="section">
  今日闯塔:{{ towerInfo.todayCount }}/{{ towerInfo.dailyLimit }}
</div>
```

**修改后**：
```vue
<div class="section">
  今日闯塔:{{ towerInfo.todayCount }}/{{ towerInfo.dailyLimit }}
  <span class="gray" v-if="towerInfo.todayCount === 0">(第1次免费)</span>
  <span class="gray" v-else-if="towerInfo.todayCount < towerInfo.dailyLimit">(第{{ towerInfo.todayCount + 1 }}次需200元宝)</span>
  <span class="red" v-else>(今日已用完)</span>
</div>
```

**说明**：
- 显示当前状态提示
- `todayCount = 0`：提示"第1次免费"
- `todayCount = 1-3`：提示"第X次需200元宝"
- `todayCount = 4`：提示"今日已用完"

## 修改效果

### 修改前的流程

**VIP0玩家**：
1. 第1次闯塔：免费 ✅
2. 第2次闯塔：提示"今日闯塔次数已用完（1次）" ❌

**VIP9玩家**：
1. 第1次闯塔：免费 ✅
2. 第2次闯塔：免费 ✅
3. 第3次闯塔：免费 ✅
4. 第4次闯塔：免费 ✅
5. 第5次闯塔：提示"今日闯塔次数已用完（4次）" ✅

**问题**：
- 不同VIP等级规则不同
- 不符合新需求

### 修改后的流程

**所有玩家（统一规则）**：
1. 第1次闯塔：免费，`today_count` 从0变为1 ✅
2. 第2次闯塔：扣除200元宝，重置到第1层，`today_count` 从1变为2 ✅
3. 第3次闯塔：扣除200元宝，重置到第1层，`today_count` 从2变为3 ✅
4. 第4次闯塔：扣除200元宝，重置到第1层，`today_count` 从3变为4 ✅
5. 第5次闯塔：提示"今日闯塔次数已用完（最多4次）" ✅

**优势**：
- 所有玩家规则统一
- 第1次免费，降低门槛
- 第2-4次付费，增加收入
- 最多4次，避免无限刷塔

## 技术细节

### 次数计数逻辑

**today_count 的含义**：
- `today_count = 0`：今日还没闯过塔
- `today_count = 1`：今日已闯1次
- `today_count = 2`：今日已闯2次
- `today_count = 3`：今日已闯3次
- `today_count = 4`：今日已闯4次（已用完）

**次数增加时机**：
- 点击"自动闯塔"进入页面时：`today_count += 1`
- 点击"继续挑战"时：不增加（`is_continue = true`）

### 付费重置时机

**检查时机**：
- 点击"自动闯塔"进入页面时
- 在增加 `today_count` 之前

**扣费逻辑**：
```python
if current_count == 0:
    # 第1次，免费
    return 0
elif current_count >= 1 and current_count <= 3:
    # 第2-4次，扣除200元宝
    player.yuanbao -= 200
    state.current_floor = 1  # 重置到第1层
    return 200
else:
    # 第5次及以上，不允许
    raise TowerError("今日闯塔次数已用完（最多4次）")
```

### 层数重置

**重置时机**：
- 第2-4次闯塔时，付费重置后
- 点击"退出此次闯塔"时

**重置逻辑**：
```python
state.current_floor = 1  # 重置到第1层
```

**说明**：
- 每次付费重置后，从第1层重新开始
- 最高纪录（`max_floor_record`）不会重置

### 元宝不足处理

**检查逻辑**：
```python
cost = 200
if int(getattr(player, "yuanbao", 0) or 0) < cost:
    raise TowerError(f"元宝不足，需要{cost}元宝重置闯塔（第{current_count + 1}次）")
```

**错误提示**：
- 第2次：`元宝不足，需要200元宝重置闯塔（第2次）`
- 第3次：`元宝不足，需要200元宝重置闯塔（第3次）`
- 第4次：`元宝不足，需要200元宝重置闯塔（第4次）`

## 测试建议

### 测试场景1：第1次闯塔（免费）
1. 确保 `today_count = 0`
2. 点击"自动闯塔"
3. 检查是否扣除元宝（应该不扣）
4. 检查 `today_count` 是否变为1
5. 检查是否从当前层开始闯塔

### 测试场景2：第2次闯塔（付费）
1. 确保 `today_count = 1`
2. 确保元宝 >= 200
3. 点击"自动闯塔"
4. 检查是否扣除200元宝
5. 检查 `today_count` 是否变为2
6. 检查是否从第1层开始闯塔

### 测试场景3：第3-4次闯塔（付费）
1. 重复测试场景2的步骤
2. 检查每次都扣除200元宝
3. 检查每次都从第1层开始

### 测试场景4：第5次闯塔（不允许）
1. 确保 `today_count = 4`
2. 点击"自动闯塔"
3. 检查是否提示"今日闯塔次数已用完（最多4次）"
4. 检查是否没有扣除元宝

### 测试场景5：元宝不足
1. 确保 `today_count = 1-3`
2. 确保元宝 < 200
3. 点击"自动闯塔"
4. 检查是否提示"元宝不足，需要200元宝重置闯塔"
5. 检查 `today_count` 是否没有增加

### 测试场景6：继续挑战
1. 在闯塔过程中失败
2. 点击"继续挑战"
3. 检查是否没有扣除元宝
4. 检查 `today_count` 是否没有增加
5. 检查是否从失败的层继续

### 测试场景7：前端显示
1. `today_count = 0`：检查是否显示"(第1次免费)"
2. `today_count = 1`：检查是否显示"(第2次需200元宝)"
3. `today_count = 2`：检查是否显示"(第3次需200元宝)"
4. `today_count = 3`：检查是否显示"(第4次需200元宝)"
5. `today_count = 4`：检查是否显示"(今日已用完)"

### 测试场景8：跨天重置
1. 确保 `today_count = 4`
2. 等待到第二天（或修改系统时间）
3. 刷新页面
4. 检查 `today_count` 是否重置为0
5. 检查是否可以免费闯塔

## 相关文件

### 修改的文件
1. `application/services/tower_service.py` - 修改次数限制和付费重置逻辑
2. `interfaces/client/src/features/tower/TowerPage.vue` - 优化前端显示

### 相关文件（未修改）
1. `domain/entities/tower.py` - 塔实体定义
2. `infrastructure/config/tower_config.py` - 塔配置
3. `interfaces/routes/tower_routes.py` - 塔路由

## 注意事项

### 1. VIP特权移除
- 原有的VIP闯塔次数特权已移除
- 所有玩家统一规则
- 如果需要保留VIP特权，可以考虑：
  - VIP玩家重置费用打折（如VIP9只需100元宝）
  - VIP玩家每日次数更多（如VIP9可以闯6次）

### 2. 元宝消耗
- 每次重置消耗200元宝
- 每日最多消耗600元宝（第2-4次）
- 建议监控玩家元宝消耗情况

### 3. 层数重置
- 付费重置后从第1层开始
- 最高纪录不会重置
- 玩家可能需要多次闯塔才能突破新纪录

### 4. 继续挑战
- 继续挑战不消耗次数
- 继续挑战不消耗元宝
- 继续挑战不重置层数

### 5. 数据兼容性
- 旧数据中的 `today_count` 可能超过4
- `get_tower_info` 中有兼容逻辑，会自动钳制到4
- 建议在数据库中清理异常数据

## 后续优化建议

### 1. VIP特权恢复
如果需要保留VIP特权，可以考虑：
```python
def _get_reset_cost(self, vip_level: int) -> int:
    """根据VIP等级返回重置费用"""
    if vip_level >= 9:
        return 100  # VIP9打5折
    elif vip_level >= 6:
        return 150  # VIP6打7.5折
    else:
        return 200  # 普通玩家
```

### 2. 动态定价
根据闯塔次数动态调整价格：
```python
def _get_reset_cost(self, current_count: int) -> int:
    """根据闯塔次数返回重置费用"""
    if current_count == 1:
        return 200  # 第2次
    elif current_count == 2:
        return 300  # 第3次
    elif current_count == 3:
        return 500  # 第4次
    else:
        return 0
```

### 3. 每日免费次数
增加每日免费次数（如前2次免费）：
```python
FREE_COUNT = 2  # 前2次免费

if current_count < FREE_COUNT:
    return 0  # 免费
```

### 4. 活动优惠
在特定活动期间，降低重置费用或增加免费次数。

---

**修改完成时间**：2026年1月18日  
**修改人员**：Kiro AI Assistant  
**版本**：v1.0
