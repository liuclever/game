# 补签功能修复说明

## 问题描述
原来的补签功能有问题：
- 只能从最后一次签到开始算起
- 无法看到本月具体哪几天没签到
- 无法准确补签指定日期

## 问题原因
原来的实现只在 `player` 表中记录 `last_signin_date`（最后签到日期），没有记录每天的签到详情，导致无法准确知道本月哪些日期签到了，哪些没签到。

## 解决方案

### 1. 创建签到记录表
新增 `player_signin_records` 表，记录每天的签到详情：

```sql
CREATE TABLE player_signin_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT '玩家ID',
    signin_date DATE NOT NULL COMMENT '签到日期',
    is_makeup TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否补签',
    reward_copper INT NOT NULL DEFAULT 0 COMMENT '获得的铜钱',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_date (user_id, signin_date)
);
```

### 2. 修改签到逻辑
- **签到时**：在 `player_signin_records` 表中插入记录
- **查询签到信息**：从 `player_signin_records` 表查询本月已签到的日期
- **补签查询**：计算本月所有未签到的日期（不包括今天）
- **补签操作**：在 `player_signin_records` 表中插入补签记录

### 3. 新的补签功能特性

#### 补签信息接口 (`GET /api/signin/makeup/info`)
返回数据：
```json
{
  "ok": true,
  "availableMakeups": 5,        // 可补签次数（取决于补签卡数量）
  "maxMakeups": 6,               // 最多可补签天数（未签到的天数）
  "currentCards": 5,             // 当前拥有的补签卡数量
  "missedDays": [4, 6, 8, 9, 11, 12],  // 所有未签到的日期
  "signedDays": [1, 2, 3, 5, 7, 10],   // 已签到的日期
  "currentMonth": 1,
  "currentYear": 2026
}
```

#### 补签操作接口 (`POST /api/signin/makeup`)
请求参数：
```json
{
  "day": 4  // 要补签的日期（几号）
}
```

验证规则：
- 不能补签今天或未来的日期
- 只能补签本月的日期
- 不能补签已签到的日期
- 需要有补签卡

## 数据迁移

已创建迁移脚本 `migrate_signin_data.py`，将现有玩家的 `last_signin_date` 迁移到新表中。

运行迁移：
```bash
python migrate_signin_data.py
```

## 测试

### 测试脚本
`test_signin_makeup.py` - 完整的补签功能测试

运行测试：
```bash
python test_signin_makeup.py
```

### 测试场景
1. ✅ 模拟签到几天（跳过一些日期）
2. ✅ 查询已签到的日期
3. ✅ 计算未签到的日期
4. ✅ 执行补签操作
5. ✅ 验证补签后的签到日历

## 前端显示建议

### 签到日历显示
```
本月签到情况：
1月1日 ✓  1月2日 ✓  1月3日 ✓  1月4日 ✗  1月5日 ✓
1月6日 ✗  1月7日 ✓  1月8日 ✗  1月9日 ✗  1月10日 ✓
1月11日 ✗ 1月12日 ✗ 1月13日 (今天)
```

### 补签界面
```
可补签的日期：
[ ] 1月4日  [ ] 1月6日  [ ] 1月8日  [ ] 1月9日
[ ] 1月11日 [ ] 1月12日

补签卡数量：5张
[补签选中的日期]
```

## 注意事项

1. **补签卡物品ID**: 6027
2. **补签限制**: 
   - 只能补签本月的日期
   - 不能补签今天或未来的日期
   - 不能补签已签到的日期
3. **补签奖励**: 与正常签到相同（1000铜钱）
4. **记录标记**: `is_makeup` 字段区分正常签到和补签

## 后续优化建议

1. **签到奖励递增**: 连续签到天数越多，奖励越高
2. **月度签到奖励**: 签到满一定天数给予额外奖励
3. **签到统计**: 显示本月签到天数、连续签到天数等
4. **补签卡获取**: 提供补签卡的获取途径（商城购买、活动奖励等）

## 部署步骤

1. **创建签到记录表**
   ```bash
   python -c "from infrastructure.db.connection import get_connection; conn = get_connection(); cursor = conn.cursor(); cursor.execute(open('sql/player_signin_records.sql', 'r', encoding='utf-8').read()); conn.commit(); conn.close(); print('✅ 表创建成功')"
   ```

2. **迁移现有数据**
   ```bash
   python migrate_signin_data.py
   ```

3. **重启后端服务**
   - 停止当前服务（Ctrl+C）
   - 重新运行 `启动后端.bat`

4. **测试功能**
   - 登录游戏
   - 进入签到页面
   - 查看补签功能是否正常

## 完成状态

✅ 创建签到记录表
✅ 修改签到逻辑
✅ 修改补签查询逻辑
✅ 修改补签操作逻辑
✅ 数据迁移脚本
✅ 测试脚本
✅ 文档说明

现在补签功能可以正确显示本月所有未签到的日期，玩家可以选择任意未签到的日期进行补签！
