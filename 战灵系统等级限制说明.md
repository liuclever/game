# 战灵系统等级限制实现说明

## 实现时间
2026年1月18日

## 需求
1. 战灵功能需要玩家等级达到35级才能解锁
2. 战灵灵石（道具ID: 7101-7106）需要能够在背包中打开使用

## 实现内容

### 1. 后端等级检查

#### 1.1 Spirit Routes 等级检查
在 `interfaces/routes/spirit_routes.py` 中添加了等级检查函数和相关路由保护：

**新增函数：**
```python
def check_spirit_level_requirement(user_id: int) -> bool:
    """检查玩家是否达到战灵系统解锁等级（35级）"""
    player = services.player_repo.get_by_id(user_id)
    if not player:
        return False
    player_level = int(getattr(player, "level", 0) or 0)
    return player_level >= 35
```

**受保护的路由：**
- `/api/spirit/account` - 获取战灵账户
- `/api/spirit/warehouse` - 获取灵件室战灵列表
- `/api/spirit/page-data` - 获取战灵页面数据
- `/api/spirit/open` - 开启战灵灵石
- `/api/spirit/beast/<beast_id>/equipped` - 获取幻兽已装备战灵

所有这些路由在玩家等级不足35级时会返回错误：
```json
{
  "ok": false,
  "error": "战灵系统需要35级才能解锁"
}
```

#### 1.2 背包使用灵石等级检查
在 `application/services/inventory_service.py` 中的 `use_item` 方法中添加了等级检查：

当玩家尝试在背包中使用战灵灵石（7101-7106）时：
1. 首先检查玩家等级是否达到35级
2. 如果等级不足，抛出异常：`"战灵系统需要35级才能解锁，无法开启灵石"`
3. 如果等级足够，调用 `spirit_service.open_stone()` 开启灵石

### 2. 战灵灵石使用功能

战灵灵石（7101-7106）的使用功能已经完整实现：

**灵石物品ID映射：**
- 7101: 土灵石 (earth)
- 7102: 火灵石 (fire)
- 7103: 水灵石 (water)
- 7104: 木灵石 (wood)
- 7105: 金灵石 (metal)
- 7106: 神灵石 (god)

**使用流程：**
1. 玩家在背包中点击灵石的"打开"按钮
2. 前端调用 `/api/inventory/use` 接口
3. 后端检查玩家等级（35级）
4. 调用 `spirit_service.open_stone()` 生成对应元素的随机种族战灵
5. 扣除灵石数量
6. 返回成功消息和获得的战灵数量

**返回示例：**
```json
{
  "ok": true,
  "message": "开启成功，消耗土灵石×1，获得战灵×1",
  "rewards": {
    "战灵": 1
  }
}
```

### 3. 前端已有的等级检查

前端 `BeastSpiritPage.vue` 已经实现了等级检查：

```javascript
const isElementUnlocked = (elementKey) => {
  if ((playerLevel.value || 0) < 35) return false
  return (unlockedElements.value || []).includes(elementKey)
}

const viewWarehouse = () => {
  if ((playerLevel.value || 0) < 35) {
    alert('35级才能解锁')
    return
  }
  router.push('/spirit/warehouse')
}
```

## 测试建议

### 测试场景1：等级不足时访问战灵系统
1. 使用等级低于35级的账号登录
2. 尝试访问战灵相关页面
3. 预期：显示"战灵系统需要35级才能解锁"错误提示

### 测试场景2：等级不足时使用灵石
1. 使用等级低于35级的账号登录
2. 在背包中获得战灵灵石（7101-7106）
3. 尝试点击"打开"按钮
4. 预期：显示"战灵系统需要35级才能解锁，无法开启灵石"错误提示

### 测试场景3：等级足够时使用灵石
1. 使用等级达到35级的账号登录
2. 在背包中获得战灵灵石
3. 点击"打开"按钮
4. 预期：成功开启，获得对应元素的战灵，战灵存入灵件室

### 测试场景4：等级足够时访问战灵系统
1. 使用等级达到35级的账号登录
2. 访问战灵相关页面
3. 预期：正常显示战灵系统界面，可以进行装备、卸下等操作

## 相关文件

### 修改的文件
1. `interfaces/routes/spirit_routes.py` - 添加等级检查函数和路由保护
2. `application/services/inventory_service.py` - 添加灵石使用时的等级检查

### 相关配置文件
1. `configs/spirit_system.json` - 战灵系统配置
2. `configs/items.json` - 物品配置（包含灵石定义）

## 注意事项

1. **等级要求统一**：所有战灵相关功能都要求35级，包括：
   - 查看战灵账户
   - 访问灵件室
   - 开启灵石
   - 装备/卸下战灵
   - 查看幻兽已装备战灵

2. **灵石使用**：灵石只能在背包中打开，不能在其他界面使用

3. **错误提示**：所有等级不足的错误提示统一为"战灵系统需要35级才能解锁"

4. **前后端一致**：前端和后端都有等级检查，确保安全性和用户体验

## 完成状态

✅ 战灵系统35级解锁限制已实现
✅ 战灵灵石背包使用功能已实现
✅ 等级检查已添加到所有关键路由
✅ 错误提示清晰明确
