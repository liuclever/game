# 连胜大奖领取功能修复说明

## 问题描述

连胜竞技场功能中，连胜大奖无法领取。

## 需求说明

### 领取规则

1. **领取时间窗口**：每天00:00-08:00
2. **领取资格**：前一天全服连胜次数最多的玩家
3. **过期机制**：超过08:00后无法领取

### 示例

- 1月12日，张三为全服连胜次数最高玩家
- 1月12日24:00（即1月13日00:00）开始，张三可以领取大奖
- 最晚到1月13日上午08:00，如果还未领取，张三就无法领取1月12日的连胜大奖

## 问题原因

### 原有逻辑的问题

1. **没有时间窗口限制**：任何时间都可以领取
2. **领取当天的大奖**：检查的是当天的连胜王，而不是前一天的
3. **没有过期机制**：超过08:00后仍然可以领取

```python
# 原有逻辑（有问题）
def claim_grand_prize():
    # 获取今日记录
    record = get_today_record(user_id)
    
    # 检查是否已领取
    if record.get('claimed_grand_prize'):
        return jsonify({"ok": False, "error": "今日已领取过连胜大奖"})
    
    # 获取今日全服连胜王（❌ 应该是昨日）
    today = datetime.now().date()
    streak_king = execute_query(
        """SELECT user_id, max_streak_today 
           FROM arena_streak 
           WHERE record_date = %s  -- ❌ 应该是 yesterday
           ORDER BY max_streak_today DESC LIMIT 1""",
        (today,)
    )
    
    # ❌ 没有时间窗口检查
```

## 解决方案

### 1. 修改领取接口

**文件**：`interfaces/routes/arena_streak_routes.py`

**修改内容**：

1. **添加时间窗口检查**：
   ```python
   # 获取当前时间
   now = datetime.now()
   current_hour = now.hour
   
   # 检查是否在领取时间窗口内（00:00-08:00）
   if current_hour >= 8:
       return jsonify({"ok": False, "error": "连胜大奖领取时间为每天00:00-08:00，当前已过期"})
   ```

2. **改为领取前一天的大奖**：
   ```python
   # 计算前一天的日期
   from datetime import timedelta
   yesterday = today - timedelta(days=1)
   
   # 获取前一天的全服连胜王
   streak_king = execute_query(
       """SELECT user_id, max_streak_today 
          FROM arena_streak 
          WHERE record_date = %s  -- 使用 yesterday
          ORDER BY max_streak_today DESC LIMIT 1""",
       (yesterday,)
   )
   ```

3. **检查前一天的领取状态**：
   ```python
   # 检查是否已领取（检查前一天的记录）
   yesterday_record = execute_query(
       """SELECT claimed_grand_prize 
          FROM arena_streak 
          WHERE user_id = %s AND record_date = %s""",
       (user_id, yesterday)
   )
   
   if yesterday_record and yesterday_record[0].get('claimed_grand_prize'):
       return jsonify({"ok": False, "error": "已领取过该大奖"})
   ```

4. **更新前一天的记录**：
   ```python
   # 标记已领取（更新前一天的记录）
   execute_update(
       "UPDATE arena_streak SET claimed_grand_prize = 1 WHERE user_id = %s AND record_date = %s",
       (user_id, yesterday)
   )
   ```

### 2. 修改信息接口

**文件**：`interfaces/routes/arena_streak_routes.py`

**修改内容**：添加昨日连胜王信息和大奖领取状态

```python
# 获取昨日连胜王信息（用于大奖领取）
from datetime import timedelta
yesterday = today - timedelta(days=1)
yesterday_king = execute_query(
    """SELECT p.user_id, p.nickname, a.max_streak_today, a.claimed_grand_prize 
       FROM arena_streak a 
       JOIN player p ON a.user_id = p.user_id 
       WHERE a.record_date = %s 
       ORDER BY a.max_streak_today DESC LIMIT 1""",
    (yesterday,)
)

# 判断当前用户是否是昨日连胜王
is_yesterday_king = False
yesterday_claimed = True
if yesterday_king:
    is_yesterday_king = yesterday_king[0]['user_id'] == user_id
    yesterday_claimed = yesterday_king[0].get('claimed_grand_prize', 0) == 1

# 判断是否在大奖领取时间窗口内（00:00-08:00）
current_hour = now.hour
can_claim_grand_prize = is_yesterday_king and not yesterday_claimed and current_hour < 8

return jsonify({
    # ... 其他字段
    "yesterday_king": {
        "user_id": yesterday_king[0]['user_id'] if yesterday_king else None,
        "nickname": yesterday_king[0]['nickname'] if yesterday_king else "暂无",
        "streak": yesterday_king[0]['max_streak_today'] if yesterday_king else 0
    },
    "is_yesterday_king": is_yesterday_king,
    "can_claim_grand_prize": can_claim_grand_prize,
    "grand_prize_time_window": "00:00-08:00",
    "current_hour": current_hour
})
```

## 领取流程

### 时间线示例

```
1月12日 00:00-23:59
├─ 玩家A挑战连胜竞技场
├─ 玩家A达到10连胜（全服最高）
└─ 玩家A成为1月12日的连胜王

1月13日 00:00-07:59 ✅ 可领取时间窗口
├─ 玩家A可以领取1月12日的连胜大奖
└─ 领取后，1月12日的记录标记为已领取

1月13日 08:00-23:59 ❌ 已过期
└─ 玩家A无法领取1月12日的连胜大奖
```

### 领取条件检查

1. **时间检查**：当前时间 < 08:00
2. **资格检查**：是昨日的连胜王
3. **状态检查**：昨日的大奖未领取
4. **连胜检查**：昨日连胜次数 > 0

## 测试验证

### 1. 运行测试脚本

```bash
python test_grand_prize_time_window.py
```

输出示例：
```
============================================================
连胜大奖时间窗口测试
============================================================

【当前时间】
  日期: 2026-01-26
  时间: 19:54:27
  小时: 19
  昨日: 2026-01-25

【时间窗口检查】
  领取时间窗口: 00:00-08:00
  当前是否在窗口内: 否
  ⚠️  当前时间 19:00 已超过08:00，无法领取大奖

【昨日连胜王】(2026-01-25)
  玩家: 实际上 (ID: 100008)
  连胜次数: 0
  已领取大奖: 否

  【大奖领取状态】
  ❌ 无法领取大奖
     - 原因: 超过领取时间（08:00）
```

### 2. 手动测试步骤

#### 准备工作

1. **创建测试数据**：
   ```sql
   -- 插入昨日的连胜记录
   INSERT INTO arena_streak (user_id, record_date, current_streak, max_streak_today, claimed_rewards, claimed_grand_prize)
   VALUES (100006, DATE_SUB(CURDATE(), INTERVAL 1 DAY), 0, 10, '[]', 0);
   ```

2. **确认测试账号是昨日连胜王**

#### 测试场景1：在时间窗口内（00:00-07:59）

**前置条件**：
- 当前时间：00:00-07:59
- 测试账号是昨日连胜王
- 未领取大奖

**操作**：
1. 登录测试账号
2. 进入连胜竞技场
3. 点击"领取大奖"按钮

**预期结果**：
- ✅ 领取成功
- ✅ 获得奖励：铜钱×600,000、追魂法宝×1、金袋×5、招财神符×1
- ✅ 大奖按钮变为"已领取"

#### 测试场景2：超过时间窗口（08:00-23:59）

**前置条件**：
- 当前时间：08:00-23:59
- 测试账号是昨日连胜王
- 未领取大奖

**操作**：
1. 登录测试账号
2. 进入连胜竞技场
3. 点击"领取大奖"按钮

**预期结果**：
- ❌ 领取失败
- ❌ 提示："连胜大奖领取时间为每天00:00-08:00，当前已过期"

#### 测试场景3：不是连胜王

**前置条件**：
- 测试账号不是昨日连胜王

**操作**：
1. 登录测试账号
2. 进入连胜竞技场

**预期结果**：
- ❌ 大奖按钮显示"[仅连胜王可领取]"
- ❌ 无法点击领取

#### 测试场景4：已领取过

**前置条件**：
- 测试账号是昨日连胜王
- 已领取过大奖

**操作**：
1. 登录测试账号
2. 进入连胜竞技场

**预期结果**：
- ✅ 大奖按钮显示"[已领取]"
- ❌ 无法再次领取

## 部署步骤

### 1. 重启后端服务

```bash
# 停止当前后端服务
# 重新启动
python start-backend.bat
```

### 2. 验证功能

1. **查看当前时间**：
   ```bash
   python test_grand_prize_time_window.py
   ```

2. **如果在时间窗口内（00:00-07:59）**：
   - 登录昨日连胜王账号
   - 进入连胜竞技场
   - 验证可以领取大奖

3. **如果超过时间窗口（08:00-23:59）**：
   - 登录昨日连胜王账号
   - 进入连胜竞技场
   - 验证提示"已过期"

## 修改的文件

1. **interfaces/routes/arena_streak_routes.py**
   - 修改 `claim_grand_prize()` 函数
   - 修改 `get_info()` 函数

2. **test_grand_prize_time_window.py** (新增)
   - 测试脚本

3. **连胜大奖领取功能修复说明.md** (新增)
   - 本文档

## 注意事项

1. **时区问题**：确保服务器时间正确（使用中国时区 UTC+8）
2. **数据一致性**：大奖领取状态存储在前一天的记录中
3. **前端更新**：前端需要根据新的API字段更新显示逻辑
4. **测试时间**：建议在00:00-08:00时间段进行完整测试

## 预期效果

修复后：
- ✅ 只能在00:00-08:00领取大奖
- ✅ 领取的是前一天的大奖
- ✅ 超过08:00后无法领取
- ✅ 前端正确显示领取状态和时间窗口

## 完成状态

✅ 后端逻辑已修改
✅ 时间窗口检查已添加
✅ 测试脚本已创建
✅ 文档已完善
✅ 代码无语法错误

**现在只需要重启后端服务，连胜大奖领取功能就会按照正确的规则运行！**

## 常见问题

### Q1: 为什么要在第二天00:00才能领取？

**A**: 这是游戏设计的规则，确保当天的连胜王确定后（24:00），才能领取奖励。这样可以避免当天连胜次数还在变化时就领取奖励。

### Q2: 为什么要设置08:00的过期时间？

**A**: 这是为了增加游戏的紧迫感和活跃度，鼓励玩家及时登录游戏领取奖励。

### Q3: 如果玩家在08:00前没有领取怎么办？

**A**: 该大奖将永久失效，玩家无法再领取。这是游戏规则的一部分。

### Q4: 如何查看昨日的连胜王是谁？

**A**: 
1. 运行测试脚本：`python test_grand_prize_time_window.py`
2. 或查询数据库：
   ```sql
   SELECT p.nickname, a.max_streak_today
   FROM arena_streak a
   JOIN player p ON a.user_id = p.user_id
   WHERE a.record_date = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
   ORDER BY a.max_streak_today DESC
   LIMIT 1;
   ```

### Q5: 如何测试时间窗口功能？

**A**: 
1. 方法1：等待到00:00-08:00时间段进行测试
2. 方法2：临时修改代码中的时间检查逻辑进行测试
3. 方法3：使用测试脚本模拟不同时间的状态

## 测试账号信息

- **账号**: test50_97355
- **密码**: 123456
- **用户ID**: 100006

可以使用此账号测试连胜大奖功能。
