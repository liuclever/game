# 镇妖宝箱星级命名功能说明

## 功能概述

根据玩家等级，镇妖成功后获得的试炼宝箱和炼狱宝箱将显示不同的星级前缀，体现宝箱的价值等级。

## 星级规则

| 玩家等级 | 星级 | 试炼宝箱名称 | 炼狱宝箱名称 |
|---------|------|------------|------------|
| 30-39级 | 3星 | 3星试炼宝箱 | 3星炼狱宝箱 |
| 40-49级 | 4星 | 4星试炼宝箱 | 4星炼狱宝箱 |
| 50-59级 | 5星 | 5星试炼宝箱 | 5星炼狱宝箱 |
| 60-69级 | 6星 | 6星试炼宝箱 | 6星炼狱宝箱 |
| 70-79级 | 7星 | 7星试炼宝箱 | 7星炼狱宝箱 |
| 80级及以上 | 8星 | 8星试炼宝箱 | 8星炼狱宝箱 |

## 实现逻辑

### 星级计算方法

```python
def _get_chest_star_level(self, player_level: int) -> int:
    """根据玩家等级获取宝箱星级"""
    if player_level < 30:
        return 0  # 30级以下无星级
    elif player_level < 40:
        return 3  # 30-39级: 3星
    elif player_level < 50:
        return 4  # 40-49级: 4星
    elif player_level < 60:
        return 5  # 50-59级: 5星
    elif player_level < 70:
        return 6  # 60-69级: 6星
    elif player_level < 80:
        return 7  # 70-79级: 7星
    else:
        return 8  # 80级及以上: 8星
```

### 宝箱命名逻辑

```python
# 根据玩家等级确定宝箱星级
star_level = self._get_chest_star_level(player_level)
star_prefix = f"{star_level}星" if star_level > 0 else ""

# 生成宝箱名称
chest_base_name = "试炼宝箱" if is_trial else "炼狱宝箱"
chest_name = f"{star_prefix}{chest_base_name}"
```

## 使用场景

### 场景1：试炼层奖励
- 玩家等级：35级
- 占领层数：31层（试炼层）
- 获得宝箱：**3星试炼宝箱**

### 场景2：炼狱层奖励
- 玩家等级：55级
- 占领层数：71层（炼狱层）
- 获得宝箱：**5星炼狱宝箱**

### 场景3：高等级玩家
- 玩家等级：85级
- 占领层数：131层（试炼层）
- 获得宝箱：**8星试炼宝箱**

## 奖励发放流程

```
玩家占领镇妖层
    ↓
占领时长到期（30分钟）
    ↓
系统检查并发放奖励
    ↓
获取玩家当前等级
    ↓
计算宝箱星级
    ↓
生成带星级的宝箱名称
    ↓
发放到玩家背包
    ↓
显示奖励提示
```

## 前端显示

### 奖励提示
```
镇妖成功！获得 3星试炼宝箱 x1
镇妖成功！获得 5星炼狱宝箱 x1
```

### 背包显示
- 宝箱名称显示星级前缀
- 例如：3星试炼宝箱、5星炼狱宝箱

### 动态消息
```
玩家【张三】占领第31层成功，获得3星试炼宝箱
玩家【李四】占领第71层成功，获得5星炼狱宝箱
```

## 数据结构

### 奖励返回数据
```python
{
    "chest_item_id": 92001,           # 宝箱物品ID
    "chest_name": "3星试炼宝箱",       # 宝箱名称（带星级）
    "is_trial": True,                 # 是否试炼层
    "floor": 31,                      # 层数
    "star_level": 3                   # 星级
}
```

## 注意事项

1. **星级基于玩家等级**
   - 星级在奖励发放时确定
   - 基于玩家当前等级，不是占领时的等级

2. **宝箱物品ID不变**
   - 试炼宝箱：92001
   - 炼狱宝箱：92002
   - 只是显示名称不同

3. **30级以下无星级**
   - 30级以下玩家无法镇妖
   - 如果有特殊情况，显示为"试炼宝箱"（无星级前缀）

4. **星级不影响宝箱内容**
   - 星级仅用于显示区分
   - 宝箱内容由配置文件决定
   - 不同星级可以配置不同奖励

## 测试验证

### 测试脚本
```bash
python test_zhenyao_chest_star_level.py
```

### 测试内容
1. 星级计算逻辑测试
   - 测试各等级段的星级计算
   - 验证边界值（30、40、50、60、70、80级）

2. 宝箱命名规则测试
   - 验证各等级段的宝箱名称
   - 确认星级前缀正确

3. 奖励发放模拟
   - 模拟不同等级玩家占领不同层
   - 验证宝箱名称生成正确

### 测试结果
```
✓ 30级: 3星试炼宝箱
✓ 35级: 3星试炼宝箱
✓ 40级: 4星试炼宝箱
✓ 50级: 5星试炼宝箱
✓ 60级: 6星试炼宝箱
✓ 70级: 7星试炼宝箱
✓ 80级: 8星试炼宝箱
✓ 85级: 8星试炼宝箱
```

## 相关文件

### 后端
- `application/services/zhenyao_service.py` - 镇妖服务（主要修改）
  - `_grant_zhenyao_reward()` - 奖励发放方法
  - `_get_chest_star_level()` - 星级计算方法

### 测试
- `test_zhenyao_chest_star_level.py` - 星级命名测试脚本

### 配置
- `configs/zhenyao_rewards.json` - 镇妖奖励配置（可选）

## 扩展建议

### 1. 宝箱内容差异化
可以根据星级配置不同的宝箱内容：
```json
{
  "3_star_trial": {
    "gold": 10000,
    "items": [(6101, 1)]
  },
  "4_star_trial": {
    "gold": 15000,
    "items": [(6101, 2)]
  },
  ...
}
```

### 2. 星级显示优化
- 前端可以添加星级图标
- 不同星级使用不同颜色
- 添加星级动画效果

### 3. 统计功能
- 统计玩家获得各星级宝箱的数量
- 显示宝箱获取历史
- 添加成就系统

## 总结

镇妖宝箱星级命名功能已完整实现：
1. ✓ 根据玩家等级自动计算星级（3-8星）
2. ✓ 生成带星级前缀的宝箱名称
3. ✓ 试炼宝箱和炼狱宝箱都支持星级
4. ✓ 测试脚本验证功能正确
5. ✓ 星级规则清晰明确

玩家在镇妖成功后，将根据自己的等级获得相应星级的宝箱，体现了等级差异和成就感。
