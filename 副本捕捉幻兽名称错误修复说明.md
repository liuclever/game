# 副本捕捉幻兽名称错误修复说明

## 问题描述

用户反馈：
1. 打败的是羽精灵，但捕捉时变成了追风狼
2. 战斗显示"血螳螂 vs 呼啸平原"，但捕捉显示"精英·追风狼"
3. 应该打败什么宠物，捕捉时就应该是什么宠物

## 问题分析

### 问题1：战斗对手显示错误

战斗结果页面显示：`{{ battleData.player_beast }} vs {{ battleData.dungeon_name }}`

这里使用的是 `dungeon_name`（副本名称），而不是敌方幻兽名称，导致显示"vs 呼啸平原"这样的错误信息。

**文件**：`interfaces/client/src/features/dungeon/DungeonBattleResultPage.vue` 第212行

### 问题2：捕捉幻兽名称错误

后端返回的 `capturable_beast` 使用的是前端传入的配置数据第一个幻兽的名称，而不是实际参与战斗的幻兽名称。

**文件**：`interfaces/routes/dungeon_routes.py` 第1055行（修改前）

## 修复方案

### 修复1：后端返回正确的捕捉幻兽名称 ✅

**文件**：`interfaces/routes/dungeon_routes.py`

**修改位置**：`challenge_beasts` 函数

**修改前**：
```python
"capturable_beast": dungeon_beasts_data[0]['name'] if (is_victory and floor not in BOSS_FLOORS) else None
```

**修改后**：
```python
# 获取实际战斗的第一个幻兽名称（用于捕捉）
actual_beast_name = None
if is_victory and floor not in BOSS_FLOORS and defender_pvp_beasts:
    actual_beast_name = defender_pvp_beasts[0].name

# ... 在返回的 JSON 中使用
"capturable_beast": actual_beast_name
```

### 修复2：前端显示正确的战斗对手名称（建议）

**文件**：`interfaces/client/src/features/dungeon/DungeonBattleResultPage.vue`

**当前代码**（第212行）：
```vue
{{ battleData.player_name }}｜{{ battleData.player_beast }} vs {{ battleData.dungeon_name }}
```

**建议修改为**：
```vue
{{ battleData.player_name }}｜{{ battleData.player_beast }} vs {{ battleData.beasts?.[0]?.name || battleData.dungeon_name }}
```

或者更好的方案，后端在 `battle_data` 中添加 `enemy_beast_name` 字段：

```python
battle_data = {
    # ... 其他字段
    "enemy_beast_name": defender_pvp_beasts[0].name if defender_pvp_beasts else dungeon_name,
}
```

前端使用：
```vue
{{ battleData.player_name }}｜{{ battleData.player_beast }} vs {{ battleData.enemy_beast_name }}
```

## 重要提示

### ⚠️ 必须重启后端服务

修改后端代码后，**必须重启 Flask 服务**才能生效：

```bash
# 方法1：使用重启脚本
restart_flask.bat

# 方法2：手动重启
# 1. 停止当前运行的 Python 进程
taskkill /F /IM python.exe

# 2. 重新启动后端
start-backend.bat
```

### ⚠️ 清除浏览器缓存

修改前端代码后，建议清除浏览器缓存：

- 按 `Ctrl + F5` 强制刷新页面
- 或者清除浏览器缓存（Ctrl + Shift + Delete）

## 测试步骤

1. **重启后端服务**
   ```bash
   restart_flask.bat
   ```

2. **清除浏览器缓存**
   - 按 `Ctrl + F5` 强制刷新

3. **进入副本测试**
   - 进入任意副本（例如：天罚山）
   - 查看当前层的幻兽名称（例如：精英·羽精灵）
   - 点击"挑战幻兽"

4. **验证战斗结果**
   - 战斗胜利后，查看战斗结果页面
   - 确认显示的捕捉幻兽名称与战斗的幻兽一致
   - 例如：战斗的是"精英·羽精灵"，捕捉显示也应该是"精英·羽精灵"

5. **验证捕捉功能**
   - 点击"捕捉"按钮
   - 确认捕捉页面显示的幻兽名称正确
   - 使用捕捉球进行捕捉
   - 捕捉成功后，检查获得的幻兽是否正确

## 测试脚本

运行以下脚本验证配置和数据：

```bash
python test_dungeon_capture_beast_name.py
```

该脚本会：
1. 检查副本配置文件
2. 显示各副本的幻兽列表
3. 检查玩家当前的副本进度
4. 模拟随机选择幻兽的过程

## 相关文件

### 后端文件
- `interfaces/routes/dungeon_routes.py` - 副本路由（已修复）
  - `challenge_beasts()` 函数：处理副本挑战
  - `_to_pvp_beasts_from_config()` 函数：转换幻兽数据

### 前端文件
- `interfaces/client/src/features/dungeon/DungeonBattleResultPage.vue` - 战斗结果页面
- `interfaces/client/src/features/dungeon/DungeonCapturePage.vue` - 捕捉页面
- `interfaces/client/src/features/dungeon/DungeonChallengePage.vue` - 副本挑战页面

### 配置文件
- `configs/dungeon_beasts.json` - 副本幻兽配置

### 测试脚本
- `test_dungeon_capture_beast_name.py` - 测试捕捉幻兽名称
- `diagnose_dungeon_battle.py` - 诊断副本战斗数据

## 注意事项

1. **幻兽名称格式**：
   - 普通幻兽：直接使用名称（例如："黑灵鸟"）
   - 精英幻兽：带有"精英·"前缀（例如："精英·羽精灵"）
   - BOSS：不可捕捉

2. **捕捉限制**：
   - 只有胜利后才能捕捉
   - BOSS 层不可捕捉
   - 宝箱事件层不可捕捉

3. **数据一致性**：
   - 前端传递的 `beasts` 数据必须与实际显示的幻兽一致
   - 后端使用 `defender_pvp_beasts[0].name` 确保返回实际战斗的幻兽名称

## 已知问题

如果问题仍然存在，可能的原因：

1. **后端服务未重启** - 最常见的原因
2. **前端缓存** - 浏览器缓存了旧版本的代码
3. **数据传递错误** - 前端传递的幻兽数据与显示的不一致
4. **配置文件错误** - `dungeon_beasts.json` 中的幻兽名称配置错误

## 排查步骤

如果修复后问题仍然存在：

1. 检查后端日志，确认代码是否执行了新的逻辑
2. 在浏览器开发者工具中查看网络请求，检查返回的 `capturable_beast` 值
3. 运行 `test_dungeon_capture_beast_name.py` 检查配置
4. 检查前端传递给后端的 `beasts` 数据是否正确
