# 闯塔界面问题修复方案

## 问题清单

### 问题1：鼓舞丹删除不够彻底 ❌
**现象**：闯塔界面仍然显示鼓舞相关的内容

**检查结果**：
- ✅ 前端代码中鼓舞相关代码已注释（TowerPage.vue 第266-276行）
- ❌ 后端API接口仍然存在（tower_routes.py 第257-367行）
- ❌ 简介页面仍然提到鼓舞丹（TowerIntroPage.vue）
- ❌ 挑战页面仍然显示鼓舞状态（TowerChallengePage.vue 第370-372行）

### 问题2：战灵塔35级解锁 ✅
**现象**：需要确认战灵塔是否在35级解锁

**检查结果**：
- ✅ 战灵系统已正确设置35级解锁（spirit_service.py 第58、91、161行）
- ✅ 前端战灵页面已正确检查35级（BeastSpiritPage.vue 第106、144、162行）
- ✅ 战灵嵌入页面已正确检查35级（SpiritEmbedPage.vue 第40行）
- ⚠️ 战灵塔本身没有等级限制，只是战灵系统需要35级

**说明**：战灵塔可以在任何等级闯，但战灵系统（战灵仓库、嵌入等功能）需要35级才能解锁。

### 问题3：灵力水晶无法打开变成灵力 ❌
**现象**：灵力水晶无法使用/打开来获得灵力

**检查结果**：
- ❌ 灵力水晶（ID 6101）类型为 `material`（材料）
- ❌ `can_use_or_open_item` 方法中只处理了声望石（ID 12001），没有处理灵力水晶
- ❌ `use_item` 方法中没有灵力水晶的使用逻辑
- ❌ 没有灵力水晶兑换灵力的功能

## 修复方案

### 修复1：彻底删除鼓舞丹相关代码

#### 1.1 删除后端API接口
**文件**：`interfaces/routes/tower_routes.py`

删除第257-367行的鼓舞系统代码：
```python
# ===== 鼓舞系统 =====
INSPIRE_DURATION_SECONDS = 30 * 60
INSPIRE_PILL_ITEM_ID = 8001

@tower_bp.get("/tower/inspire/status")
def get_inspire_status():
    # ... 删除整个函数

@tower_bp.post("/tower/inspire/use")
def use_inspire_pill():
    # ... 删除整个函数
```

#### 1.2 删除简介页面的鼓舞丹说明
**文件**：`interfaces/client/src/features/tower/TowerIntroPage.vue`

删除所有提到"鼓舞丹"的规则说明（第20、31、57行）：
```javascript
// 删除这一行
'可消耗鼓舞丹强化闯塔幻兽实力',
```

#### 1.3 删除挑战页面的鼓舞显示
**文件**：`interfaces/client/src/features/tower/TowerChallengePage.vue`

删除第370-372行的鼓舞显示：
```vue
<!-- 删除这段代码 -->
<div class="section">
  鼓舞: <a class="link">{{ buffEnabled ? '开启' : '关闭' }}</a>
  <span class="gray"> (闯塔战斗力加成{{ buffBonus }}%)</span>
</div>
```

#### 1.4 清理前端代码中的鼓舞相关变量和函数
**文件**：`interfaces/client/src/features/tower/TowerPage.vue`

删除第32-148行的鼓舞相关代码：
```javascript
// 删除鼓舞状态
const inspireStatus = ref({ ... })

// 删除鼓舞相关函数
const loadInspireStatus = async () => { ... }
const startInspireCountdown = () => { ... }
const formatInspireTime = computed(() => { ... })
const useInspirePill = async () => { ... }
```

### 修复2：战灵塔35级解锁（已正确实现）✅

**当前状态**：
- 战灵系统（仓库、嵌入）已正确设置35级解锁
- 战灵塔本身可以在任何等级闯

**建议**：
如果需要战灵塔也在35级解锁，可以在前端添加检查：

**文件**：`interfaces/client/src/features/tower/TowerPage.vue`

```javascript
const switchTower = async (type) => {
  // 战灵塔需要35级解锁
  if (type === 'zhanling') {
    const playerRes = await http.get('/player/info')
    const playerLevel = playerRes.data.player?.level || 0
    if (playerLevel < 35) {
      showMessage('战灵塔需要35级才能解锁', 'info')
      return
    }
  }
  
  // 测试模式下禁止访问战灵塔
  if (type === 'zhanling') {
    const isTest = await checkTestMode()
    if (isTest) {
      showMessage('测试模式下战灵塔未开放', 'info')
      return
    }
  }
  
  currentTower.value = type
  await loadTowerInfo()
}
```

### 修复3：实现灵力水晶兑换灵力功能

#### 3.1 修改物品类型或添加使用逻辑

**方案A：修改物品类型为 consumable**

**文件**：`configs/items.json`

```json
{
  "id": 6101,
  "name": "灵力水晶",
  "type": "consumable",  // 改为 consumable
  "description": "战灵系统材料：使用后获得100点灵力",
  "stackable": true,
  "max_stack": 9999
}
```

**方案B：在 material 类型中添加灵力水晶的处理**（推荐）

**文件**：`application/services/inventory_service.py`

在 `can_use_or_open_item` 方法中添加：
```python
# material类型中，声望石和灵力水晶可以使用
if item_template.type == "material":
    if item_template.id == 12001:  # 声望石
        return (True, "使用")
    if item_template.id == 6101:  # 灵力水晶
        return (True, "使用")
```

#### 3.2 实现灵力水晶使用逻辑

**文件**：`application/services/inventory_service.py`

在 `use_item` 方法中添加灵力水晶的处理：

```python
def use_item(self, user_id: int, inv_item_id: int, quantity: int = 1) -> dict:
    """使用背包中的物品"""
    
    # ... 现有代码 ...
    
    # 灵力水晶：使用后获得灵力
    if item_template.id == 6101:  # 灵力水晶
        return self._use_spirit_crystal(user_id, inv_item_id, quantity, item_template)
    
    # ... 其他物品处理 ...

def _use_spirit_crystal(
    self, user_id: int, inv_item_id: int, quantity: int, item_template
) -> dict:
    """使用灵力水晶获得灵力"""
    
    # 每个灵力水晶兑换100点灵力
    SPIRIT_POWER_PER_CRYSTAL = 100
    
    # 获取战灵账户
    from application.services.spirit_service import SpiritService
    from infrastructure.db.spirit_account_repo_mysql import MySQLSpiritAccountRepo
    from infrastructure.db.spirit_repo_mysql import MySQLSpiritRepo
    from infrastructure.config.spirit_system_config import get_spirit_system_config
    
    spirit_service = SpiritService(
        account_repo=MySQLSpiritAccountRepo(),
        spirit_repo=MySQLSpiritRepo(),
        config=get_spirit_system_config(),
        player_repo=self.player_repo,
        tower_state_repo=None,
    )
    
    # 检查等级限制（35级才能使用战灵系统）
    player = self.player_repo.get_by_id(user_id)
    if not player or (player.level or 0) < 35:
        return {
            "ok": False,
            "error": "战灵系统需要35级才能解锁，灵力水晶暂时无法使用"
        }
    
    # 获取或创建战灵账户
    acc = spirit_service.get_account(user_id)
    
    # 增加灵力
    gained_power = quantity * SPIRIT_POWER_PER_CRYSTAL
    acc.spirit_power += gained_power
    spirit_service.account_repo.save(acc)
    
    # 扣除灵力水晶
    self._remove_item_from_slot(inv_item_id, quantity)
    
    return {
        "ok": True,
        "message": f"使用{quantity}个灵力水晶，获得{gained_power}点灵力",
        "gained_spirit_power": gained_power,
        "total_spirit_power": acc.spirit_power,
        "used_quantity": quantity,
    }
```

#### 3.3 配置灵力兑换比例

建议在配置文件中定义兑换比例：

**文件**：`configs/spirit_system.json`

```json
{
  "spirit_crystal_exchange": {
    "item_id": 6101,
    "spirit_power_per_crystal": 100,
    "min_level": 35
  }
}
```

## 修改文件清单

### 必须修改（鼓舞丹删除）
1. ❌ `interfaces/routes/tower_routes.py` - 删除鼓舞API接口
2. ❌ `interfaces/client/src/features/tower/TowerIntroPage.vue` - 删除鼓舞丹说明
3. ❌ `interfaces/client/src/features/tower/TowerChallengePage.vue` - 删除鼓舞显示
4. ❌ `interfaces/client/src/features/tower/TowerPage.vue` - 删除鼓舞相关代码

### 必须修改（灵力水晶）
5. ❌ `application/services/inventory_service.py` - 添加灵力水晶使用逻辑
6. ⚠️ `configs/items.json` - 可选：修改物品描述

### 可选修改（战灵塔等级限制）
7. ⚠️ `interfaces/client/src/features/tower/TowerPage.vue` - 添加35级检查

## 测试验证

### 测试1：鼓舞丹删除
1. 访问闯塔界面
2. 检查是否还有鼓舞相关的显示
3. 查看简介页面是否还提到鼓舞丹
4. 尝试访问 `/tower/inspire/status` 接口（应该返回404）

### 测试2：战灵塔等级限制
1. 使用低于35级的账号
2. 尝试切换到战灵塔
3. 应该提示"战灵塔需要35级才能解锁"

### 测试3：灵力水晶使用
1. 获得一些灵力水晶（物品ID 6101）
2. 在背包中点击"使用"
3. 应该能成功使用并获得灵力
4. 检查战灵账户的灵力是否增加

## 注意事项

1. **鼓舞丹物品**：如果玩家背包中还有鼓舞丹（ID 8001），删除功能后将无法使用
2. **数据库字段**：player 表中的 `inspire_expire_time` 字段可以保留，不影响功能
3. **灵力兑换比例**：建议每个灵力水晶兑换100点灵力，可根据游戏平衡调整
4. **等级限制**：战灵系统需要35级，灵力水晶也应该在35级才能使用

## 总结

**问题1：鼓舞丹删除不够彻底**
- 需要删除后端API接口
- 需要删除前端显示和相关代码
- 需要更新简介页面

**问题2：战灵塔35级解锁**
- 战灵系统已正确设置35级解锁 ✅
- 战灵塔本身没有等级限制
- 可选：添加战灵塔35级解锁检查

**问题3：灵力水晶无法使用**
- 需要在 `can_use_or_open_item` 中添加灵力水晶
- 需要实现灵力水晶使用逻辑
- 建议每个灵力水晶兑换100点灵力
- 需要35级才能使用（与战灵系统一致）
