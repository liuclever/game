# 盟战土地对战功能使用说明

## 功能概述

本功能实现了盟战土地争夺的完整对战流程，包括：
1. 联盟配对：将报名同一土地的联盟进行配对
2. 执行对战：逐回合执行玩家之间的决斗
3. 占领土地：最终胜利者自动占领土地

## 使用方法

### 方法1：通过API接口（推荐）

#### 1.1 配对联盟并创建对战
```bash
POST /api/alliance/war/lock-and-pair/<land_id>
```

**示例：**
```bash
curl -X POST http://localhost:5000/api/alliance/war/lock-and-pair/1 \
  -H "Cookie: session=your_session_cookie"
```

**返回：**
```json
{
  "ok": true,
  "battles": [
    {
      "battle_id": 1,
      "left_alliance_id": 1,
      "right_alliance_id": 2,
      "left_count": 5,
      "right_count": 3
    }
  ],
  "bye_allocation": {
    "registration_id": 3,
    "alliance_id": 3,
    "bye_waiting_round": 1
  }
}
```

#### 1.2 推进对战回合
```bash
POST /api/alliance/war/advance-round/<battle_id>
```

**示例：**
```bash
curl -X POST http://localhost:5000/api/alliance/war/advance-round/1 \
  -H "Cookie: session=your_session_cookie"
```

**返回：**
```json
{
  "ok": true,
  "battle_finished": false,
  "round": {
    "round_no": 1,
    "left_alive": 3,
    "right_alive": 2,
    "duel_count": 2,
    "duels": [...]
  }
}
```

#### 1.3 执行完整对战流程（推荐）
```bash
POST /api/alliance/war/run-battle/<land_id>
```

这个接口会自动执行：
1. 配对联盟
2. 执行所有对战的所有回合直到结束
3. 最终胜利者自动占领土地

**示例：**
```bash
curl -X POST http://localhost:5000/api/alliance/war/run-battle/1 \
  -H "Cookie: session=your_session_cookie"
```

**返回：**
```json
{
  "ok": true,
  "message": "成功执行 2 场对战",
  "pair_result": {...},
  "battle_results": [
    {
      "battle_id": 1,
      "left_alliance_id": 1,
      "right_alliance_id": 2,
      "status": "finished",
      "rounds_executed": 3,
      "final_round": {...}
    }
  ]
}
```

### 方法2：通过执行脚本

```bash
python scripts/run_alliance_war_battle.py <land_id> [land_id2] ...
```

**示例：**
```bash
# 执行土地ID为1的对战
python scripts/run_alliance_war_battle.py 1

# 执行多个土地的对战
python scripts/run_alliance_war_battle.py 1 2 3 4
```

**输出示例：**
```
============================================================
开始执行土地 1 的对战流程
============================================================

[步骤1] 配对联盟...
✅ 成功配对 2 场对战

[步骤2] 执行对战...

  对战 1/2 (ID: 1)
    联盟 1 (5人) vs 联盟 2 (3人)
    回合 1: 左方存活 4 人, 右方存活 2 人 (决斗 2 场)
    回合 2: 左方存活 3 人, 右方存活 1 人 (决斗 1 场)
    回合 3: 左方存活 3 人, 右方存活 0 人 (决斗 1 场)
    ✅ 对战结束！胜利方: 联盟 1

[步骤3] 检查土地占领情况...
✅ 土地 1 已被联盟 测试联盟 (ID: 1) 占领

============================================================
对战执行完成
  总对战数: 2
  成功完成: 2
  执行失败: 0
============================================================
```

## 对战流程说明

### 1. 报名阶段
- 盟主或副盟主报名土地/据点
- 联盟成员签到加入军队
- 系统根据玩家等级分配飞龙军或伏虎军

### 2. 配对阶段
- 系统将所有已确认报名的联盟进行随机配对
- 如果报名数为奇数，会有一个联盟轮空
- 创建对战记录和第一回合

### 3. 对战阶段
- 每回合：从双方各选一个可用玩家进行决斗
- 决斗使用PVP战斗引擎，基于幻兽属性计算胜负
- 失败方玩家被淘汰，胜利方玩家继续参战
- 重复直到一方所有玩家被淘汰

### 4. 占领阶段
- 对战结束后，胜利方联盟状态变为 `STATUS_VICTOR`
- 系统检查该土地是否还有其他活跃的报名
- 如果没有，最终胜利者自动占领土地
- 更新联盟战功和赛季积分

## 注意事项

1. **需要至少2个联盟报名才能配对**
   - 如果只有1个联盟报名，配对会失败
   - 可以通过 `bye_allocation` 查看轮空情况

2. **对战时间限制**
   - 根据盟战规则，对战应在指定时间内进行
   - 周三20:00-22:00 或 周六20:00-22:00

3. **土地占领条件**
   - 只有最终胜利者（没有其他活跃报名）才能占领
   - 如果有多场对战，需要等所有对战都结束

4. **玩家参战要求**
   - 玩家需要有出战幻兽才能参战
   - 没有幻兽的玩家会被自动判负

## 相关文件

- **服务层**: `application/services/alliance_battle_service.py`
- **路由层**: `interfaces/routes/alliance_routes.py`
- **执行脚本**: `scripts/run_alliance_war_battle.py`
- **实体定义**: `domain/entities/alliance_registration.py`

## 测试建议

1. 创建至少2个联盟
2. 每个联盟至少有1个成员
3. 成员需要有出战幻兽
4. 盟主报名同一块土地
5. 成员签到加入军队
6. 调用对战接口或执行脚本
