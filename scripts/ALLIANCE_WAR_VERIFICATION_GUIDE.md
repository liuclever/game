# 盟战功能验证指南

## 一、验证范围

本文档用于验证以下两个功能模块：

1. **盟战对战规则（规则6）**
   - A联盟的伏虎队与B联盟的伏虎队按排名1v1对战
   - A联盟的飞龙军与B联盟的飞龙军按排名1v1对战
   - 胜利的联盟获得1个联盟战功
   - 土地/据点的争夺规则和匹配机制

2. **联盟战功排行（规则7）**
   - 每月赛季排行（前3名）
   - 赛季结束奖励发放
   - 首页排行榜显示

---

## 二、测试环境准备

### 2.1 启动服务

```bash
# 1. 激活虚拟环境（如果使用）
.venv\Scripts\activate  # Windows
# 或
source .venv/bin/activate  # Linux/Mac

# 2. 启动后端服务
python -m interfaces.web_api.app

# 3. 启动前端服务（另开一个终端）
cd interfaces/client
npm run dev
```

### 2.2 准备测试数据

```bash
# 生成测试数据（如果还没有）
python scripts/create_alliance_war_test_data.py
```

### 2.3 测试账号

- **盟主账号**（用于报名和管理）：
  - `test_war_20001` ~ `test_war_20005`（密码：123456）
  - 每个账号对应一个测试联盟

- **普通成员账号**（用于签到和查看）：
  - `test_war_20006` ~ `test_war_20050`（密码：123456）

---

## 三、验证项目1：盟战对战规则

### 3.1 验证目标

验证以下规则：
1. A联盟的伏虎队与B联盟的伏虎队按排名1v1依次对战
2. A联盟的飞龙军与B联盟的飞龙军按排名1v1依次对战
3. 直到一方军队全部被打败，判定另一方胜利
4. 胜利的联盟获得1个联盟战功
5. 土地/据点争夺：多联盟报名时，系统随机匹配，奇数时有一方轮空

### 3.2 验证步骤

#### 步骤1：准备多个联盟报名

1. **使用盟主账号登录**（例如：`test_war_20001`）
2. **进入盟战页面**：点击"盟战" → 查看规则和时间安排
3. **报名土地/据点**：
   - 飞龙军只能选择土地（迷雾城1号土地或飞龙港1号土地）
   - 伏虎军只能选择据点（幻灵镇1号据点或定老城1号据点）
4. **重复步骤1-3**，使用其他盟主账号（`test_war_20002`、`test_war_20003`、`test_war_20004`）报名**同一个**土地/据点

**预期结果**：
- 多个联盟成功报名同一个土地/据点
- 报名状态显示正确

#### 步骤2：成员签到

1. **使用成员账号登录**（例如：`test_war_20006`）
2. **进入盟战页面**
3. **报名加入军队**（如果还没报名）：
   - 点击"报名"按钮，系统根据等级自动分配到飞龙军或伏虎军
4. **签到**：
   - 在签到时间内，点击"签到"按钮
   - 确认获得30000铜钱

**重复步骤1-4**，让多个联盟的成员都完成签到。

**预期结果**：
- 成员可以成功报名和签到
- 签到后获得30000铜钱
- 签到状态显示正确

#### 步骤3：查看对战匹配

**说明**：对战匹配通常由后台定时任务或管理接口触发，具体触发方式需要查看代码实现。

1. **使用盟主账号登录**
2. **查看对战状态**：
   - 进入"联盟战绩"页面
   - 查看当前的对战匹配情况

**预期结果**：
- 如果有2个联盟报名，显示1场对战
- 如果有3个联盟报名，显示1场对战+1个轮空
- 如果有4个联盟报名，显示2场对战

#### 步骤4：验证对战规则

1. **查看对战详情**（如果有对战详情页面）：
   - 查看伏虎队对战：A联盟伏虎队成员1 vs B联盟伏虎队成员1
   - 查看飞龙军对战：A联盟飞龙军成员1 vs B联盟飞龙军成员1
   - 确认按照排名顺序依次对战

2. **验证胜负判定**：
   - 当一方军队全部被打败时，另一方获胜
   - 验证胜利方联盟获得1个联盟战功

**预期结果**：
- 对战按照1v1规则进行
- 胜负判定正确
- 战功正确发放

#### 步骤5：验证土地/据点归属

1. **查看最终胜者**：
   - 进入"联盟战绩"页面
   - 查看土地/据点的最终占领联盟

2. **验证多轮对战**：
   - 如果有4个联盟报名，应该先两两对战，然后胜者再对战
   - 最终只有一个联盟获得土地/据点

**预期结果**：
- 土地/据点归属最终胜者联盟
- 多轮对战流程正确

---

## 四、验证项目2：联盟战功排行

### 4.1 验证目标

验证以下功能：
1. 每月赛季排行榜（前3名）
2. 排行榜实时更新
3. 首页显示前3名联盟（名字和等级）
4. 赛季结束奖励发放

### 4.2 验证步骤

#### 步骤1：查看联盟战功排行

1. **使用任意账号登录**
2. **进入盟战页面**：点击"盟战"
3. **查看排行榜**：点击"盟战排行榜"
4. **检查排行信息**：
   - 查看前3名的联盟名称
   - 查看联盟等级
   - 查看战功数量

**预期结果**：
- 排行榜按战功数量降序排列
- 显示联盟名称、等级、战功数量
- 数据实时更新

#### 步骤2：验证首页排行榜显示

1. **使用任意账号登录**
2. **进入游戏首页**
3. **查看排行榜区域**：
   - 在"常用功能"上方，找到"【联盟战功排行】"区域
   - 查看显示的联盟信息

**预期结果**：
- 显示前3名联盟
- 显示联盟名称和等级
- 如果没有数据，显示"暂无排名"
- 数据实时更新

#### 步骤3：验证赛季奖励规则

**说明**：赛季奖励通常在每月最后一天自动发放，也可以通过管理接口手动触发。

1. **查看赛季奖励配置**：
   - 第一名：100w铜钱，1追魂法宝
   - 第二名：70w铜钱
   - 第三名：40w铜钱

2. **验证奖励发放**（需要查看代码或日志）：
   - 确认奖励发放到联盟成员账户
   - 确认奖励数量正确

**预期结果**：
- 奖励在赛季结束后自动发放
- 奖励数量和物品正确
- 所有联盟成员都收到奖励

#### 步骤4：验证排行榜数据准确性

1. **使用不同账号登录**，查看排行榜
2. **对比不同联盟的战功数量**
3. **确认排名顺序**：
   - 第1名战功最多
   - 第2名战功次之
   - 第3名战功第三

**预期结果**：
- 排行榜数据准确
- 排名顺序正确
- 所有用户看到的排行榜一致

---

## 五、验证检查清单

### 5.1 对战规则检查项

- [ ] 多个联盟可以报名同一个土地/据点
- [ ] 成员可以报名加入军队（飞龙军或伏虎军）
- [ ] 成员可以在签到时间内签到并获得奖励
- [ ] 对战按照1v1规则进行（伏虎队 vs 伏虎队，飞龙军 vs 飞龙军）
- [ ] 对战按照排名顺序进行
- [ ] 一方军队全部被打败时，另一方获胜
- [ ] 胜利方联盟获得1个联盟战功
- [ ] 多联盟报名时，系统正确匹配（2个对战1场，3个对战1场+1轮空，4个对战2场+胜者再战）
- [ ] 土地/据点归属最终胜者联盟

### 5.2 排行榜检查项

- [ ] 排行榜页面可以正常访问
- [ ] 排行榜按战功数量降序排列
- [ ] 排行榜显示联盟名称、等级、战功数量
- [ ] 首页排行榜区域显示前3名联盟
- [ ] 首页显示联盟名称和等级
- [ ] 首页排行榜实时更新
- [ ] 排行榜数据准确（排名顺序正确）
- [ ] 赛季奖励配置正确（第1名：100w铜钱+1追魂法宝，第2名：70w铜钱，第3名：40w铜钱）
- [ ] 赛季奖励可以正常发放（需要验证后台功能）

---

## 六、常见问题排查

### 6.1 对战相关问题

**问题1：无法看到对战匹配**
- 检查是否在盟战时间内
- 检查是否有多于1个联盟报名
- 检查后台是否触发了匹配流程

**问题2：对战规则不符合预期**
- 检查成员是否已签到
- 检查成员是否已加入军队
- 检查对战日志和状态

### 6.2 排行榜相关问题

**问题1：排行榜不显示数据**
- 检查是否有联盟获得过战功
- 检查数据库表 `alliance_war_scores` 是否有数据
- 检查当前月份是否在赛季范围内

**问题2：首页排行榜不显示**
- 检查前端代码是否正确调用API
- 检查API `/api/alliance/war/top3` 是否正常返回数据
- 检查浏览器控制台是否有错误

**问题3：排行榜数据不准确**
- 检查战功数据是否正确记录
- 检查排行计算逻辑是否正确
- 检查数据是否实时更新

---

## 七、数据库验证

### 7.1 关键表检查

```sql
-- 查看联盟战功数据
SELECT alliance_id, war_honor, war_honor_history FROM alliances ORDER BY war_honor_history DESC LIMIT 10;

-- 查看赛季排行数据
SELECT * FROM alliance_war_scores WHERE season_key = '2026-01' ORDER BY score DESC LIMIT 10;

-- 查看对战记录
SELECT * FROM alliance_land_battles ORDER BY created_at DESC LIMIT 10;

-- 查看报名记录
SELECT * FROM alliance_land_registrations ORDER BY registration_time DESC LIMIT 10;
```

### 7.2 数据验证要点

- **联盟战功**：检查 `alliances.war_honor` 和 `alliances.war_honor_history` 是否正确
- **赛季积分**：检查 `alliance_war_scores` 表中的数据是否正确
- **对战记录**：检查 `alliance_land_battles` 表中的对战数据
- **报名记录**：检查 `alliance_land_registrations` 表中的报名数据

---

## 八、API接口验证

### 8.1 关键接口

- **获取排行榜前3名**：`GET /api/alliance/war/top3`
- **获取盟战信息**：`GET /api/alliance/war/info`
- **查看排行榜**：`GET /api/alliance/war/ranking`
- **查看战绩**：`GET /api/alliance/war/battle-records`

### 8.2 接口验证方法

使用浏览器开发者工具（F12）或Postman等工具测试API接口，确认返回数据格式和内容正确。

---

## 九、测试建议

1. **分阶段测试**：先测试基础功能（报名、签到），再测试复杂功能（对战、排行）
2. **多账号测试**：使用不同角色的账号（盟主、成员）进行测试
3. **边界测试**：测试极端情况（只有1个联盟报名、所有联盟战功相同等）
4. **数据验证**：定期检查数据库数据，确保数据一致性
5. **时间测试**：测试不同时间段的功能（报名时间、对战时间、赛季结束时间等）

---

## 十、验证结果记录

建议在验证过程中记录以下信息：

- **测试日期**：___________
- **测试人员**：___________
- **测试环境**：___________
- **验证结果**：
  - 对战规则：□通过  □未通过  □部分通过
  - 排行榜功能：□通过  □未通过  □部分通过
- **发现的问题**：
  1. ________________________________
  2. ________________________________
  3. ________________________________
- **备注**：
  ________________________________
  ________________________________

---

## 附录：相关文件

- 测试数据脚本：`scripts/create_alliance_war_test_data.py`
- 测试数据说明：`scripts/ALLIANCE_WAR_TEST_DATA_README.md`
- 联盟操作文档：`scripts/联盟操作.md`
- 后端服务代码：`application/services/alliance_service.py`
- 前端页面代码：`interfaces/client/src/features/alliance/`
