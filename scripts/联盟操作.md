# 盟战功能演示指南

## 一、测试账号信息

### 账号格式和密码

所有测试账号使用统一密码：**123456**

#### 盟主账号（可以报名、兑换战功）
- **测试联盟1盟主**: 
  - 账号: `test_war_20001`
  - 密码: `123456`
  - 昵称: 盟主1
  - user_id: 20001

- **测试联盟2盟主**: 
  - 账号: `test_war_20002`
  - 密码: `123456`
  - 昵称: 盟主2
  - user_id: 20002

- **测试联盟3盟主**: 
  - 账号: `test_war_20003`
  - 密码: `123456`
  - 昵称: 盟主3
  - user_id: 20003

- **测试联盟4盟主**: 
  - 账号: `test_war_20004`
  - 密码: `123456`
  - 昵称: 盟主4
  - user_id: 20004

- **测试联盟5盟主**: 
  - 账号: `test_war_20005`
  - 密码: `123456`
  - 昵称: 盟主5
  - user_id: 20005

#### 普通成员账号（可以签到、查看信息）
- **账号格式**: `test_war_20006` ~ `test_war_20050`
- **密码**: `123456`
- **昵称**: 测试玩家6 ~ 测试玩家50
- **等级**: 1-60级随机
- **军队**: 根据等级自动分配（40级以上飞龙军，40级及以下伏虎军）

---

## 二、启动服务

### 1. 启动后端服务（Flask）

```bash
# 在项目根目录
python -m interfaces.web_api.app
```

服务将在 `http://127.0.0.1:5000` 启动

### 2. 启动前端服务（Vite）

```bash
# 在 interfaces/client 目录
cd interfaces/client
npm run dev
```

前端将在 `http://localhost:5178` 启动（端口可能不同）

---

## 三、功能演示步骤

### 功能1: 查看盟战信息

**步骤：**
1. 使用任意测试账号登录（如：`test_war_20001` / `123456`）
2. 进入"我的联盟"页面
3. 点击"盟战"或"召唤盟战"入口
4. 查看盟战信息页面

**预期结果：**
- 显示盟战时间安排（下一次开战时间、倒计时）
- 显示个人报名状态（飞龙军/伏虎军）
- 显示联盟统计信息（飞龙军人数、伏虎军人数）
- 显示联盟成员列表（按军队分类）

**测试账号建议：**
- 使用 `test_war_20001`（盟主，已加入联盟）
- 或使用 `test_war_20006`（普通成员）

---

### 功能2: 军队分配规则演示

**步骤：**
1. 登录一个测试账号（如：`test_war_20001`）
2. 进入"我的联盟" → "联盟成员"
3. 查看成员列表，观察军队分配

**预期结果：**
- 等级 > 40 的成员显示为"飞龙军"
- 等级 ≤ 40 的成员显示为"伏虎军"
- 成员加入联盟时自动分配军队

**测试账号建议：**
- 查看不同等级的成员，验证分配规则

---

### 功能3: 盟战报名（仅盟主/副盟主）

**步骤：**
1. 使用盟主账号登录（如：`test_war_20001` / `123456`）
2. 进入"盟战"页面
3. 点击"查看全部攻城目标"或进入报名页面
4. 选择土地或据点进行报名

**预期结果：**
- 飞龙军只能选择土地（迷雾城1号土地、飞龙港1号土地）
- 伏虎军只能选择据点（幻灵镇1号据点、定老城1号据点）
- 每个军队只能选择一个目标
- 报名时间限制：周一0:00-周三20:00 或 周四0:00-周六20:00

**测试账号建议：**
- 使用 `test_war_20001`（测试联盟1盟主）
- 注意：需要在报名时间内才能报名

**API测试：**
```bash
# 报名土地（飞龙军）
POST /api/alliance/war/target-signup
{
  "land_id": 1,  # 1或2（土地）
  "army": "dragon"
}

# 报名据点（伏虎军）
POST /api/alliance/war/target-signup
{
  "land_id": 3,  # 3或4（据点）
  "army": "tiger"
}
```

---

### 功能4: 盟战签到

**步骤：**
1. 使用任意联盟成员账号登录（如：`test_war_20006` / `123456`）
2. 确保已加入联盟且已报名军队
3. 进入"盟战"页面
4. 在签到时间内点击"签到"按钮

**预期结果：**
- 签到成功，获得30000铜钱
- 提示"签到成功，获得30000铜钱"
- 每人每次盟战只能签到一次
- 签到时间限制：报名签到时间内

**测试账号建议：**
- 使用 `test_war_20006`（普通成员，已加入联盟）
- 注意：需要在签到时间内才能签到

**API测试：**
```bash
POST /api/alliance/war/checkin
```

---

### 功能5: 查看盟战状态

**步骤：**
1. 登录任意联盟成员账号
2. 进入"盟战"页面
3. 查看当前盟战状态

**预期结果：**
- 显示当前是否在盟战时间内
- 显示当前阶段（报名签到/对战/结果展示/休战）
- 显示是否已签到
- 显示报名情况（飞龙军/伏虎军报名了哪个目标）
- 显示当前战功和历史战功

**API测试：**
```bash
GET /api/alliance/war/status
```

---

### 功能6: 查看盟战排行榜

**步骤：**
1. 登录任意账号（不需要加入联盟）
2. 进入"盟战"页面
3. 点击"盟战排行榜"

**预期结果：**
- 显示联盟排行列表（按战功排序）
- 显示当前赛季（YYYY-MM格式）
- 显示自己联盟的排名（如果已加入联盟）
- 支持分页查看

**API测试：**
```bash
GET /api/alliance/war/ranking?page=1&size=10
```

---

### 功能7: 战功兑换（仅盟主/副盟主）

**步骤：**
1. 使用盟主或副盟主账号登录（如：`test_war_20001` / `123456`）
2. 进入"盟战"页面
3. 点击"战功兑换"
4. 选择兑换类型（焚火晶或金袋）
5. 确认兑换

**预期结果：**
- 2联盟战功兑换1焚火晶
- 4联盟战功兑换1金袋
- 扣除相应战功
- 物品发放到背包
- 只有盟主或副盟主可以兑换

**测试账号建议：**
- 使用 `test_war_20001`（盟主）
- 注意：需要联盟有足够的战功

**API测试：**
```bash
# 兑换焚火晶
POST /api/alliance/war/honor/exchange-item
{
  "exchange_type": "fire_crystal"
}

# 兑换金袋
POST /api/alliance/war/honor/exchange-item
{
  "exchange_type": "gold_bag"
}
```

---

### 功能8: 查看联盟战绩

**步骤：**
1. 登录任意联盟成员账号
2. 进入"盟战"页面
3. 点击"联盟战绩"

**预期结果：**
- 显示历史对战记录
- 显示对战对手、土地/据点、结果（胜利/失败）
- 显示获得的战功
- 按时间倒序排列

**API测试：**
```bash
GET /api/alliance/war/battle-records?limit=50
```

---

### 功能9: 查看土地占领情况

**步骤：**
1. 登录任意账号
2. 进入"盟战"页面
3. 点击"查看全部攻城目标"
4. 查看各个土地/据点的占领情况

**预期结果：**
- 显示每块土地/据点当前被哪个联盟占领
- 显示占领时间
- 显示占领奖励（土地每天10000铜钱，据点每天5000铜钱）

---

### 功能10: 赛季排行和奖励

**步骤：**
1. 登录任意账号
2. 进入"盟战"页面
3. 查看排行榜
4. 查看赛季信息

**预期结果：**
- 显示当前赛季（YYYY-MM格式）
- 显示联盟排行（按战功排序）
- 赛季结束后，前三名获得奖励：
  - 第一名：100w铜钱，1追魂法宝
  - 第二名：70w铜钱
  - 第三名：40w铜钱

**注意：**
- 赛季奖励需要手动发放（管理员功能）
- 赛季时间为一个月

---

## 四、时间规则说明

### 第一次盟战
- **时间范围**: 周一0:00 - 周三24:00
- **报名签到**: 周一0:00 - 周三20:00
- **对战时间**: 周三20:00 - 22:00
- **结果展示**: 周三22:00 - 24:00

### 第二次盟战
- **时间范围**: 周四0:00 - 周六24:00
- **报名签到**: 周四0:00 - 周六20:00
- **对战时间**: 周六20:00 - 22:00
- **结果展示**: 周六22:00 - 24:00

### 周日休战
- 周日全天不进行盟战

**测试提示：**
- 如果当前不在盟战时间内，某些功能会提示"当前不在盟战时间内"
- 可以修改系统时间或等待到盟战时间进行测试

---

## 五、API端点列表

### 盟战信息
- `GET /api/alliance/war/info` - 获取盟战信息
- `GET /api/alliance/war/status` - 获取盟战状态

### 报名和签到
- `POST /api/alliance/war/signup` - 报名加入军队
- `POST /api/alliance/war/target-signup` - 报名土地/据点（盟主/副盟主）
- `POST /api/alliance/war/checkin` - 盟战签到

### 排行榜和战绩
- `GET /api/alliance/war/ranking` - 获取盟战排行榜
- `GET /api/alliance/war/battle-records` - 获取联盟战绩

### 战功兑换
- `POST /api/alliance/war/honor/exchange-item` - 战功兑换物品（盟主/副盟主）

### 其他
- `GET /api/alliance/war/land/<land_id>` - 获取土地详情
- `GET /api/alliance/barracks` - 获取联盟兵营信息

---

## 六、常见问题

### Q1: 登录失败怎么办？
**A:** 确保：
1. 账号格式正确：`test_war_20001`（注意下划线）
2. 密码正确：`123456`
3. 数据库中有该账号记录

### Q2: 提示"未加入联盟"？
**A:** 
- 使用已加入联盟的账号（20001-20050都在测试联盟中）
- 或先加入一个联盟

### Q3: 提示"当前不在盟战时间内"？
**A:** 
- 这是正常的，因为盟战有特定时间
- 可以等待到盟战时间，或修改系统时间测试

### Q4: 提示"只有盟主或副盟主可以报名"？
**A:** 
- 报名功能只有盟主和副盟主可以使用
- 使用盟主账号：`test_war_20001` ~ `test_war_20005`

### Q5: 如何查看联盟成员？
**A:** 
- 进入"我的联盟" → "联盟成员"
- 可以看到所有成员及其军队分配

---

## 七、测试检查清单

- [ ] 可以查看盟战信息（未加入联盟也能查看）
- [ ] 军队分配正确（40级以上飞龙军，40级及以下伏虎军）
- [ ] 盟主可以报名土地/据点
- [ ] 飞龙军只能选择土地，伏虎军只能选择据点
- [ ] 成员可以在签到时间内签到
- [ ] 签到获得30000铜钱
- [ ] 可以查看盟战排行榜
- [ ] 可以查看联盟战绩
- [ ] 盟主可以兑换战功（2战功=1焚火晶，4战功=1金袋）
- [ ] 时间规则正确（一周两次，周日休战）

---

## 八、快速测试流程

1. **启动服务**
   ```bash
   # 终端1：启动后端
   python -m interfaces.web_api.app
   
   # 终端2：启动前端
   cd interfaces/client
   npm run dev
   ```

2. **登录测试账号**
   - 打开浏览器访问前端地址（如：http://localhost:5178）
   - 使用账号 `test_war_20001`，密码 `123456` 登录

3. **测试基本功能**
   - 进入"我的联盟"
   - 点击"盟战"查看信息
   - 查看联盟成员和军队分配

4. **测试报名功能**（需要盟主账号）
   - 使用 `test_war_20001`（盟主）
   - 在报名时间内报名土地/据点

5. **测试签到功能**
   - 使用任意成员账号
   - 在签到时间内签到

6. **测试其他功能**
   - 查看排行榜
   - 查看战绩
   - 测试战功兑换（需要战功）

---

## 九、测试数据说明

### 已生成的数据
- ✅ 50个测试玩家（20001-20050）
- ✅ 5个测试联盟（测试联盟1-5）
- ✅ 联盟成员分配（每个联盟约10个成员）
- ✅ 盟战报名数据（前3个联盟已报名）
- ✅ 盟战签到数据（26条签到记录）
- ✅ 盟战战绩数据（9条战绩记录）
- ✅ 土地占领数据（4块土地被占领）

### 测试账号快速参考
| 角色 | 账号 | 密码 | 说明 |
|------|------|------|------|
| 盟主1 | test_war_20001 | 123456 | 测试联盟1盟主 |
| 盟主2 | test_war_20002 | 123456 | 测试联盟2盟主 |
| 成员 | test_war_20006 | 123456 | 普通成员 |
| 成员 | test_war_20010 | 123456 | 普通成员 |

---

## 十、注意事项

1. **时间限制**：某些功能只在特定时间可用（报名、签到等）
2. **权限限制**：报名和兑换功能只有盟主/副盟主可以使用
3. **数据更新**：测试数据可以重复运行脚本更新
4. **表结构**：确保已运行 `sql/041_alliance_war_system.sql` 创建表

---

## 十一、故障排查

### 如果遇到问题：

1. **检查数据库连接**
   ```bash
   python -c "import pymysql; conn = pymysql.connect(host='8.146.206.229', user='root', password='Wxs1230.0', database='game_tower'); print('连接成功'); conn.close()"
   ```

2. **检查表是否存在**
   ```sql
   SHOW TABLES LIKE 'alliance_war%';
   SHOW TABLES LIKE 'alliance_land%';
   SHOW TABLES LIKE 'lands';
   ```

3. **检查测试账号**
   ```sql
   SELECT user_id, username, nickname, level FROM player WHERE user_id >= 20000 AND user_id < 20100 LIMIT 10;
   ```

4. **检查联盟数据**
   ```sql
   SELECT id, name, leader_id FROM alliances WHERE name LIKE '测试联盟%';
   ```

---

祝测试顺利！如有问题