# 盟战对战功能对接说明

## 功能概述

已实现完整的盟战土地对战功能，包括：
- ✅ 联盟配对
- ✅ 对战执行
- ✅ 土地占领
- ✅ 自动定时任务

## 与现有功能的对接

### 1. 报名流程对接

**现有流程：**
1. 盟主/副盟主报名土地（`signup_target`）→ 状态：`STATUS_REGISTERED (1)`
2. 成员报名加入军队（`signup_for_war`）→ 加入 `alliance_army_assignments` 表
3. 成员签到（`war_checkin`）→ 记录签到并获得奖励

**对战功能对接：**
- ✅ 配对时同时接受 `STATUS_REGISTERED` 和 `STATUS_CONFIRMED` 状态
- ✅ 通过 `_build_army_signups` 从 `alliance_army_assignments` 获取参战成员
- ✅ 只包含已加入对应军队（飞龙军/伏虎军）的成员

### 2. 时间规则对接

**盟战时间规则：**
- 第一次：周一0:00-周三24:00
  - 报名签到：周一0:00-周三20:00
  - **对战：周三20:00-22:00** ⭐
  - 结果展示：周三22:00-24:00
- 第二次：周四0:00-周六24:00
  - 报名签到：周四0:00-周六20:00
  - **对战：周六20:00-22:00** ⭐
  - 结果展示：周六22:00-24:00

**对战功能对接：**
- ✅ API接口添加了时间检查，只在对战时间内（`status == "battle"`）才能执行
- ✅ 支持环境变量 `ALLIANCE_WAR_ALLOW_TIME_BYPASS=true` 跳过时间检查（测试用）
- ✅ 定时任务自动在周三和周六20:00触发对战

### 3. 自动触发机制

**定时任务：**
- 位置：`infrastructure/scheduler.py`
- 触发时间：
  - 每周三 20:00 - 第一次盟战
  - 每周六 20:00 - 第二次盟战
- 执行内容：
  1. 自动对所有土地（ID: 1,2,3,4）进行配对
  2. 执行所有对战直到结束
  3. 最终胜利者自动占领土地

### 4. 手动触发接口

**API接口：**

#### 接口1：配对联盟
```
POST /api/alliance/war/lock-and-pair/<land_id>
```
- 时间检查：只在对战时间内
- 功能：配对已报名的联盟，创建对战记录

#### 接口2：推进回合
```
POST /api/alliance/war/advance-round/<battle_id>
```
- 功能：执行当前回合的所有决斗

#### 接口3：执行完整对战（推荐）
```
POST /api/alliance/war/run-battle/<land_id>
```
- 时间检查：只在对战时间内（可跳过）
- 功能：自动执行配对+所有回合+占领

### 5. 数据流程对接

**报名数据：**
- `alliance_land_registration` - 土地报名记录
- `alliance_army_assignments` - 成员军队分配
- `alliance_war_checkins` - 成员签到记录

**对战数据：**
- `alliance_land_battle` - 对战记录
- `alliance_land_battle_round` - 回合记录
- `alliance_land_battle_duel` - 决斗记录
- `alliance_army_signup` - 参战成员记录

**结果数据：**
- `alliance_land_occupation` - 土地占领记录
- `alliance_war_battle_records` - 战绩记录
- `alliances.war_honor` - 联盟战功

## 使用示例

### 方式1：自动触发（生产环境）

系统会在每周三和周六20:00自动执行对战，无需手动操作。

### 方式2：手动触发（测试/调试）

```bash
# 设置环境变量跳过时间检查（测试用）
export ALLIANCE_WAR_ALLOW_TIME_BYPASS=true

# 执行土地1的对战
curl -X POST http://localhost:5000/api/alliance/war/run-battle/1 \
  -H "Cookie: session=your_session_cookie"
```

### 方式3：脚本执行

```bash
# 执行脚本（会自动跳过时间检查）
python scripts/run_alliance_war_battle.py 1 2 3 4
```

## 注意事项

1. **报名状态**
   - 报名后状态为 `STATUS_REGISTERED (1)`
   - 配对时同时接受 `STATUS_REGISTERED` 和 `STATUS_CONFIRMED`
   - 如需确认流程，可在报名后手动更新状态为 `STATUS_CONFIRMED`

2. **成员参战要求**
   - 成员必须先报名加入军队（`signup_for_war`）
   - 成员需要签到（`war_checkin`）
   - 成员需要有出战幻兽

3. **时间限制**
   - 生产环境：只在对战时间内执行
   - 测试环境：可通过环境变量跳过

4. **多场对战**
   - 如果有多个联盟报名，会创建多场对战
   - 所有对战会并行执行
   - 最终胜利者（没有其他活跃报名）自动占领土地

## 测试建议

1. **准备数据**
   - 创建至少2个联盟
   - 每个联盟至少有1个成员
   - 成员需要有出战幻兽
   - 盟主报名同一块土地
   - 成员报名加入军队并签到

2. **执行对战**
   ```bash
   # 设置环境变量跳过时间检查
   export ALLIANCE_WAR_ALLOW_TIME_BYPASS=true
   
   # 执行对战
   curl -X POST http://localhost:5000/api/alliance/war/run-battle/1
   ```

3. **验证结果**
   - 检查 `alliance_land_occupation` 表，确认土地被占领
   - 检查 `alliance_war_battle_records` 表，确认战绩记录
   - 检查 `alliances.war_honor`，确认战功增加

## 相关文件

- **服务层**: `application/services/alliance_battle_service.py`
- **路由层**: `interfaces/routes/alliance_routes.py`
- **定时任务**: `infrastructure/scheduler.py`
- **执行脚本**: `scripts/run_alliance_war_battle.py`
- **实体定义**: `domain/entities/alliance_registration.py`
