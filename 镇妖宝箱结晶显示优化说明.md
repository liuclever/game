# 镇妖宝箱结晶显示优化说明

## 问题描述

打开镇妖宝箱时，显示的是"七类结晶×3"这样的文字，不够直观。玩家无法直接看到具体获得了哪些结晶。

## 优化方案

修改后，直接显示具体获得的结晶名称，例如"金之结晶×1、木之结晶×1、水之结晶×1"。

## 显示效果对比

### 修改前

```
成功开启三星试炼宝箱×1，获得：活力草×1、七类结晶×3、铜钱×100000
```

**问题：**
- 不知道具体获得了哪些结晶
- "七类结晶×3"这个描述不够清晰

### 修改后

```
成功开启三星试炼宝箱×1，获得：活力草×1、金之结晶×1、木之结晶×1、水之结晶×1、铜钱×100000
```

**优点：**
- 清晰显示具体获得的结晶
- 玩家一目了然

## 实现方式

### 修改的代码

在 `application/services/inventory_service.py` 的宝箱打开逻辑中，修改了从池中随机选择物品时的名称获取方式：

**修改前：**
```python
for item_id in selected_items:
    self.add_item(user_id, int(item_id), 1)
    item_name = item_cfg.get("name") or (...)  # 使用配置中的"七类结晶"
    item_summary[item_name] = item_summary.get(item_name, 0) + 1
```

**修改后：**
```python
for item_id in selected_items:
    self.add_item(user_id, int(item_id), 1)
    # 使用实际物品的名称，而不是配置中的"七类结晶"
    actual_item = self.item_repo.get_by_id(int(item_id))
    item_name = actual_item.name if actual_item else f"物品{item_id}"
    item_summary[item_name] = item_summary.get(item_name, 0) + 1
```

### 关键改动

1. **不再使用配置中的名称**：配置文件中的 `"name": "七类结晶"` 只是一个描述性的标签，不应该用于显示
2. **使用实际物品名称**：从物品仓库（`item_repo`）中获取实际的物品名称
3. **保持逻辑不变**：仍然从7种结晶中随机选择N种，每种给1个

## 七类结晶说明

七类结晶指的是：

| 物品ID | 结晶名称 |
|--------|---------|
| 1001 | 金之结晶 |
| 1002 | 木之结晶 |
| 1003 | 水之结晶 |
| 1004 | 火之结晶 |
| 1005 | 土之结晶 |
| 1006 | 风之结晶 |
| 1007 | 电之结晶 |

## 宝箱奖励规则

### 三星试炼宝箱（30-39级）

**奖励：**
- 活力草 × 1
- 从7种结晶中随机选择3种，每种 × 1
- 铜钱 × 100000

**显示示例：**
```
成功开启三星试炼宝箱×1，获得：活力草×1、金之结晶×1、木之结晶×1、水之结晶×1、铜钱×100000
```

### 四星试炼宝箱（40-49级）

**奖励：**
- 活力草 × 1
- 从7种结晶中随机选择4种，每种 × 1
- 铜钱 × 120000

**显示示例：**
```
成功开启四星试炼宝箱×1，获得：活力草×1、风之结晶×1、火之结晶×1、木之结晶×1、土之结晶×1、铜钱×120000
```

### 五星炼狱宝箱（50-59级）

**奖励：**
- 活力草 × 2
- 从7种结晶中随机选择5种，每种 × 1
- 强力捕捉球 × 2
- 追魂法宝 × 2
- 灵力水晶 × 1
- 铜钱 × 140000

**显示示例：**
```
成功开启五星炼狱宝箱×1，获得：活力草×2、风之结晶×1、金之结晶×1、木之结晶×1、电之结晶×1、土之结晶×1、强力捕捉球×2、追魂法宝×2、灵力水晶×1、铜钱×140000
```

### 七星炼狱宝箱（70-79级）

**奖励：**
- 活力草 × 4
- 全部7种结晶，每种 × 1
- 强力捕捉球 × 3
- 追魂法宝 × 3
- 灵力水晶 × 1
- 铜钱 × 180000

**显示示例：**
```
成功开启七星炼狱宝箱×1，获得：活力草×4、电之结晶×1、金之结晶×1、火之结晶×1、风之结晶×1、木之结晶×1、土之结晶×1、水之结晶×1、强力捕捉球×3、追魂法宝×3、灵力水晶×1、铜钱×180000
```

## 测试验证

### 测试脚本

```bash
python test_zhenyao_chest_crystal_display.py
```

### 测试结果

所有测试场景均通过：

- ✓ 三星试炼宝箱：显示3种不同的结晶
- ✓ 四星试炼宝箱：显示4种不同的结晶
- ✓ 五星炼狱宝箱：显示5种不同的结晶
- ✓ 七星炼狱宝箱：显示全部7种结晶
- ✓ 消息中不包含"七类结晶"字样
- ✓ 直接显示具体的结晶名称

## 注意事项

1. **随机性**：每次打开宝箱获得的结晶种类是随机的
2. **不重复**：从7种结晶中随机选择N种，不会重复
3. **数量固定**：每种结晶只给1个
4. **配置不变**：配置文件中的 `"name": "七类结晶"` 保持不变，只是不再用于显示

## 相关文件

### 修改的文件
- `application/services/inventory_service.py` - 宝箱打开逻辑

### 测试文件
- `test_zhenyao_chest_crystal_display.py` - 结晶显示测试脚本

### 配置文件
- `configs/zhenyao_rewards.json` - 镇妖奖励配置（未修改）
- `configs/items.json` - 物品配置（结晶定义）

## 总结

镇妖宝箱结晶显示优化已完成：

1. ✓ 不再显示"七类结晶×N"
2. ✓ 直接显示具体获得的结晶名称
3. ✓ 显示更加清晰直观
4. ✓ 测试验证通过

玩家打开镇妖宝箱时，将直接看到具体获得了哪些结晶，体验更加友好。
