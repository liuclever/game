# 连胜竞技场活力消耗实现总结

## 需求
竞技没有达成6连胜之前消耗100活力，之后消耗15活力。

## 实现概述

实现了连胜竞技场的活力消耗机制，根据玩家今日最高连胜次数动态调整活力消耗：
- **未达成6连胜：** 每次战斗消耗100活力
- **达成6连胜：** 每次战斗消耗15活力

## 技术实现

### 后端实现 (`interfaces/routes/arena_streak_routes.py`)

#### 1. 活力消耗计算
```python
# 根据今日最高连胜次数计算活力消耗
max_streak = record.get('max_streak_today', 0)
energy_cost = 15 if max_streak >= 6 else 100
```

#### 2. 活力检查
```python
current_energy = getattr(attacker, 'energy', 0) or 0
if current_energy < energy_cost:
    return jsonify({
        "ok": False, 
        "error": f"活力不足，需要{energy_cost}点活力（当前{current_energy}点）"
    })
```

#### 3. 活力扣除
```python
attacker.energy = current_energy - energy_cost
services.player_repo.save(attacker)
```

#### 4. 战斗结果提示
```python
# 胜利
battle_data['message'] = f"胜利！当前连胜{new_streak}次（消耗活力{energy_cost}点）"

# 失败
battle_data['message'] = f"失败！连胜归零（消耗活力{energy_cost}点）"
```

### 前端实现 (`interfaces/client/src/views/ArenaStreak.vue`)

#### 1. 活力消耗显示
```vue
<div class="section">
  战斗消耗活力: {{ energyCost }}点（{{ maxStreakToday >= 6 ? '已达成6连胜' : '未达成6连胜' }}）
</div>
```

#### 2. 计算属性
```javascript
computed: {
  energyCost() {
    return this.maxStreakToday >= 6 ? 15 : 100;
  }
}
```

## 功能特点

### 1. 动态活力消耗 ✅
- 根据今日最高连胜次数动态计算
- 达成6连胜后活力消耗降低85%（100 → 15）
- 鼓励玩家达成6连胜

### 2. 完善的活力检查 ✅
- 战斗前检查活力是否充足
- 活力不足时明确提示需要的活力和当前活力
- 避免活力不足时扣除活力

### 3. 清晰的用户提示 ✅
- 前端实时显示当前活力消耗
- 显示是否已达成6连胜
- 战斗结果包含活力消耗信息

### 4. 合理的设计逻辑 ✅
- 基于"今日最高连胜"而非"当前连胜"
- 一旦达成6连胜，当天剩余时间都享受低活力消耗
- 即使连胜归零，也不会回到高活力消耗

## 活力消耗规则

| 状态 | 今日最高连胜 | 活力消耗 | 提示 |
|------|-------------|---------|------|
| 未达成6连胜 | 0-5次 | 100点 | 战斗消耗活力: 100点（未达成6连胜） |
| 达成6连胜 | 6次及以上 | 15点 | 战斗消耗活力: 15点（已达成6连胜） |

## 用户体验流程

### 流程1：从0到6连胜
```
初始状态：今日最高连胜 = 0
├─ 第1次战斗：消耗100活力 → 胜利 → 当前连胜 = 1，今日最高 = 1
├─ 第2次战斗：消耗100活力 → 胜利 → 当前连胜 = 2，今日最高 = 2
├─ 第3次战斗：消耗100活力 → 胜利 → 当前连胜 = 3，今日最高 = 3
├─ 第4次战斗：消耗100活力 → 胜利 → 当前连胜 = 4，今日最高 = 4
├─ 第5次战斗：消耗100活力 → 胜利 → 当前连胜 = 5，今日最高 = 5
├─ 第6次战斗：消耗100活力 → 胜利 → 当前连胜 = 6，今日最高 = 6
└─ 第7次战斗：消耗15活力 ✨（已达成6连胜，活力消耗降低）
```

### 流程2：达成6连胜后失败
```
当前状态：今日最高连胜 = 6，当前连胜 = 6
├─ 下次战斗：消耗15活力 → 失败 → 当前连胜 = 0，今日最高 = 6
└─ 再次战斗：消耗15活力 ✨（今日最高仍然是6，继续享受低活力消耗）
```

## 设计理由

### 为什么基于"今日最高连胜"？
1. **奖励玩家努力** - 一旦达成6连胜，当天剩余时间都享受低活力消耗
2. **降低挫败感** - 即使连胜归零，也不会回到高活力消耗
3. **鼓励持续参与** - 达成6连胜后，玩家更愿意继续战斗

### 为什么是100和15？
- **100活力** - 初期较高的消耗，限制无限制战斗，增加策略性
- **15活力** - 达成6连胜后的奖励，与其他功能（如地图副本）的活力消耗相当
- **差距明显** - 85%的降幅，让玩家明显感受到达成6连胜的好处

## 测试验证

### 测试场景1：未达成6连胜 ✅
- 今日最高连胜 < 6
- 战斗消耗100活力
- 前端显示"战斗消耗活力: 100点（未达成6连胜）"

### 测试场景2：达成6连胜 ✅
- 今日最高连胜 >= 6
- 战斗消耗15活力
- 前端显示"战斗消耗活力: 15点（已达成6连胜）"

### 测试场景3：活力不足 ✅
- 活力 < 所需活力
- 提示"活力不足，需要X点活力（当前Y点）"
- 活力未被扣除，战斗未进行

### 测试场景4：连胜归零后 ✅
- 达成6连胜后失败
- 当前连胜归零，但今日最高仍为6
- 仍然只消耗15活力

## 修改的文件

1. **interfaces/routes/arena_streak_routes.py**
   - 添加活力消耗计算逻辑
   - 添加活力检查和扣除
   - 更新战斗结果提示

2. **interfaces/client/src/views/ArenaStreak.vue**
   - 添加活力消耗显示
   - 添加 `energyCost` 计算属性

## 新增的文件

1. **连胜竞技场活力消耗机制说明.md** - 详细的功能说明文档
2. **连胜竞技场活力消耗实现总结.md** - 本文档

## 完成状态

| 项目 | 状态 |
|------|------|
| 后端活力消耗逻辑 | ✅ 完成 |
| 活力检查和提示 | ✅ 完成 |
| 前端活力消耗显示 | ✅ 完成 |
| 战斗结果提示优化 | ✅ 完成 |
| 文档编写 | ✅ 完成 |

## 用户体验改进

### 实现前
- ❌ 没有活力消耗
- ❌ 可以无限制战斗
- ❌ 缺少策略性

### 实现后
- ✅ 有活力消耗限制
- ✅ 达成6连胜后活力消耗大幅降低
- ✅ 增加了策略性和目标感
- ✅ 鼓励玩家达成6连胜
- ✅ 清晰的活力消耗提示

## 总结

连胜竞技场活力消耗机制已完整实现，包括：
1. 动态活力消耗计算（100 → 15）
2. 完善的活力检查和提示
3. 清晰的用户界面显示
4. 合理的设计逻辑（基于今日最高连胜）

该机制增加了游戏的策略性，鼓励玩家达成6连胜，同时避免了过度惩罚（连胜归零后仍享受低活力消耗）。

**实现时间：** 2026-01-18  
**实现者：** Kiro AI Assistant  
**状态：** ✅ 完成
