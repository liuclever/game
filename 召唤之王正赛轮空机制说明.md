# 召唤之王正赛轮空机制说明

## 功能概述

召唤之王正赛已经实现了轮空机制，当参赛人数为奇数时，最后一名选手会轮空并直接晋级到下一轮。

## 轮空逻辑

### 1. 配对规则

代码使用 `for i in range(0, len(player_ids), 2)` 来两两配对：

```python
for i in range(0, len(player_ids), 2):
    if i + 1 < len(player_ids):
        # 正常配对：player_ids[i] vs player_ids[i+1]
        player1_id = player_ids[i]
        player2_id = player_ids[i + 1]
        # 执行战斗...
    else:
        # 轮空：player_ids[i] 直接晋级
        player_id = player_ids[i]
        print(f"[召唤之王] {player_id} 轮空，直接晋级")
        # 标记为轮空并晋级...
```

### 2. 轮空条件

**触发条件：** 参赛人数为奇数

**示例：**
- 3人参赛：1 vs 2，3轮空
- 5人参赛：1 vs 2，3 vs 4，5轮空
- 7人参赛：1 vs 2，3 vs 4，5 vs 6，7轮空

### 3. 轮空处理

当检测到轮空时，系统会：

1. **输出日志**：
   ```
   [召唤之王] {player_id} 轮空，直接晋级
   ```

2. **更新数据库**：
   ```python
   execute_update(
       """UPDATE king_final_stage 
          SET is_bye = 1, is_winner = 1, battle_time = NOW()
          WHERE season = %s AND stage = %s AND user_id = %s""",
       (season, stage, player_id)
   )
   ```
   - `is_bye = 1`：标记为轮空
   - `is_winner = 1`：标记为获胜（直接晋级）
   - `battle_time = NOW()`：记录时间

3. **添加到晋级名单**：
   ```python
   winners.append(player_id)
   ```

4. **晋级到下一轮**：
   ```python
   execute_update(
       """INSERT INTO king_final_stage 
          (season, user_id, stage, created_at) 
          VALUES (%s, %s, %s, NOW())""",
       (season, winner_id, next_stage)
   )
   ```

5. **发放晋级奖励**：
   ```python
   if next_stage != 'champion':
       send_stage_reward(winner_id, next_stage, season)
   ```

## 各阶段人数情况

### 理想情况（人数为2的幂次）

| 阶段 | 理想人数 | 配对数 | 轮空数 |
|------|---------|--------|--------|
| 32强 | 32 | 16场 | 0 |
| 16强 | 16 | 8场 | 0 |
| 8强 | 8 | 4场 | 0 |
| 4强 | 4 | 2场 | 0 |
| 半决赛 | 2 | 1场 | 0 |

### 非理想情况（人数为奇数）

| 阶段 | 实际人数 | 配对数 | 轮空数 | 晋级人数 |
|------|---------|--------|--------|---------|
| 32强 | 31 | 15场 | 1 | 16 |
| 32强 | 33 | 16场 | 1 | 17 |
| 16强 | 15 | 7场 | 1 | 8 |
| 8强 | 7 | 3场 | 1 | 4 |
| 4强 | 3 | 1场 | 1 | 2 |

## 轮空的公平性

### 1. 随机性

在配对前，代码会随机打乱选手顺序：

```python
random.shuffle(player_ids)
```

这确保了轮空的选手是随机的，不会总是同一个人轮空。

### 2. 轮空优势

轮空的选手有以下优势：
- **不消耗幻兽状态**：不需要战斗，幻兽保持满状态
- **节省时间**：直接晋级，不需要等待战斗结果
- **获得奖励**：仍然获得晋级奖励

### 3. 轮空劣势

轮空的选手也有劣势：
- **缺少战斗经验**：没有实战，可能影响后续表现
- **心理压力**：可能因为"不劳而获"而感到压力

## 人数不足的处理

### 1. 最少人数要求

理论上，正赛可以从任意人数开始：

- **1人**：直接成为冠军（无需战斗）
- **2人**：直接进行决赛
- **3人**：1场战斗 + 1人轮空，然后决赛
- **4人及以上**：正常进行

### 2. 实际情况

召唤之王的晋级规则是：
- 每个赛区（东、西）选出前16名
- 共32名选手进入正赛

**如果报名人数不足：**
- 东区不足16人：实际有多少人就晋级多少人
- 西区不足16人：实际有多少人就晋级多少人
- 总人数可能少于32人

### 3. 极端情况处理

**场景1：只有1人晋级**
```python
if len(player_ids) == 1:
    # 直接成为冠军
    champion_id = player_ids[0]
    # 更新冠军标识
    # 发放冠军奖励
```

**场景2：没有人晋级**
```python
if not players:
    print(f"[召唤之王] {stage}强赛没有参赛选手")
    return
```

## 数据库字段

### king_final_stage 表

| 字段 | 类型 | 说明 |
|------|------|------|
| season | VARCHAR | 赛季标识 |
| user_id | INT | 玩家ID |
| stage | VARCHAR | 阶段（32/16/8/4/2/champion） |
| is_winner | TINYINT | 是否获胜（1=胜/0=负/NULL=未比赛） |
| is_bye | TINYINT | 是否轮空（1=轮空/0=正常） |
| opponent_id | INT | 对手ID（轮空时为NULL） |
| match_id | INT | 比赛场次 |
| battle_time | DATETIME | 战斗时间 |

### 轮空记录示例

```sql
SELECT * FROM king_final_stage WHERE is_bye = 1;
```

**结果：**
```
season    | user_id | stage | is_winner | is_bye | opponent_id | match_id
----------|---------|-------|-----------|--------|-------------|----------
2026W04   | 1001    | 32    | 1         | 1      | NULL        | NULL
2026W04   | 2002    | 16    | 1         | 1      | NULL        | NULL
```

## 前端显示

### 对战列表

```
32强赛对阵：
  第1场：玩家A vs 玩家B
  第2场：玩家C vs 玩家D
  ...
  第15场：玩家Y vs 玩家Z
  轮空：玩家X（直接晋级）
```

### 战斗结果

```
32强赛结果：
  第1场：玩家A 获胜
  第2场：玩家D 获胜
  ...
  第15场：玩家Z 获胜
  轮空：玩家X 直接晋级
```

## 测试场景

### 场景1：32人（理想情况）

```
32人 → 16场战斗 → 16人晋级
16人 → 8场战斗 → 8人晋级
8人 → 4场战斗 → 4人晋级
4人 → 2场战斗 → 2人晋级
2人 → 1场战斗 → 1人冠军
```

### 场景2：31人（1人轮空）

```
31人 → 15场战斗 + 1人轮空 → 16人晋级
16人 → 8场战斗 → 8人晋级
8人 → 4场战斗 → 4人晋级
4人 → 2场战斗 → 2人晋级
2人 → 1场战斗 → 1人冠军
```

### 场景3：17人（多轮轮空）

```
17人 → 8场战斗 + 1人轮空 → 9人晋级
9人 → 4场战斗 + 1人轮空 → 5人晋级
5人 → 2场战斗 + 1人轮空 → 3人晋级
3人 → 1场战斗 + 1人轮空 → 2人晋级
2人 → 1场战斗 → 1人冠军
```

### 场景4：3人（极端情况）

```
3人 → 1场战斗 + 1人轮空 → 2人晋级
2人 → 1场战斗 → 1人冠军
```

## 优化建议

### 1. 轮空通知

建议给轮空的玩家发送通知：

```python
# 发送轮空通知
send_notification(player_id, f"恭喜！您在{stage}强赛中轮空，直接晋级到{next_stage}强！")
```

### 2. 轮空奖励

可以考虑给轮空的玩家特殊奖励或标记：

```python
if is_bye:
    # 轮空奖励（可选）
    send_bye_reward(player_id, stage)
```

### 3. 前端显示优化

前端应该清楚地显示轮空信息：

```javascript
if (match.is_bye) {
    return `<div class="bye-match">
        <span class="player">${match.player_name}</span>
        <span class="status">轮空（直接晋级）</span>
    </div>`;
}
```

## 总结

召唤之王正赛的轮空机制已经完整实现：

1. ✓ 支持奇数人数的配对
2. ✓ 轮空选手随机产生（通过 shuffle）
3. ✓ 轮空选手直接晋级
4. ✓ 轮空记录保存到数据库（is_bye=1）
5. ✓ 轮空选手获得晋级奖励
6. ✓ 支持任意人数（包括极端情况）

当参赛人数为奇数时，最后一名选手会自动轮空并直接晋级到下一轮，确保比赛能够正常进行。
