# 化仙阵开启消耗结晶功能实现说明

## 功能需求

化仙阵开启需要消耗以下7种结晶各1个：
- 金之结晶
- 木之结晶
- 水之结晶
- 火之结晶
- 土之结晶
- 风之结晶
- 电之结晶

## 实现内容

### 1. 后端修改 (`application/services/immortalize_pool_service.py`)

**修改位置：** `start_formation` 方法

**实现逻辑：**
1. 在开启化仙阵之前，检查玩家是否拥有7种结晶各至少1个
2. 如果结晶不足，抛出错误提示缺少的结晶
3. 如果结晶足够，扣除7种结晶各1个
4. 然后正常开启化仙阵

**代码片段：**
```python
# 检查并扣除7种结晶各1个
if not self.inventory_service:
    raise ImmortalizeError("系统错误：背包服务未初始化")

# 7种结晶ID：金、木、水、火、土、风、电
crystal_item_ids = [1001, 1002, 1003, 1004, 1005, 1006, 1007]
crystal_names = {
    1001: "金之结晶",
    1002: "木之结晶",
    1003: "水之结晶",
    1004: "火之结晶",
    1005: "土之结晶",
    1006: "风之结晶",
    1007: "电之结晶"
}
required_qty = 1

# 检查结晶是否足够
missing = []
for item_id in crystal_item_ids:
    owned = self.inventory_service.get_item_count(user_id, item_id)
    if owned < required_qty:
        crystal_name = crystal_names.get(item_id, f"结晶{item_id}")
        missing.append({
            "item_id": item_id,
            "name": crystal_name,
            "required": required_qty,
            "owned": owned
        })

if missing:
    missing_str = "、".join([f"{m['name']}({m['owned']}/{m['required']})" for m in missing])
    raise ImmortalizeError(f"结晶不足：{missing_str}")

# 扣除结晶
try:
    for item_id in crystal_item_ids:
        self.inventory_service.remove_item(user_id, item_id, required_qty)
except InventoryError as exc:
    raise ImmortalizeError(f"扣除结晶失败：{str(exc)}") from exc
```

### 2. 前端修改 (`interfaces/client/src/features/huaxian/HuaXianPage.vue`)

**新增功能：**
1. 添加了7种结晶的配置和数量计算
2. 添加了材料检查逻辑（`canStartFormation`）
3. 在界面上显示材料要求，并用颜色标识是否满足
4. 在开启前进行二次确认，提示将消耗的材料
5. 如果材料不足，禁用开启按钮并提示缺少的材料

**主要修改：**

1. **添加结晶配置和数量计算：**
```javascript
// 7种结晶ID和名称
const crystalConfig = [
  { id: 1001, name: '金之结晶' },
  { id: 1002, name: '木之结晶' },
  { id: 1003, name: '水之结晶' },
  { id: 1004, name: '火之结晶' },
  { id: 1005, name: '土之结晶' },
  { id: 1006, name: '风之结晶' },
  { id: 1007, name: '电之结晶' },
]

// 结晶数量计算
const crystalCounts = computed(() => {
  const counts = {}
  for (const crystal of crystalConfig) {
    const item = bagItems.value.find(i => i.item_id === crystal.id)
    counts[crystal.id] = item ? item.quantity : 0
  }
  return counts
})

// 化仙阵开启材料检查
const canStartFormation = computed(() => {
  if (formation.value.active) return false
  // 检查7种结晶是否各至少有1个
  for (const crystal of crystalConfig) {
    if (crystalCounts.value[crystal.id] < 1) {
      return false
    }
  }
  return true
})
```

2. **修改开启函数，添加材料检查和确认：**
```javascript
const startFormation = async () => {
  if (formation.value.active) {
    alert('化仙阵已在运行中')
    return
  }
  if (!canStartFormation.value) {
    const missing = crystalConfig.filter(c => crystalCounts.value[c.id] < 1)
    const missingNames = missing.map(c => c.name).join('、')
    alert(`材料不足：需要${missingNames}各1个`)
    return
  }
  if (!confirm('确定要开启化仙阵吗？将消耗金之结晶、木之结晶、水之结晶、火之结晶、土之结晶、风之结晶、电之结晶各1个')) {
    return
  }
  // ... 开启逻辑
}
```

3. **在模板中显示材料要求：**
```vue
<!-- 化仙阵开启材料要求 -->
<div v-if="!formation.active" class="section indent" style="font-size: 0.9em; color: #666;">
  开启需要：<template v-for="(crystal, idx) in crystalConfig" :key="crystal.id">
    <span :class="crystalCounts[crystal.id] >= 1 ? 'green' : 'red'">{{ crystal.name }}×1</span><template v-if="idx < crystalConfig.length - 1">、</template>
  </template>
</div>
```

## 功能特点

1. **后端验证：** 确保在开启化仙阵前检查并扣除材料
2. **前端提示：** 实时显示材料要求，用颜色标识是否满足
3. **用户友好：** 材料不足时禁用按钮，点击时提示缺少的材料
4. **二次确认：** 开启前弹出确认对话框，明确告知将消耗的材料
5. **错误处理：** 后端和前端都有完善的错误提示

## 测试建议

### 测试步骤

1. **启动服务**
   - 后端：`python -m interfaces.web_api.app`
   - 前端：`cd interfaces/client && npm run dev`

2. **测试场景1：材料充足**
   - 确保背包中有7种结晶各至少1个
   - 进入化仙页面
   - 查看材料要求显示（应该都是绿色）
   - 点击"开启"按钮
   - 确认弹出确认对话框
   - 确认后，化仙阵应该成功开启
   - 验证背包中7种结晶各减少了1个

3. **测试场景2：材料不足**
   - 确保背包中缺少某些结晶
   - 进入化仙页面
   - 查看材料要求显示（缺少的应该显示红色）
   - "开启"按钮应该被禁用
   - 尝试点击"开启"按钮（如果未禁用）
   - 应该弹出提示，告知缺少哪些材料

4. **测试场景3：化仙阵运行中**
   - 开启化仙阵后
   - 材料要求应该不显示
   - "开启"按钮应该不显示
   - 只显示"收获"按钮

## 修改文件清单

1. `application/services/immortalize_pool_service.py` - 后端服务层
2. `interfaces/client/src/features/huaxian/HuaXianPage.vue` - 前端页面

## 注意事项

- 结晶ID：1001(金)、1002(木)、1003(水)、1004(火)、1005(土)、1006(风)、1007(电)
- 每次开启化仙阵都需要消耗7种结晶各1个
- 如果化仙阵正在运行中，无法再次开启
- 材料检查在前后端都有实现，确保数据一致性
