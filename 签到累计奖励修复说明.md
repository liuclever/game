# 签到累计奖励功能修复说明

## 问题描述

用户反馈：
1. 签到到达7天、15天、30天后无法获得对应的礼包
2. 领取后获得的道具没有成功放入背包

## 需求说明

**重要**：奖励基于**本月累积签到天数**，而非连续签到天数
- 本月累积签到7天 → 可领取7天礼包
- 本月累积签到15天 → 可领取15天礼包
- 本月累积签到30天 → 可领取30天礼包

签到天数可以不连续，只要本月内累积达到对应天数即可领取。

## 问题原因

后端缺少签到累计奖励的API接口实现。前端调用了以下接口，但后端没有实现：
- `GET /api/signin/reward/{days}` - 获取奖励信息
- `POST /api/signin/reward/{days}/claim` - 领取奖励

## 修复内容

### 1. 后端接口实现 (`interfaces/routes/signin_routes.py`)

#### 新增接口1: 获取奖励信息
```python
@signin_bp.get('/reward/<int:days>')
def get_reward_info(days):
    """获取签到累计奖励信息"""
```

功能：
- 查询本月累积签到天数（从player_signin_records表统计）
- 查询该奖励是否已领取
- 返回是否可以领取

#### 新增接口2: 领取奖励
```python
@signin_bp.post('/reward/<int:days>/claim')
def claim_reward(days):
    """领取签到累计奖励"""
```

功能：
- 验证本月累积签到天数是否满足条件
- 检查是否已领取过
- 发放物品奖励到背包
- 发放铜钱奖励
- 记录已领取状态

### 2. 奖励配置

#### 7天礼包
- 化仙丹 x1
- 金之结晶 x1
- 战灵-土灵 x1
- 骰子包 x2
- 捕捉球 x3
- 迷踪符 x3

#### 15天礼包
- 招财神符 x1
- 灵力水晶 x1
- 战灵-土灵 x2
- 洗髓丹 x1
- 强力捕捉球 x1
- 迷踪符 x3

#### 30天礼包
- 铜钱 x800000
- 神·逆鳞碎片 x15
- 追魂法宝 x2
- 重生丹 x1
- 火灵石(未开) x1
- 灵力水晶 x1
- 洗髓丹 x3
- 骰子包 x2
- 强力捕捉球 x2
- 捕捉球 x6
- 补签卡 x1

### 3. 前端优化 (`interfaces/client/src/features/signin/SigninPage.vue`)

修改了礼包状态显示逻辑：
- 原来：基于连续签到天数判断
- 现在：基于本月累积签到天数判断
  - "已领取"：确实已经领取过
  - "可领取"：本月累积签到天数满足条件但未领取
  - "未满足"：本月累积签到天数不足

### 4. 物品发放逻辑

领取奖励时：
1. 检查背包中是否已有该物品
2. 如果有，增加数量
3. 如果没有，插入新记录
4. 铜钱直接加到玩家账户

### 5. 领取记录

使用 `player.signin_rewards_claimed` 字段记录已领取的奖励：
- 格式：逗号分隔的天数，例如 "7,15,30"
- 防止重复领取

## 测试方法

运行测试脚本：
```bash
python test_signin_reward.py
```

测试场景：
1. 连续签到不足7天 - 无法领取
2. 连续签到满7天 - 可以领取
3. 重复领取 - 应该失败
4. 15天奖励 - 正常领取
5. 30天奖励 - 正常领取

## 注意事项

1. 需要确保数据库中有 `signin_rewards_claimed` 字段
   - 运行 `sql/signin_rewards_column.sql` 添加字段

2. 物品ID映射：
   - 补签卡: 6027
   - 化仙丹: 6015
   - 灵力水晶: 6101
   - 捕捉球: 4002
   - 强力捕捉球: 4003
   - 骰子包: 6010
   - 迷踪符: 6002
   - 等等...

3. 连续签到天数的计算：
   - 由每日签到接口自动维护
   - 存储在 `player.consecutive_signin_days` 字段
   - **注意**：奖励判断使用的是本月累积签到天数，不是连续签到天数

## 部署步骤

1. 确保数据库字段存在：
   ```sql
   ALTER TABLE player ADD COLUMN IF NOT EXISTS signin_rewards_claimed VARCHAR(50) DEFAULT '';
   ```

2. 重启后端服务

3. 重新构建前端（如果需要）

4. 测试功能是否正常

## 相关文件

- `interfaces/routes/signin_routes.py` - 后端路由
- `interfaces/client/src/features/signin/SigninPage.vue` - 签到页面
- `interfaces/client/src/features/signin/SigninRewardPage.vue` - 奖励详情页
- `sql/signin_rewards_column.sql` - 数据库字段
- `test_signin_reward.py` - 测试脚本
