# 副本每日重置功能修复说明

## 问题描述

测试账号发现，林中空地地图中的森林入口副本，昨天挑战到了35层最终层，但今天00:00之后，系统没有让其变到第1层。

所有地图副本应该在每天00:00时自动重置到第1层，但实际上没有执行重置。

## 问题原因

1. **缺少定时任务**：`infrastructure/scheduler.py` 中没有配置副本每日重置的定时任务
2. **依赖被动检查**：现有代码只在玩家访问副本时检查 `last_reset_date` 字段，如果日期变化了才重置 `resets_today` 计数器
3. **重置不完整**：即使检查到日期变化，也只重置了计数器，没有重置副本的层数

## 解决方案

### 1. 新增定时任务函数

在 `infrastructure/scheduler.py` 中新增 `_run_daily_dungeon_reset()` 函数：

```python
def _run_daily_dungeon_reset():
    """每日00:00重置所有副本进度到第1层"""
    logger.info("[Scheduler] 开始执行副本每日重置任务")
    try:
        # 重置所有玩家的所有副本进度到第1层
        result = execute_update("""
            UPDATE player_dungeon_progress
            SET current_floor = 1,
                floor_cleared = TRUE,
                floor_event_type = 'beast',
                resets_today = 0,
                last_reset_date = CURDATE(),
                loot_claimed = TRUE
            WHERE current_floor > 1
        """)
        logger.info(f"[Scheduler] 副本每日重置完成，共重置 {result} 条记录")
    except Exception as e:
        logger.exception(f"[Scheduler] 副本每日重置失败: {e}")
```

### 2. 配置定时任务

在 `start_scheduler()` 函数中添加定时任务配置：

```python
# 每天 00:00 重置副本进度
_scheduler.add_job(
    _run_daily_dungeon_reset,
    trigger="cron",
    hour=0,
    minute=0,
    id="daily_dungeon_reset",
    replace_existing=True,
)
```

### 3. 重置逻辑

定时任务会在每天00:00执行以下操作：

1. **重置层数**：将所有副本的 `current_floor` 重置为 1
2. **重置状态**：将 `floor_cleared` 设置为 TRUE（第1层已通关）
3. **重置事件**：将 `floor_event_type` 设置为 'beast'
4. **重置计数**：将 `resets_today` 重置为 0
5. **更新日期**：将 `last_reset_date` 更新为当前日期
6. **重置战利品**：将 `loot_claimed` 设置为 TRUE

**注意**：只重置 `current_floor > 1` 的记录，避免不必要的数据库更新。

## 数据库表结构

`player_dungeon_progress` 表的相关字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | INT | 玩家ID |
| dungeon_name | VARCHAR | 副本名称 |
| current_floor | INT | 当前层数 |
| total_floors | INT | 总层数（默认35） |
| floor_cleared | TINYINT | 当前层是否已通关 |
| floor_event_type | VARCHAR | 当前层事件类型 |
| resets_today | INT | 今日重置次数 |
| last_reset_date | DATE | 上次重置日期 |
| loot_claimed | TINYINT | 战利品是否已领取 |

## 测试验证

### 1. 运行测试脚本

```bash
python test_dungeon_daily_reset.py
```

测试脚本会：
1. 查看测试账号的副本进度
2. 显示所有玩家的副本进度统计
3. 手动触发副本重置任务（需要确认）
4. 验证重置结果
5. 检查定时任务状态

### 2. 手动测试步骤

1. **查看当前副本进度**：
   ```sql
   SELECT user_id, dungeon_name, current_floor, total_floors, last_reset_date
   FROM player_dungeon_progress
   WHERE user_id = 100006
   ORDER BY dungeon_name;
   ```

2. **手动触发重置**（测试用）：
   ```sql
   UPDATE player_dungeon_progress
   SET current_floor = 1,
       floor_cleared = TRUE,
       floor_event_type = 'beast',
       resets_today = 0,
       last_reset_date = CURDATE(),
       loot_claimed = TRUE
   WHERE current_floor > 1;
   ```

3. **验证重置结果**：
   ```sql
   SELECT user_id, dungeon_name, current_floor, last_reset_date
   FROM player_dungeon_progress
   WHERE user_id = 100006
   ORDER BY dungeon_name;
   ```

4. **检查定时任务**：
   - 重启后端服务
   - 查看日志确认定时任务已启动
   - 等待第二天00:00自动执行

## 部署步骤

### 1. 重启后端服务

```bash
# 停止当前后端服务
# 重新启动
python start-backend.bat
```

### 2. 验证定时任务

查看后端日志，确认以下信息：

```
[Scheduler] 后台调度器已启动，包含副本每日重置、召唤之王定时任务、盟战赛季奖励任务和盟战自动对战任务
```

### 3. 等待自动执行

定时任务会在每天00:00（中国时区）自动执行，日志会显示：

```
[Scheduler] 开始执行副本每日重置任务
[Scheduler] 副本每日重置完成，共重置 X 条记录
```

## 注意事项

1. **时区设置**：定时任务使用中国时区（UTC+8），确保服务器时区正确
2. **数据库连接**：确保定时任务执行时数据库连接正常
3. **日志记录**：定时任务执行情况会记录在后端日志中
4. **手动重置**：玩家仍然可以使用元宝手动重置副本（每日5次上限）
5. **首次部署**：首次部署后，建议手动执行一次重置测试

## 相关文件

1. **infrastructure/scheduler.py** - 定时任务调度器（已修改）
2. **test_dungeon_daily_reset.py** - 测试脚本（新增）
3. **副本每日重置功能修复说明.md** - 本文档（新增）

## 完成状态

✅ 定时任务函数已实现
✅ 定时任务已配置
✅ 测试脚本已创建
✅ 文档已完善

**现在只需要重启后端服务，副本每日重置功能就会在每天00:00自动执行！**

## 常见问题

### Q1: 如何确认定时任务已启动？

**A**: 查看后端启动日志，应该包含：
```
[Scheduler] 后台调度器已启动，包含副本每日重置...
```

### Q2: 如何手动触发重置测试？

**A**: 运行测试脚本：
```bash
python test_dungeon_daily_reset.py
```

### Q3: 重置会影响玩家的其他数据吗？

**A**: 不会。重置只影响 `player_dungeon_progress` 表，不会影响玩家的幻兽、物品、等级等其他数据。

### Q4: 玩家正在挑战副本时触发重置会怎样？

**A**: 定时任务在00:00执行，此时大部分玩家应该不在线。即使玩家在线，重置只是更新数据库记录，不会影响当前的挑战流程。玩家下次进入副本时会看到已重置到第1层。

### Q5: 如何查看定时任务的执行历史？

**A**: 查看后端日志文件，搜索关键词：
```
[Scheduler] 副本每日重置
```

## 测试账号信息

- **账号**: test50_97355
- **密码**: 123456
- **用户ID**: 100006

可以使用此账号测试副本重置功能。
