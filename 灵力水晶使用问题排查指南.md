# 灵力水晶使用问题排查指南

## 问题描述

灵力水晶是战灵系统的重要道具，用于兑换灵力来洗练战灵属性。玩家反馈在背包中点击灵力水晶的"使用"按钮后，没有正确跳转到使用页面。

## 诊断结果

经过全面检查，**所有配置都是正确的**：

### ✓ 1. 道具配置正确
- 道具ID: 6101
- 道具名称: 灵力水晶
- 道具类型: material
- 配置文件: `configs/items.json`

### ✓ 2. 前端路由配置正确
- 路由映射: `6101 → /spirit/crystal-use`
- 配置文件: `interfaces/client/src/utils/itemUseRoutes.js`
- 路由注册: `interfaces/client/src/router/index.js`

### ✓ 3. 前端页面组件完整
- 组件文件: `interfaces/client/src/features/beast/SpiritCrystalUsePage.vue`
- 包含完整的加载、使用、批量操作功能

### ✓ 4. 后端接口完整
- 路由: `POST /api/spirit/consume-crystal`
- 服务方法: `consume_spirit_crystal`
- 兑换比例: 1个灵力水晶 = 10灵力

### ✓ 5. 背包页面集成正确
- 正确导入 `getItemUseRoute` 工具函数
- 正确处理道具使用跳转逻辑

## 可能的原因

既然所有配置都正确，问题可能出在以下几个方面：

### 1. 服务未启动
- **后端服务未运行**: Flask API 服务器没有启动
- **前端服务未运行**: Vue 开发服务器没有启动

### 2. 代码未更新
- **前端未重新编译**: 修改后的代码没有重新编译
- **浏览器缓存**: 浏览器使用了旧版本的 JavaScript 文件

### 3. 测试账号问题
- **等级不足**: 战灵系统需要35级才能使用
- **没有灵力水晶**: 背包中没有灵力水晶道具

### 4. 前端路由问题
- **路由未生效**: Vue Router 配置没有正确加载
- **组件导入失败**: SpiritCrystalUsePage 组件导入失败

## 解决方案

### 方案1: 重启服务（推荐）

1. **停止所有服务**
   ```bash
   # 停止后端服务（如果正在运行）
   # 按 Ctrl+C 停止
   
   # 停止前端服务（如果正在运行）
   # 按 Ctrl+C 停止
   ```

2. **启动后端服务**
   ```bash
   # 在项目根目录
   python start-backend.bat
   # 或
   cd interfaces
   python app.py
   ```

3. **启动前端服务**
   ```bash
   # 在前端目录
   cd interfaces/client
   npm run dev
   ```

4. **清除浏览器缓存**
   - Chrome: Ctrl+Shift+Delete → 清除缓存
   - 或使用无痕模式: Ctrl+Shift+N

5. **测试功能**
   - 登录游戏
   - 打开背包
   - 找到灵力水晶
   - 点击【使用】按钮
   - 应该会跳转到 `/spirit/crystal-use` 页面

### 方案2: 检查控制台错误

1. **打开浏览器开发者工具**
   - 按 F12 或 Ctrl+Shift+I

2. **查看 Console 标签**
   - 检查是否有 JavaScript 错误
   - 检查是否有路由错误
   - 检查是否有组件加载失败

3. **查看 Network 标签**
   - 点击灵力水晶的【使用】按钮
   - 查看是否有 API 请求
   - 查看请求是否成功

4. **常见错误及解决方法**
   ```
   错误: "Cannot find module 'SpiritCrystalUsePage'"
   解决: 检查组件文件是否存在，路径是否正确
   
   错误: "404 Not Found: /spirit/crystal-use"
   解决: 检查路由配置，重启前端服务
   
   错误: "Network Error"
   解决: 检查后端服务是否启动
   
   错误: "战灵系统需要35级才能使用"
   解决: 提升玩家等级到35级
   ```

### 方案3: 手动测试路由

1. **直接访问使用页面**
   ```
   http://localhost:5173/spirit/crystal-use
   ```

2. **如果页面能正常显示**
   - 说明路由配置正确
   - 问题可能在背包页面的跳转逻辑

3. **如果页面显示404**
   - 说明路由没有正确注册
   - 需要检查 `router/index.js` 文件

### 方案4: 验证后端接口

使用测试脚本验证后端功能：

```bash
python test_spirit_crystal.py
```

如果后端服务正常，应该看到：
```
✓ 登录成功
✓ 拥有灵力水晶: X 个
✓ 当前灵力: X
✓ 使用成功!
```

## 完整的使用流程

### 正常流程

1. **玩家打开背包**
   - 路由: `/inventory`
   - 组件: `InventoryPage.vue`

2. **点击灵力水晶的【使用】按钮**
   - 触发: `openUseSelect(item)` 函数
   - 调用: `getItemUseRoute(6101, '灵力水晶')`
   - 返回: `/spirit/crystal-use`

3. **自动跳转到使用页面**
   - 路由: `/spirit/crystal-use`
   - 组件: `SpiritCrystalUsePage.vue`

4. **页面加载数据**
   - 获取背包中的灵力水晶数量
   - 获取当前灵力值

5. **玩家选择使用数量**
   - 可以输入数量
   - 可以快捷选择: 1个、10个、50个、全部

6. **点击【确定使用】按钮**
   - 调用 API: `POST /api/spirit/consume-crystal`
   - 参数: `{ "quantity": X }`

7. **后端处理**
   - 检查等级（需要35级）
   - 检查灵力水晶数量
   - 扣除灵力水晶
   - 增加灵力（1个水晶 = 10灵力）

8. **显示结果**
   - 弹窗提示: "成功使用X个灵力水晶，获得X灵力"
   - 刷新页面数据

### 异常处理

| 异常情况 | 错误提示 | 解决方法 |
|---------|---------|---------|
| 等级不足35级 | "战灵系统需要35级才能使用" | 提升玩家等级 |
| 没有灵力水晶 | "灵力水晶数量不足" | 通过镇妖或战灵塔获取 |
| 数量输入错误 | "请输入有效的使用数量" | 输入正确的数量 |
| 网络错误 | "网络错误，请稍后重试" | 检查服务器连接 |

## 获取灵力水晶的途径

1. **镇妖宝箱**
   - 镇妖炼狱层（61-120层）成功后获得炼狱宝箱
   - 打开宝箱可获得灵力水晶×1

2. **战灵塔**
   - 闯塔过程中有概率掉落灵力水晶

3. **签到奖励**
   - 第7天奖励: 灵力水晶×1
   - 第30天奖励: 灵力水晶×1

4. **老玩家回馈礼包**
   - 包含灵力水晶×1

## 灵力的用途

灵力主要用于**洗练战灵属性**：

### 洗练消耗

根据战灵元素和锁定词条数量，洗练消耗不同：

| 元素 | 0条锁定 | 1条锁定 | 2条锁定 |
|-----|--------|--------|--------|
| 土灵 | 1灵力  | 3灵力  | 9灵力  |
| 火灵 | 2灵力  | 6灵力  | 18灵力 |
| 水灵 | 3灵力  | 9灵力  | 27灵力 |
| 木灵 | 4灵力  | 12灵力 | 36灵力 |
| 金灵 | 5灵力  | 15灵力 | 45灵力 |
| 神灵 | 10灵力 | 30灵力 | 90灵力 |

### 洗练流程

1. 进入战灵详情页
2. 点击【洗练】按钮
3. 选择要锁定的属性条（消耗战灵钥匙）
4. 点击【确定洗练】
5. 消耗灵力，重新随机属性值

## 测试建议

### 测试步骤

1. **准备测试账号**
   ```bash
   python create_test_accounts.py
   ```

2. **给测试账号添加灵力水晶**
   ```bash
   python scripts/setup_spirit_test_data.py --user_id 20052 --crystal_qty 10
   ```

3. **启动服务**
   ```bash
   # 后端
   python start-backend.bat
   
   # 前端
   cd interfaces/client
   npm run dev
   ```

4. **登录测试账号**
   - 用户名: 789
   - 密码: 123456

5. **测试使用流程**
   - 打开背包
   - 找到灵力水晶
   - 点击【使用】
   - 验证跳转到使用页面
   - 选择数量
   - 点击【确定使用】
   - 验证灵力增加

### 测试检查点

- [ ] 背包中能看到灵力水晶
- [ ] 点击【使用】按钮能跳转
- [ ] 使用页面能正确显示数量
- [ ] 使用页面能正确显示当前灵力
- [ ] 能选择使用数量
- [ ] 点击【确定使用】能成功
- [ ] 灵力正确增加（1个水晶 = 10灵力）
- [ ] 灵力水晶数量正确减少
- [ ] 能批量使用
- [ ] 等级不足时有正确提示

## 相关文件清单

### 前端文件
- `interfaces/client/src/utils/itemUseRoutes.js` - 道具使用路由配置
- `interfaces/client/src/router/index.js` - 路由注册
- `interfaces/client/src/features/beast/SpiritCrystalUsePage.vue` - 使用页面
- `interfaces/client/src/features/inventory/InventoryPage.vue` - 背包页面

### 后端文件
- `interfaces/routes/spirit_routes.py` - 战灵路由
- `application/services/spirit_service.py` - 战灵服务
- `configs/items.json` - 道具配置
- `configs/zhenyao_rewards.json` - 镇妖奖励配置
- `configs/tower_rewards.json` - 战灵塔奖励配置

### 测试文件
- `test_spirit_crystal.py` - 功能测试脚本
- `diagnose_spirit_crystal.py` - 诊断脚本
- `scripts/setup_spirit_test_data.py` - 测试数据准备脚本

## 总结

灵力水晶功能的所有代码和配置都已经正确实现。如果玩家反馈"打开链接"有问题，最可能的原因是：

1. **服务未启动** - 需要同时启动前端和后端服务
2. **浏览器缓存** - 需要清除缓存或使用无痕模式
3. **等级不足** - 需要35级才能使用战灵系统

建议按照上述"方案1: 重启服务"的步骤操作，应该就能解决问题。
