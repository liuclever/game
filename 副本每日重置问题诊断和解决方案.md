# 副本每日重置问题诊断和解决方案

## 问题描述
所有地图副本挑战，到第二天00:00时，系统应该让所有地图副本都回到第一层，但测试发现系统没有执行重置。

## 问题诊断

### 1. 检查结果
运行 `python simple_check_dungeon.py` 发现：
- 有36条副本进度记录需要重置（current_floor > 1）
- 很多记录的 `last_reset_date` 为 `None` 或很久之前的日期
- 说明定时任务**从未执行过**或**很久没有执行**

### 2. 调度器状态检查
运行 `python check_scheduler_status.py` 发现：
- **调度器未启动**（`_scheduler` 变量为 `None`）
- 这说明后端服务当前没有运行，或者调度器没有被正确启动

### 3. 根本原因
定时任务只有在**后端服务运行时**才会执行。如果：
- 后端服务在00:00时没有运行 → 任务不会执行
- 后端服务在00:00之后启动 → 当天的00:00任务会被跳过（不会补执行）
- 后端服务频繁重启 → 调度器会重新初始化，但不会补执行错过的任务

## 代码实现确认

### 定时任务已正确实现
在 `infrastructure/scheduler.py` 中：

1. **任务函数**（第265-281行）：
```python
def _run_daily_dungeon_reset():
    """每日00:00重置所有副本进度到第1层"""
    logger.info("[Scheduler] 开始执行副本每日重置任务")
    try:
        result = execute_update("""
            UPDATE player_dungeon_progress
            SET current_floor = 1,
                floor_cleared = TRUE,
                floor_event_type = 'beast',
                resets_today = 0,
                last_reset_date = CURDATE(),
                loot_claimed = TRUE
            WHERE current_floor > 1
        """)
        logger.info(f"[Scheduler] 副本每日重置完成，共重置 {result} 条记录")
    except Exception as e:
        logger.exception(f"[Scheduler] 副本每日重置失败: {e}")
```

2. **任务注册**（第488-495行）：
```python
# 每天 00:00 重置副本进度
_scheduler.add_job(
    _run_daily_dungeon_reset,
    trigger="cron",
    hour=0,
    minute=0,
    id="daily_dungeon_reset",
    replace_existing=True,
)
```

3. **调度器启动**（在 `interfaces/web_api/app.py` 第507-508行）：
```python
from infrastructure.scheduler import start_scheduler
start_scheduler()
```

**结论：代码实现完全正确，问题在于后端服务没有持续运行。**

## 解决方案

### 临时解决方案（已执行）
运行 `python manual_reset_dungeons.py` 手动重置所有副本：
- ✅ 已将36条记录重置到第1层
- ✅ 已更新 `last_reset_date` 为今天（2026-01-27）

### 长期解决方案

#### 方案1：保持后端服务24小时运行（推荐）
```bash
# 启动后端服务
python start-backend.bat

# 或者使用 nohup 在后台运行（Linux/Mac）
nohup python interfaces/web_api/app.py &

# Windows 可以使用 start 命令
start /B python interfaces/web_api/app.py
```

**优点**：
- 所有定时任务都能正常执行
- 服务随时可用

**缺点**：
- 需要确保服务器不关机
- 需要监控服务状态

#### 方案2：使用系统服务管理工具
- **Windows**：使用 NSSM (Non-Sucking Service Manager) 将后端注册为 Windows 服务
- **Linux**：使用 systemd 创建服务单元
- **Docker**：使用 Docker Compose 配置 restart: always

#### 方案3：添加启动时补偿机制（代码增强）
在调度器启动时，检查是否有需要重置的副本，如果有则立即执行一次重置：

```python
def start_scheduler():
    """启动后台��度器"""
    global _scheduler
    if _scheduler is not None:
        return
    
    # 启动时检查是否需要补偿执行副本重置
    _check_and_compensate_dungeon_reset()
    
    # ... 原有代码 ...

def _check_and_compensate_dungeon_reset():
    """检查并补偿执行副本重置"""
    from datetime import date
    today = date.today()
    
    # 检查是否有需要重置的副本
    records = execute_query("""
        SELECT COUNT(*) as count 
        FROM player_dungeon_progress 
        WHERE current_floor > 1 
        AND (last_reset_date IS NULL OR last_reset_date < CURDATE())
    """)
    
    count = records[0]['count'] if records else 0
    if count > 0:
        logger.info(f"[Scheduler] 启动时发现 {count} 条副本需要重置，立即执行补偿重置")
        _run_daily_dungeon_reset()
```

## 验证方法

### 1. 检查副本是否已重置
```bash
python simple_check_dungeon.py
```
应该显示：`✅ 所有副本都已在第1层`

### 2. 检查调度器是否运行
```bash
python check_scheduler_status.py
```
应该显示：`✅ 调度器已启动`

### 3. 检查后端服务日志
查看后端服务的控制台输出，应该能看到：
```
[Scheduler] 后台调度器已启动，包含副本每日重置、召唤之王定时任务...
```

在每天00:00时，应该能看到：
```
[Scheduler] 开始执行副本每日重置任务
[Scheduler] 副本每日重置完成，共重置 X 条记录
```

## 测试建议

### 测试定时任务是否正常工作
1. **启动后端服务**：
   ```bash
   python start-backend.bat
   ```

2. **检查调度器状态**：
   ```bash
   python check_scheduler_status.py
   ```
   确认调度器已启动，并且能看到 `daily_dungeon_reset` 任务

3. **等待到00:00**：
   - 保持后端服务运行
   - 在00:00之后运行 `python simple_check_dungeon.py`
   - 确认所有副本都已重置到第1层

4. **如果不想等到00:00**：
   可以临时修改调度器代码，将触发时间改为几分钟后：
   ```python
   # 临时测试：改为当前时间+2分钟
   from datetime import datetime
   now = datetime.now()
   _scheduler.add_job(
       _run_daily_dungeon_reset,
       trigger="cron",
       hour=now.hour,
       minute=now.minute + 2,
       id="daily_dungeon_reset",
       replace_existing=True,
   )
   ```

## 总结

1. **问题原因**：后端服务没有在00:00时运行，导致定时任务无法执行
2. **代码状态**：定时任务代码实现完全正确，已经添加到调度器中
3. **临时修复**：已手动重置所有副本到第1层
4. **长期方案**：需要保持后端服务24小时运行，或添加启动时补偿机制

## 相关文件
- `infrastructure/scheduler.py` - 调度器实现
- `interfaces/web_api/app.py` - 调度器启动位置
- `simple_check_dungeon.py` - 检查副本状态
- `check_scheduler_status.py` - 检查调度器状态
- `manual_reset_dungeons.py` - 手动重置副本

## 完成时间
2026年1月27日
